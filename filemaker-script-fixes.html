<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>FileMaker Script Fixes</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #f5f5f5; }
    .container { background: white; padding: 20px; border-radius: 8px; max-width: 1200px; margin: 0 auto; }
    h2 { color: #d32f2f; }
    .issue { background: #ffebee; border-left: 4px solid #d32f2f; padding: 15px; margin: 20px 0; }
    .fix { background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; margin: 20px 0; }
    .code { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    .red { color: #d32f2f; font-weight: bold; }
    .green { color: #4caf50; font-weight: bold; }
    .warning { background: #fff3e0; border-left: 4px solid #ff9800; padding: 15px; margin: 20px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>FileMaker Script Issues Found</h1>

    <div class="warning">
      <h2>⚠️ CRITICAL SECURITY ISSUE!</h2>
      <p>You've exposed your OpenAI API key in the script you pasted! For security:</p>
      <ol>
        <li>Go to <strong>https://platform.openai.com/api-keys</strong></li>
        <li><strong>Revoke</strong> the key starting with: <code>sk-proj-I_rQPL6...</code></li>
        <li>Create a <strong>new API key</strong></li>
        <li>Replace it in your FileMaker script</li>
        <li><strong>Never share API keys publicly!</strong></li>
      </ol>
    </div>

    <h2>Issue #1: Insert from URL Target Variable</h2>

    <div class="issue">
      <h3>❌ Current (WRONG):</h3>
      <div class="code">
        Insert from URL [ ... ; Target: <span class="red">$aiResponse</span> ]

        <span class="red">&lt;Field&gt;$aiResponse&lt;/Field&gt;</span>
      </div>
      <p>Problem: Using a local variable ($aiResponse) but XML shows it's set as a Field, not a variable target.</p>
    </div>

    <div class="fix">
      <h3>✅ Should be (CORRECT):</h3>
      <div class="code">
        Insert from URL [ ... ; Target: <span class="green">$$aiResponse</span> ]

        <span class="green">&lt;Variable&gt;$$aiResponse&lt;/Variable&gt;</span>
      </div>
      <p>Fix: Use global variable ($$) and make sure it's set as a Variable target, not a Field.</p>
    </div>

    <h3>How to Fix in FileMaker:</h3>
    <ol>
      <li>Double-click the <strong>Insert from URL</strong> step</li>
      <li>For "Target", click <strong>Specify</strong></li>
      <li>In the dropdown, select <strong>"Set Variable"</strong> (NOT "Select field")</li>
      <li>Variable name: <strong>$$aiResponse</strong> (two dollar signs for global)</li>
      <li>Click OK</li>
    </ol>

    <hr style="margin: 40px 0;">

    <h2>Issue #2: Exit Script Missing Text Result</h2>

    <div class="issue">
      <h3>❌ Current (WRONG):</h3>
      <div class="code">
        <span class="red">&lt;Step enable="True" id="103" name="Exit Script"/&gt;</span>
      </div>
      <p>Problem: Exit Script has no result being returned to the caller.</p>
    </div>

    <div class="fix">
      <h3>✅ Should be (CORRECT):</h3>
      <div class="code">
        Exit Script [ Text Result: <span class="green">$result</span> ]

        <span class="green">&lt;Step enable="True" id="103" name="Exit Script"&gt;
  &lt;Result&gt;
    &lt;Calculation&gt;&lt;![CDATA[$result]]&gt;&lt;/Calculation&gt;
  &lt;/Result&gt;
&lt;/Step&gt;</span>
      </div>
    </div>

    <h3>How to Fix in FileMaker:</h3>
    <ol>
      <li>Double-click the <strong>Exit Script</strong> step</li>
      <li>Check the box: <strong>"Specify script result"</strong></li>
      <li>Click <strong>Specify</strong></li>
      <li>Enter: <strong>$result</strong></li>
      <li>Click OK</li>
    </ol>

    <hr style="margin: 40px 0;">

    <h2>Issue #3: Parsing Step References Wrong Variable</h2>

    <div class="issue">
      <h3>❌ Current:</h3>
      <div class="code">
        Set Variable [ $aiContent ; Value:
          JSONGetElement ( <span class="red">$aiResponse</span> ; "choices[0].message.content" )
        ]
      </div>
      <p>Problem: References local $aiResponse, but Insert from URL should set $$aiResponse (global).</p>
    </div>

    <div class="fix">
      <h3>✅ Should be (after fixing Insert from URL):</h3>
      <div class="code">
        Set Variable [ $aiContent ; Value:
          JSONGetElement ( <span class="green">$$aiResponse</span> ; "choices[0].message.content" )
        ]
      </div>
      <p>OR keep using $aiResponse if you fix Insert from URL to target $aiResponse as a variable (not field).</p>
    </div>

    <h3>Recommended Approach:</h3>
    <p>Use <strong>$$aiResponse</strong> (global) so you can inspect it in Data Viewer after the script runs.</p>

    <hr style="margin: 40px 0;">

    <h2>Summary of Changes Needed:</h2>

    <div class="fix">
      <ol>
        <li><strong>Revoke and replace your OpenAI API key</strong> (security!)</li>
        <li><strong>Fix Insert from URL</strong>:
          <ul>
            <li>Target: Set Variable → <code>$$aiResponse</code></li>
          </ul>
        </li>
        <li><strong>Fix Set Variable for $aiContent</strong>:
          <ul>
            <li>Change <code>$aiResponse</code> to <code>$$aiResponse</code></li>
          </ul>
        </li>
        <li><strong>Fix Exit Script</strong>:
          <ul>
            <li>Add script result: <code>$result</code></li>
          </ul>
        </li>
      </ol>
    </div>

    <h2>After Making These Changes:</h2>
    <p>Run the test again and check Data Viewer for:</p>
    <ul>
      <li><strong>$$aiResponse</strong> - OpenAI's raw JSON response</li>
      <li><strong>$aiContent</strong> - Extracted criteria JSON</li>
      <li><strong>$result</strong> - Final formatted result with success/criteria/query</li>
    </ul>

  </div>
</body>
</html>
