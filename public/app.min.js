const albumsEl=document.getElementById("albums"),loadingIndicator=document.getElementById("loadingIndicator"),searchEl=document.getElementById("search"),clearEl=document.getElementById("clear"),goEl=document.getElementById("go"),headerEl=document.querySelector("header"),pagerEl=document.getElementById("pager"),prevEl=document.getElementById("prev"),nextEl=document.getElementById("next"),pageInfo=document.getElementById("pageInfo"),shuffleBtn=document.getElementById("shuffleBtn"),countEl=document.getElementById("count"),errorEl=document.getElementById("error"),player=document.getElementById("player"),landingEl=null,exploreEl=document.getElementById("explore"),explorePanel=document.getElementById("explorePanel"),exploreDecadesEl=document.getElementById("exploreDecades"),exploreGenresEl=document.getElementById("exploreGenres"),exploreMoodsEl=document.getElementById("exploreMoods"),publicFeaturedRow=null,overlay=document.getElementById("overlay"),modalCover=document.getElementById("modalCover"),modalTitle=document.getElementById("modalTitle"),modalArtist=document.getElementById("modalArtist"),modalCat=document.getElementById("modalCat"),modalContent=document.getElementById("modalContent"),modalClose=document.getElementById("modalClose"),trackInfoOverlay=document.getElementById("trackInfoOverlay"),trackInfoDialog=document.getElementById("trackInfoDialog"),trackInfoBody=document.getElementById("trackInfoBody"),trackInfoClose=document.getElementById("trackInfoClose"),playlistColumn=document.getElementById("playlistColumn"),publicPlaylistsPanel=document.getElementById("publicPlaylistsPanel"),publicPlaylistsList=document.getElementById("publicPlaylistsList"),publicPlaylistsEmpty=document.getElementById("publicPlaylistsEmpty"),playlistsPanel=document.getElementById("playlistsPanel"),playlistsList=document.getElementById("playlistsList"),playlistsStatus=document.getElementById("playlistsStatus"),playlistsEmpty=document.getElementById("playlistsEmpty"),playlistCreateForm=document.getElementById("playlistCreateForm"),playlistNameInput=document.getElementById("playlistNameInput"),nowPlayingCard=document.getElementById("nowPlayingCard"),nowPlayingThumb=document.getElementById("nowPlayingThumb"),nowPlayingTitle=document.getElementById("nowPlayingTitle"),nowPlayingSubtitle=document.getElementById("nowPlayingSubtitle"),nowPlayingSource=document.getElementById("nowPlayingSource"),nowPlayingStatus=document.getElementById("nowPlayingStatus"),nowPlayingMetaButtons=document.getElementById("nowPlayingMetaButtons"),nowPlayingToggleButton=document.getElementById("nowPlayingToggle"),nowPlayingCollapseButton=document.getElementById("nowPlayingCollapse"),nowPlayingProgressFill=document.getElementById("nowPlayingProgressFill"),playlistTracksSection=document.getElementById("playlistTracksSection"),playlistTracksTitle=document.getElementById("playlistTracksTitle"),playlistTracksMeta=document.getElementById("playlistTracksMeta"),playlistTracksList=document.getElementById("playlistTracksList"),playlistTracksEmpty=document.getElementById("playlistTracksEmpty"),togglePlaylistTracksButton=document.getElementById("togglePlaylistTracks"),sharePlaylistButton=document.getElementById("sharePlaylistButton"),shareLinkOutput=document.getElementById("shareLinkOutput"),deletePlaylistButton=document.getElementById("deletePlaylistButton"),publicPlaylistView=document.getElementById("publicPlaylistView"),publicPlaylistTitle=document.getElementById("publicPlaylistTitle"),publicPlaylistMeta=document.getElementById("publicPlaylistMeta"),publicPlaylistStatus=document.getElementById("publicPlaylistStatus"),publicPlaylistHero=document.getElementById("publicPlaylistHero"),publicPlaylistArt=document.getElementById("publicPlaylistArt"),publicPlaylistTracks=document.getElementById("publicPlaylistTracks"),publicPlaylistEmpty=document.getElementById("publicPlaylistEmpty"),sharedPlaylistView=document.getElementById("sharedPlaylistView"),sharedPlaylistTitle=document.getElementById("sharedPlaylistTitle"),sharedPlaylistMeta=document.getElementById("sharedPlaylistMeta"),sharedPlaylistStatus=document.getElementById("sharedPlaylistStatus"),sharedPlaylistHero=document.getElementById("sharedPlaylistHero"),sharedPlaylistArt=document.getElementById("sharedPlaylistArt"),sharedPlaylistTracks=document.getElementById("sharedPlaylistTracks"),sharedPlaylistEmpty=document.getElementById("sharedPlaylistEmpty"),sharedPlaylistBackButton=document.getElementById("sharedPlaylistBack"),sharedPlaylistCopyButton=document.getElementById("sharedPlaylistCopy"),authControls=document.getElementById("authControls"),loginTrigger=document.getElementById("loginTrigger"),signupTrigger=document.getElementById("signupTrigger"),logoutButton=document.getElementById("logoutButton"),userBadge=document.getElementById("userBadge"),authOverlay=document.getElementById("authOverlay"),authDialog=document.getElementById("authDialog"),authClose=document.getElementById("authClose"),authForm=document.getElementById("authForm"),authTitle=document.getElementById("authTitle"),authEmail=document.getElementById("authEmail"),authPassword=document.getElementById("authPassword"),authSubmit=document.getElementById("authSubmit"),authSwitch=document.getElementById("authSwitchMode"),authToggleText=document.getElementById("authToggleText"),authError=document.getElementById("authError"),shareModal=document.getElementById("shareModal"),shareLinkInput=document.getElementById("shareLinkInput"),shareModalClose=document.getElementById("shareModalClose"),trackInfoFocusableSelector='button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';let trackInfoReturnFocus=null,trackInfoFocusables=[],authReturnFocus=null,authMode="login",authBusy=!1,currentUser=null,playlists=[],playlistsLoaded=!1,playlistsLoading=!1,activePlaylistId=null,playlistTracksCollapsed=!0,nowPlayingInfo={meta:null,isPlaying:!1},nowPlayingCollapsed=!1,publicPlaylistsLoaded=!1,publicPlaylistsLoading=!1,publicPlaylistsError=null,publicPlaylistTracksLoading=!1,publicPlaylistTracksError=null;const publicPlaylistTracksCache=new Map;let activePublicPlaylistTracks=[],publicPlaylistsSummary=[],activePublicPlaylist=null,activePublicPlaylistImage="",sharedPlaylistActive=!1,sharedPlaylistLoading=!1,sharedPlaylistError=null,sharedPlaylistData=null,activeSharedShareId="",sharedPlaylistShareUrl="";const STREAM_EVENTS_ENDPOINT="/api/stream-events",STREAM_SESSION_STORAGE_KEY="mass.session",STREAM_PROGRESS_INTERVAL_MS=3e4,STREAM_DEBUG=Boolean(window.massStreamDebug);let streamSessionId=null;try{streamSessionId=localStorage.getItem("mass.session")}catch{streamSessionId=null}if(!streamSessionId){const t=window.crypto&&"function"==typeof window.crypto.randomUUID?window.crypto.randomUUID():Math.random().toString(36).slice(2);streamSessionId=t;try{localStorage.setItem("mass.session",streamSessionId)}catch{}}let lastStreamReportTs=0,lastStreamReportPos=0,lastProgressSentAt=0,lastProgressAttemptTs=0,seekStartPosition=0;function getCurrentTrackMeta(){return nowPlayingInfo&&nowPlayingInfo.meta||{}}function toSeconds(t){const e="number"==typeof t?t:Number(t);return Number.isFinite(e)?Math.max(0,Math.round(e)):0}async function sendStreamEvent(t,e,a,l,r){if("function"!=typeof fetch)return!1;const n=Date.now(),i=e&&"object"==typeof e?e:getCurrentTrackMeta(),s="number"==typeof a?a:player?.currentTime||0,o="number"==typeof l?l:player?.duration||0,c=toSeconds(s),d=toSeconds(o),u=Number.isFinite(r),y=u?Math.max(0,Math.round(r)):0,p=Math.max(0,c-(Number.isFinite(lastStreamReportPos)?lastStreamReportPos:0)),m=lastStreamReportTs?Math.max(0,Math.round((n-lastStreamReportTs)/1e3)):0,h=u?y:p||m,g={eventType:t,trackRecordId:i.trackRecordId||i.recordId||i.id||"",trackISRC:i.trackISRC||i.isrc||i.ISRC||"",positionSec:c,durationSec:d,deltaSec:h};let b=null;try{const e=await fetch("/api/stream-events",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Session-ID":streamSessionId},body:JSON.stringify(g)});if(!e.ok){let t="";try{const a=e.headers?.get?e.headers.get("Content-Type"):"";a&&a.includes("application/json")?(b=await e.json(),t=b?.error||JSON.stringify(b)):t=await e.text()}catch{}return console.warn("[MASS] stream event rejected",{status:e.status,detail:t,body:g}),!1}if(b=await e.json().catch(()=>null),!b?.ok)return console.warn("[MASS] stream event server reported failure",{response:b,body:g}),!1;STREAM_DEBUG&&console.info("[MASS] stream event sent",{type:t,trackRecordId:g.trackRecordId,positionSec:g.positionSec,deltaSec:g.deltaSec,recordId:b.recordId||null,totalPlayedSec:b.totalPlayedSec||null})}catch(t){return console.warn("[MASS] stream event send failed",t,g),!1}return lastStreamReportTs=n,lastStreamReportPos=c,"PROGRESS"===t&&(lastProgressSentAt=n),!0}const ALBUMS_PER_PAGE=8,FM_FETCH_LIMIT=300,PLAYLIST_ARTWORK_BASE="/img/playlists/",PLAYLIST_ARTWORK_EXTENSIONS=[".webp",".png",".jpg",".jpeg",".avif"];function normalizePlaylistName(t){return(t||"").toString().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[’']/g,"'").trim()}function slugifyPlaylistName(t){return normalizePlaylistName(t).toLowerCase().replace(/&/g," and ").replace(/[^a-z0-9]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")}function buildPlaylistArtworkCandidates(t){const e=normalizePlaylistName(t),a=slugifyPlaylistName(t),l=new Set,r=t=>{const e=(t||"").trim();e&&l.add(e)};if(e){r(e),r(e.replace(/&/g," and "));const t=e.replace(/&/g," and ").replace(/[^A-Za-z0-9]+/g," ").trim();if(t){const e=t.split(/\s+/),a=e.map(t=>t.toLowerCase()),l=e.map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase());r(e.join(" ")),r(e.join("-")),r(e.join("_")),r(a.join(" ")),r(a.join("-")),r(a.join("_")),r(l.join(" ")),r(l.join("-")),r(l.join("_")),r(e.join("")),r(a.join("")),r(l.join(""))}}a&&(r(a),r(a.replace(/-/g,"_")),r(a.replace(/-/g," ")),r(a.replace(/-/g,"")));const n=[];return l.forEach(t=>{PLAYLIST_ARTWORK_EXTENSIONS.forEach(e=>{const a=`/img/playlists/${t}${e}`;n.push(a)})}),n}function resetPlaylistArtwork(t,e){e&&(e.hidden=!0),t&&(t.style.display="none",t.removeAttribute("src"),t.removeAttribute("data-playlist-artwork-key"),t.removeAttribute("data-playlist-artwork-candidate"),t.onload=null,t.onerror=null)}function loadPlaylistArtwork(t,e,a,l={}){if(!t)return;const r=normalizePlaylistName(a),n=[...Array.isArray(l.preferredUrls)?l.preferredUrls.filter(t=>"string"==typeof t&&t.trim()):[],...r?buildPlaylistArtworkCandidates(r):[]],i=l.altText||(a?`${a} artwork`:"Playlist artwork");if(t.alt=i,!n.length)return void resetPlaylistArtwork(t,e);const s=`${r}::${n.join("|")}`;t.dataset.playlistArtworkKey=s,e&&(e.hidden=!0),t.style.display="none";let o=0;const c=()=>{if(t.dataset.playlistArtworkKey!==s)return;if(o>=n.length)return void resetPlaylistArtwork(t,e);const a=n[o++];t.dataset.playlistArtworkCandidate=a,t.onerror=()=>{t.dataset.playlistArtworkKey===s&&c()},t.onload=()=>{if(t.dataset.playlistArtworkKey!==s)return;Number(t.naturalWidth)>1&&Number(t.naturalHeight)>1?(t.style.display="block",e&&(e.hidden=!1)):c()},t.src=a};c()}function applyPlaylistThumbArtwork(t,e,a=""){if(!t)return;const l=normalizePlaylistName(e),r=(e||"").trim().charAt(0)||"♪";t.textContent=r,t.classList.remove("has-art"),t.style.backgroundImage="";const n=[];if("string"==typeof a&&a.trim()&&n.push(a.trim()),l&&n.push(...buildPlaylistArtworkCandidates(l)),!n.length)return;const i=`${l}::${n.join("|")}`;t.dataset.playlistThumbKey=i;let s=0;const o=()=>{if(t.dataset.playlistThumbKey!==i)return;if(s>=n.length)return;const e=n[s++],a=new Image;a.onload=()=>{if(t.dataset.playlistThumbKey!==i)return;Number(a.naturalWidth)>1&&Number(a.naturalHeight)>1?(t.style.backgroundImage=`url(${a.src})`,t.textContent="",t.classList.add("has-art")):o()},a.onerror=()=>{t.dataset.playlistThumbKey===i&&o()},a.src=e};o()}let lastQ="",prevSearch=null,inFlight=null;const statusEl=document.getElementById("status"),statusTextEl=document.getElementById("statusText");let busyCount=0;function showBusy(t="Searching…"){busyCount++,statusTextEl&&(statusTextEl.textContent=t),statusEl&&(statusEl.hidden=!1),goEl&&(goEl.disabled=!0),exploreEl&&(exploreEl.disabled=!0)}function hideBusy(){busyCount=Math.max(0,busyCount-1),0===busyCount&&(statusEl&&(statusEl.hidden=!0),goEl&&(goEl.disabled=!1),exploreEl&&(exploreEl.disabled=!1))}function clearAuthError(){authError&&(authError.hidden=!0,authError.textContent="")}function setAuthError(t){authError&&(t?(authError.hidden=!1,authError.textContent=t):clearAuthError())}function setAuthMode(t){if(authMode="register"===t?"register":"login",authTitle&&(authTitle.textContent="register"===authMode?"Create account":"Log in"),authSubmit){const t="register"===authMode?"Sign up":"Log in";authSubmit.textContent=authBusy?"register"===authMode?"Creating…":"Signing in…":t}authToggleText&&(authToggleText.textContent="register"===authMode?"Already have an account?":"Need an account?"),authSwitch&&(authSwitch.textContent="register"===authMode?"Log in":"Sign up"),authPassword&&authPassword.setAttribute("autocomplete","register"===authMode?"new-password":"current-password")}function setAuthBusy(t){if(authBusy=!!t,authSubmit){authSubmit.disabled=authBusy;const t="register"===authMode?"Sign up":"Log in";authSubmit.textContent=authBusy?"register"===authMode?"Creating…":"Signing in…":t}authSwitch&&(authSwitch.disabled=authBusy),authClose&&(authClose.disabled=authBusy),updateAuthUI()}function updateAuthUI(){const t=currentUser?.email||"";userBadge&&(t?(userBadge.textContent=t,userBadge.hidden=!1):(userBadge.hidden=!0,userBadge.textContent="")),logoutButton&&(logoutButton.hidden=!t,logoutButton.disabled=authBusy),loginTrigger&&(loginTrigger.hidden=!!t,loginTrigger.disabled=authBusy&&!t),signupTrigger&&(signupTrigger.hidden=!!t,signupTrigger.disabled=authBusy&&!t),authControls&&(authControls.hidden=!1);const e=!!currentUser,a=publicPlaylistsSummary.length>0||publicPlaylistsLoading||!!publicPlaylistsError;playlistColumn&&(playlistColumn.hidden=!e),publicPlaylistsPanel&&(publicPlaylistsPanel.hidden=!a),playlistsPanel&&(playlistsPanel.hidden=!e),syncPublicFeaturedVisibility(),renderPlaylistsPanel()}function getMetaFromRow(t){if(!t)return null;const e=t._meta?{...t._meta}:null;if(!e)return null;if(e.playlistId&&!e.playlistName){const t=playlists.find(t=>t&&t.id===e.playlistId);t&&(e.playlistName=t.name||"")}return e.src=t._src||"",e}function updateNowPlayingUI(){if(!nowPlayingCard)return;const t=nowPlayingInfo.meta,e=!!nowPlayingInfo.isPlaying;if(!t)return nowPlayingProgressFill&&(nowPlayingProgressFill.style.width="0%"),nowPlayingMetaButtons&&(nowPlayingMetaButtons.innerHTML=""),nowPlayingCard.hidden=!0,void(nowPlayingToggleButton&&(nowPlayingToggleButton.textContent="▶",nowPlayingToggleButton.setAttribute("aria-label","Play track"),nowPlayingToggleButton.disabled=!0));if(nowPlayingCard.hidden=!e,nowPlayingCard.classList.toggle("collapsed",nowPlayingCollapsed),nowPlayingTitle&&(nowPlayingTitle.textContent=t.trackName||"Track"),nowPlayingSubtitle&&(nowPlayingSubtitle.textContent=t.trackArtist||t.albumArtist||""),nowPlayingSource){const e=[];t.playlistName&&e.push(`Playlist • ${t.playlistName}`),t.albumTitle&&e.push(t.playlistName?`Album • ${t.albumTitle}`:t.albumTitle),t.catalogue&&e.push(`#${t.catalogue}`),nowPlayingSource.textContent=e.join(" • ")}if(nowPlayingMetaButtons){nowPlayingMetaButtons.innerHTML="";const e=document.createElement("button");e.type="button",e.className="btn small info-more",e.setAttribute("aria-label","More track info"),e.innerHTML='<span aria-hidden="true">⋮</span>',e.addEventListener("click",()=>openTrackInfoModal(t,e)),nowPlayingMetaButtons.appendChild(e);const a=collectTrackMetadata(t);if(a.length){const t=document.createElement("div");t.className="now-playing-meta-list",a.forEach(({label:e,value:a})=>{const l=document.createElement("div");l.className="now-playing-meta-line";const r=document.createElement("strong");r.textContent=`${e}:`,l.appendChild(r),l.appendChild(document.createTextNode(` ${a}`)),t.appendChild(l)}),nowPlayingMetaButtons.appendChild(t)}}if(nowPlayingStatus&&(nowPlayingStatus.textContent=e?"Playing":"Paused"),nowPlayingToggleButton&&(nowPlayingToggleButton.textContent=e?"⏸":"▶",nowPlayingToggleButton.setAttribute("aria-label",e?"Pause playback":"Play track"),nowPlayingToggleButton.disabled=!t.src),nowPlayingProgressFill&&(nowPlayingProgressFill.style.width="0%"),nowPlayingCollapseButton&&(nowPlayingCollapseButton.textContent=nowPlayingCollapsed?"Show info":"Hide info"),nowPlayingThumb)if(nowPlayingThumb.innerHTML="",t.picture){const e=String(t.picture||""),a=e.startsWith("/api/container?")||/^https?:/i.test(e)?e:`/api/container?u=${encodeURIComponent(e)}`,l=document.createElement("img");l.src=a,l.alt="Artwork",l.loading="lazy",l.onerror=()=>{nowPlayingThumb.innerHTML="No art"},nowPlayingThumb.appendChild(l)}else nowPlayingThumb.textContent="No art"}function setNowPlayingFromRow(t,e){const a=getMetaFromRow(t);a?(nowPlayingInfo.meta||(nowPlayingCollapsed=!1),nowPlayingInfo.meta=a,nowPlayingInfo.isPlaying=!!e):(nowPlayingInfo.meta=null,nowPlayingInfo.isPlaying=!1),updateNowPlayingUI(),syncPlaylistOnlyCurrent()}function markNowPlayingInactive(){nowPlayingInfo.meta&&(nowPlayingInfo.isPlaying=!1,updateNowPlayingUI(),syncPlaylistOnlyCurrent())}function clearNowPlaying(){nowPlayingInfo.meta=null,nowPlayingInfo.isPlaying=!1,nowPlayingCollapsed=!1,updateNowPlayingUI(),syncPlaylistOnlyCurrent()}function syncPlaylistOnlyCurrent(){if(!playlistTracksSection)return;const t=Boolean(nowPlayingInfo.meta&&nowPlayingInfo.isPlaying&&nowPlayingInfo.meta.playlistId===activePlaylistId);playlistTracksSection.classList.toggle("only-current",t)}function clearPlaylists(){playlists=[],playlistsLoaded=!1,playlistsLoading=!1,activePlaylistId=null,clearNowPlaying(),renderPlaylistsPanel()}async function loadUserPlaylists(){if(!currentUser)return clearPlaylists(),[];if(playlistsLoading)return playlists;playlistsLoading=!0;try{const t=await fetch("/api/playlists",{headers:{Accept:"application/json"}});if(401===t.status)return currentUser=null,clearPlaylists(),updateAuthUI(),[];if(!t.ok)throw new Error("Failed to load playlists");const e=await t.json().catch(()=>({}));return playlists=Array.isArray(e?.playlists)?e.playlists:[],playlistsLoaded=!0,playlists.length?activePlaylistId&&playlists.some(t=>t&&t.id===activePlaylistId)||(activePlaylistId=playlists[0]?.id||null):activePlaylistId=null,renderPlaylistsPanel(),playlists}catch(t){return console.warn("Playlist fetch failed:",t),playlistsLoaded=!1,renderPlaylistsPanel(),[]}finally{playlistsLoading=!1,renderPlaylistsPanel()}}async function ensurePlaylistsLoaded(){return playlistsLoaded?renderPlaylistsPanel():await loadUserPlaylists(),playlists}async function createPlaylistOnServer(t){const e="string"==typeof t?t.trim():"";if(!e)throw new Error("Playlist name required");const a=await fetch("/api/playlists",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({name:e})}),l=await a.json().catch(()=>({}));if(409===a.status&&l?.playlist){playlists=Array.isArray(playlists)?playlists:[];const t=l.playlist;return-1===playlists.findIndex(e=>e&&e.id===t.id)&&playlists.push(t),playlistsLoaded=!0,activePlaylistId=t?.id||activePlaylistId,renderPlaylistsPanel(),t}if(401===a.status)throw currentUser=null,clearPlaylists(),updateAuthUI(),new Error("Please log in to manage playlists");if(!a.ok||!l?.ok)throw new Error(l?.error||"Failed to create playlist");const r=l.playlist;return playlists=Array.isArray(playlists)?playlists.slice():[],playlists.push(r),playlistsLoaded=!0,activePlaylistId=r?.id||activePlaylistId,renderPlaylistsPanel(),r}async function addTrackToPlaylistOnServer(t,e){const a=await fetch(`/api/playlists/${encodeURIComponent(t)}/tracks`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({track:e})}),l=await a.json().catch(()=>({}));if(401===a.status)throw currentUser=null,clearPlaylists(),updateAuthUI(),new Error("Please log in to manage playlists");if(!a.ok||!l?.ok)throw new Error(l?.error||"Failed to add track to playlist");const r=l.playlist,n=l.track,i=playlists.findIndex(t=>t&&t.id===r?.id);return-1!==i?playlists[i]=r:r&&playlists.push(r),playlistsLoaded=!0,activePlaylistId=r?.id||activePlaylistId,renderPlaylistsPanel(),{playlist:r,track:n,duplicate:l.duplicate}}async function addAlbumToPlaylistOnServer(t,e){const a=await fetch(`/api/playlists/${encodeURIComponent(t)}/tracks/bulk`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({tracks:e})}),l=await a.json().catch(()=>({}));if(401===a.status)throw currentUser=null,clearPlaylists(),updateAuthUI(),new Error("Please log in to manage playlists");if(!a.ok||!l?.ok)throw new Error(l?.error||"Failed to add album to playlist");const r=l.playlist,n=playlists.findIndex(t=>t&&t.id===r?.id);return-1!==n?playlists[n]=r:r&&playlists.push(r),playlistsLoaded=!0,activePlaylistId=r?.id||activePlaylistId,renderPlaylistsPanel(),l}function getActivePlaylist(){return activePlaylistId&&playlists.find(t=>t&&t.id===activePlaylistId)||null}function setActivePlaylist(t){activePlaylistId=t&&playlists.some(e=>e&&e.id===t)?t:null,renderPlaylistsPanel()}function renderPlaylistsPanel(){if(!playlistsPanel)return;const t=Boolean(currentUser),e=Array.isArray(playlists)?playlists.filter(Boolean):[];if(playlistColumn&&(playlistColumn.hidden=!t),!t)return playlistsPanel.hidden=!0,void renderPlaylistTracks();playlistsPanel.hidden=!1,playlistsStatus&&(playlistsStatus.textContent=playlistsLoading?"Loading…":e.length?`${e.length} playlist${1===e.length?"":"s"}`:"No playlists yet"),playlistsList&&(playlistsList.innerHTML="",e.forEach(t=>{const e=document.createElement("button");e.type="button",e.className="playlist-pill",t.id===activePlaylistId&&e.classList.add("active"),e.dataset.playlistId=t.id||"";const a=Array.isArray(t.tracks)?t.tracks.length:0,l=a?`${a} track${1===a?"":"s"}`:"Empty",r=t.name?`${t.name} • ${l}`:l;e.textContent=r,e.addEventListener("click",()=>{t.id===activePlaylistId?setActivePlaylist(null):setActivePlaylist(t.id)}),playlistsList.appendChild(e)})),playlistsEmpty&&(playlistsEmpty.hidden=e.length>0||playlistsLoading),playlistCreateForm&&(playlistCreateForm.hidden=!1),renderPlaylistTracks(),updateNowPlayingUI()}function renderPlaylistTracks(){if(!playlistTracksSection)return;const t=Boolean(currentUser),e=getActivePlaylist();if(!t)return playlistTracksSection.hidden=!0,deletePlaylistButton&&(deletePlaylistButton.hidden=!0),togglePlaylistTracksButton&&(togglePlaylistTracksButton.hidden=!0),sharePlaylistButton&&(sharePlaylistButton.hidden=!0),void(shareLinkOutput&&updateShareLinkDisplay(null));if(!e)return playlistTracksTitle&&(playlistTracksTitle.textContent="Playlist"),playlistTracksMeta&&(playlistTracksMeta.textContent=""),playlistTracksList&&(playlistTracksList.innerHTML=""),playlistTracksEmpty&&(playlistTracksEmpty.hidden=!0),deletePlaylistButton&&(deletePlaylistButton.hidden=!0),togglePlaylistTracksButton&&(togglePlaylistTracksButton.hidden=!0),sharePlaylistButton&&(sharePlaylistButton.hidden=!0),shareLinkOutput&&updateShareLinkDisplay(null),void(playlistTracksSection.hidden=!0);playlistTracksSection.hidden=!1,playlistTracksSection.classList.toggle("collapsed",playlistTracksCollapsed);const a=Array.isArray(e.tracks)?e.tracks:[],l=a.length;if(playlistTracksTitle&&(playlistTracksTitle.textContent=e.name||"Playlist"),playlistTracksMeta){let t=l?`${l} track${1===l?"":"s"}`:"No tracks yet";playlistTracksCollapsed&&l&&(t+=" • hidden"),playlistTracksMeta.textContent=t,playlistTracksMeta.hidden=!1}if(deletePlaylistButton&&(deletePlaylistButton.hidden=!1,deletePlaylistButton.disabled=playlistsLoading),sharePlaylistButton){sharePlaylistButton.hidden=!1;const t=l>0;sharePlaylistButton.disabled=playlistsLoading||!t,sharePlaylistButton.title=t?"":"Add at least one track before sharing a playlist"}if(updateShareLinkDisplay(e),togglePlaylistTracksButton){const t=0===l;togglePlaylistTracksButton.hidden=t,t||(togglePlaylistTracksButton.textContent=playlistTracksCollapsed?"Show tracks":"Hide tracks")}if(playlistTracksList){const t=currentRow&&currentRow._playlist?{playlistId:currentRow._playlist,src:currentRow._src,playing:!player.paused&&currentSrc===currentRow._src}:null;let l=!1;playlistTracksList.innerHTML="",a.forEach((a,r)=>{const n=document.createElement("li");n.className="track playlist-track";const i=document.createElement("button");i.type="button",i.className="btn track-play";const s=a?.resolvedSrc||a?.mp3||"",o="string"==typeof a?.audioField?a.audioField.trim():"",c="string"==typeof a?.artworkField?a.artworkField.trim():"",d=resolvePlayableSrc(s||a?.mp3||""),u=canValidateAudioSrc(d)?d:"";n._src=u,n._btn=i,n._card=null,n._playlist=e.id,n._audioField=o,n._valid=null,n._validated=!1,n._validating=!1,a?.id?n.dataset.trackId=a.id:a?.trackRecordId&&(n.dataset.trackId=a.trackRecordId);const y=a?.name||"Untitled track",p=(a?.trackArtist||a?.albumArtist||"").trim();i.dataset.playLabel="▶",i.dataset.pauseLabel="⏸";const m=p?`${p} — ${y}`:y;i.dataset.playAria=`Play ${m}`,i.dataset.pauseAria=`Pause ${m}`,u?(i.textContent=i.dataset.playLabel,i.disabled=!1,i.classList.remove("btn-error"),i.setAttribute("aria-label",i.dataset.playAria)):(i.textContent="No audio",i.disabled=!0,i.classList.add("btn-error"),i.setAttribute("aria-label",`Audio unavailable for ${m}`)),i.addEventListener("click",async()=>{if(n._src){if(!1===n._valid)return i.textContent="Unavailable",i.disabled=!0,i.classList.add("btn-error"),void i.setAttribute("aria-label",`Audio unavailable for ${m}`);if(n._playlist&&a?.trackRecordId){const t=i.textContent;i.disabled=!0,i.textContent="Refreshing…",i.setAttribute("aria-label",`Refreshing audio for ${m}`);const e=String(n._src||"").trim();e&&audioProbeCache.delete(e);const l=await refreshTrackContainerSource(n,{recordId:a.trackRecordId,audioField:o,candidates:AUDIO_FIELD_CANDIDATES,forceRefresh:!0});if(i.disabled=!1,i.textContent=t,i.dataset.playAria&&(i.textContent===i.dataset.playLabel?i.setAttribute("aria-label",i.dataset.playAria):i.dataset.pauseAria&&i.textContent===i.dataset.pauseLabel&&i.setAttribute("aria-label",i.dataset.pauseAria)),l?.notFound)return n._src="",n._meta.src="",n._valid=!1,i.textContent="Unavailable",i.disabled=!0,i.classList.add("btn-error"),void i.setAttribute("aria-label",`Audio unavailable for ${m}`);if(l&&l.src){const t=l.src;n._src=t,n._meta.src=t,l.audioField&&(n._audioField=l.audioField,n._meta.audioField=l.audioField),a&&(a.resolvedSrc=l.src,a.mp3=l.rawUrl,l.audioField&&(a.audioField=l.audioField))}}handlePlay(i,n,n._src),!0===n._valid||n._validating||(n._validating=!0,validateAudio(n,n._src,{optimistic:!0}).finally(()=>{n._validating=!1}))}else window.alert("This track has no playable audio source.")});const h=document.createElement("span");if(h.className="track-name",p){const t=document.createElement("span");t.className="track-name-artist",t.textContent=p,h.appendChild(t);const e=document.createElement("span");e.className="track-name-title",e.textContent=y,h.appendChild(e)}else{const t=document.createElement("span");t.className="track-name-title",t.textContent=y,h.appendChild(t)}const g=[p,a?.albumTitle,a?.albumArtist].filter(t=>"string"==typeof t&&t.trim());if(g.length){const t=g.join(" • ");h.title=t,n.title=t}n.appendChild(i),n.appendChild(h);const b={...a};b.trackName=y,b.trackArtist=a?.trackArtist||a?.albumArtist||"",b.albumTitle=a?.albumTitle||"",b.albumArtist=a?.albumArtist||"",b.playlistId=e.id,b.playlistName=e.name||"",b.picture=a?.artwork||"",b.source="playlist",b.catalogue=a?.catalogue||"",b.playlistTrackId=a?.id||"",b.trackRecordId=a?.trackRecordId||"",b.audioField=o,b.pictureField=c,b.src=u,b.producer=a?.producer||"",b.composer1=a?.composer1||"",b.composer2=a?.composer2||"",b.composer3=a?.composer3||"",b.composer4=a?.composer4||"",b.composers=a?.composers||[],n._meta=b,playlistTracksList.appendChild(n),u&&t&&t.playlistId===e.id&&t.src===u&&(l=!0,currentRow=n,currentBtn=i,n._playlist=e.id,t.playing?(n.classList.add("playing"),i.textContent=i.dataset.pauseLabel||"⏸ Pause",i.classList.add("btn-accent"),i.disabled=!1,i.dataset.pauseAria&&i.setAttribute("aria-label",i.dataset.pauseAria)):(i.textContent=i.dataset.playLabel||"▶ Play",i.classList.remove("btn-accent"),i.dataset.playAria&&i.setAttribute("aria-label",i.dataset.playAria)),setNowPlayingFromRow(n,t.playing))}),t&&(t.playlistId===e.id?l?updateProgressUI():(t.playing&&!player.paused&&currentSrc===t.src&&player.pause(),currentSrc="",updateButtonsForStop()):t.playing&&!player.paused&&currentSrc===t.src&&(player.pause(),currentSrc="",updateButtonsForStop())),playlistTracksList.hidden=playlistTracksCollapsed}playlistTracksEmpty&&(playlistTracksEmpty.hidden=playlistTracksCollapsed||l>0,playlistTracksEmpty.textContent="No tracks in this playlist yet."),syncPlaylistOnlyCurrent()}async function deletePlaylistOnServer(t){const e=await fetch(`/api/playlists/${encodeURIComponent(t)}`,{method:"DELETE",headers:{Accept:"application/json"}});let a={};try{a=await e.json()}catch{}if(401===e.status)throw currentUser=null,clearPlaylists(),updateAuthUI(),new Error("Please log in to manage playlists");if(404===e.status)return null;if(!e.ok)throw new Error(a?.error||"Failed to delete playlist");return a?.playlist||null}async function deleteActivePlaylist(){const t=getActivePlaylist();if(!t)return;const e=t.name||"playlist";if(window.confirm(`Delete ${e}? This cannot be undone.`)){deletePlaylistButton&&(deletePlaylistButton.disabled=!0);try{await deletePlaylistOnServer(t.id)}catch(t){return window.alert(t?.message||"Unable to delete playlist"),void(deletePlaylistButton&&(deletePlaylistButton.disabled=!1))}if(playlists=Array.isArray(playlists)?playlists.filter(e=>e&&e.id!==t.id):[],playlistsLoaded=!0,activePlaylistId=playlists.length&&playlists[0]?.id||null,nowPlayingInfo.meta&&nowPlayingInfo.meta.playlistId===t.id){try{player.pause()}catch{}updateButtonsForStop(),currentSrc="",clearNowPlaying()}renderPlaylistsPanel(),deletePlaylistButton&&(deletePlaylistButton.disabled=!1),window.alert("Playlist deleted.")}}function buildShareUrlFallback(t){const e="string"==typeof t?t.trim():"";if(!e)return"";try{const t=new URL(window.location.href);return`${`${t.origin}${t.pathname}`}?share=${encodeURIComponent(e)}`}catch{const t=window.location&&window.location.origin||"",a=window.location&&window.location.pathname||"/";return`${t?`${t}${a}`:a}?share=${encodeURIComponent(e)}`}}async function copyTextToClipboard(t){if(!t)return!1;try{if(navigator.clipboard&&"function"==typeof navigator.clipboard.writeText)return await navigator.clipboard.writeText(t),!0}catch(t){console.warn("[MASS] Clipboard write failed",t)}try{const e=document.createElement("textarea");return e.value=t,e.setAttribute("readonly",""),e.style.position="absolute",e.style.opacity="0",e.style.pointerEvents="none",document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),!0}catch(t){console.warn("[MASS] Fallback clipboard copy failed",t)}return window.prompt("Copy this link:",t),!1}function getExistingShareUrl(t){if(!t||"object"!=typeof t)return"";const e="string"==typeof t.shareId?t.shareId.trim():"";return e?buildShareUrlFallback(e):""}function updateShareLinkDisplay(t,e){if(!shareLinkOutput)return;const a=e||getExistingShareUrl(t);a?(shareLinkOutput.hidden=!1,shareLinkOutput.textContent=`Share link: ${a}`,shareLinkOutput.dataset.url=a):(shareLinkOutput.hidden=!0,shareLinkOutput.textContent="",shareLinkOutput.removeAttribute("data-url"))}async function copyActivePlaylistShareLink(){const t=getActivePlaylist();if(t)if(Array.isArray(t.tracks)&&0!==t.tracks.length){sharePlaylistButton&&(sharePlaylistButton.disabled=!0);try{const e=await fetch(`/api/playlists/${encodeURIComponent(t.id)}/share`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({})}),a=await e.json().catch(()=>({}));if(401===e.status)throw currentUser=null,clearPlaylists(),updateAuthUI(),new Error("Please log in to manage playlists");if(400===e.status)throw new Error(a?.error||"Add at least one track before sharing");if(!e.ok||!a?.ok){const t="string"==typeof a?.detail&&a.detail.trim()?a.detail.trim():"",e="string"==typeof a?.error&&a.error.trim()?a.error.trim():"Unable to generate share link";throw new Error(t||e)}const l="string"==typeof a.shareId?a.shareId.trim():"string"==typeof a.playlist?.shareId?a.playlist.shareId.trim():"";if(!l)throw new Error("Server did not return a share link");const r="string"==typeof a.shareUrl&&a.shareUrl.trim()?a.shareUrl.trim():buildShareUrlFallback(l),n="string"==typeof a.playlist?.sharedAt?a.playlist.sharedAt:t.sharedAt||(new Date).toISOString();t.shareId=l,t.sharedAt=n;const i=playlists.findIndex(e=>e&&e.id===t.id);if(-1!==i){const t=playlists[i];playlists[i]={...t,shareId:l,sharedAt:n}}updateShareLinkDisplay(-1!==i?playlists[i]:{...t},r),showShareModal(r)}catch(e){console.error("Copy share link failed",e);const a="string"==typeof t.shareId?t.shareId.trim():"";if(a){const e=buildShareUrlFallback(a);updateShareLinkDisplay(t,e),showShareModal(e)}else window.alert(e?.message||"Unable to generate share link")}finally{sharePlaylistButton&&(sharePlaylistButton.disabled=!1)}}else window.alert("Add tracks before sharing a playlist.")}function buildPlaylistTrackPayload(t,e,a){const l=e?.recordId;return{recordId:"string"==typeof l?l:l?String(l):"",name:e?.name||"",albumTitle:t?.title||"",albumArtist:t?.artist||"",catalogue:t?.catalogue||"",trackArtist:e?.trackArtist||"",seq:Number.isFinite(e?.seq)?Number(e.seq):null,mp3:e?.mp3||"",resolvedSrc:a||"",artwork:t?.picture||"",audioField:e?.mp3Field||e?.audioField||"",artworkField:t?.pictureField||e?.pictureField||""}}async function resolvePlaylistForAdd(){if(!currentUser)return openAuth("login"),null;await ensurePlaylistsLoaded(),playlists=Array.isArray(playlists)?playlists:[];let t=getActivePlaylist();if(t||1!==playlists.length||(t=playlists[0]),!t){let e=window.prompt("Add to playlist\nEnter playlist name (existing names will be reused):");if("string"!=typeof e)return null;if(e=e.trim(),!e)return null;const a=playlists.find(t=>"string"==typeof t?.name&&t.name.toLowerCase()===e.toLowerCase());if(a)t=a;else try{t=await createPlaylistOnServer(e)}catch(t){return window.alert(t?.message||"Unable to create playlist"),null}}if(!t)return null;const e=t?.id||null;return e&&e!==activePlaylistId?setActivePlaylist(e):renderPlaylistsPanel(),t}async function handleAddToPlaylist(t,e,a){const l=await resolvePlaylistForAdd();if(!l)return;const r=buildPlaylistTrackPayload(t,e,a);if(r.name)try{const{duplicate:t}=await addTrackToPlaylistOnServer(l.id,r);t?window.alert("Track already in playlist."):window.alert(`Added to "${l.name}"`)}catch(t){window.alert(t?.message||"Unable to add track")}else window.alert("Track must have a name before it can be added.")}async function handleAddAlbumToPlaylist(t){const e=await resolvePlaylistForAdd();if(!e)return;const a=(Array.isArray(t?.tracks)?t.tracks.filter(t=>t.hasValidAudio):[]).map(e=>{const a=resolvePlayableSrc(e?.mp3||""),l=canValidateAudioSrc(a)?a:"";return buildPlaylistTrackPayload(t,e,l)}).filter(t=>t.name);if(a.length)try{const t=await addAlbumToPlaylistOnServer(e.id,a),l=Number(t?.addedCount)||0,r=Number(t?.duplicateCount)||0,n=Number(t?.skippedCount)||0;let i=l>0?`Added ${l} track${1===l?"":"s"} to "${e.name}".`:`No new tracks added to "${e.name}".`;r>0&&(i+=` ${r} already in playlist.`),n>0&&(i+=` ${n} skipped.`),window.alert(i)}catch(t){window.alert(t?.message||"Unable to add album to playlist")}else window.alert("No tracks on this album could be added.")}function openAuth(t=authMode,e=null){setAuthMode(t),clearAuthError(),authOverlay&&(authOverlay.hidden=!1,authOverlay.classList.add("open")),authReturnFocus=e||document.activeElement,queueTask(()=>{authEmail?.focus(),authEmail?.select?.()})}function closeAuth(){authOverlay&&(authOverlay.hidden=!0,authOverlay.classList.remove("open")),setAuthBusy(!1),clearAuthError(),authForm?.reset(),authReturnFocus&&"function"==typeof authReturnFocus.focus&&authReturnFocus.focus(),authReturnFocus=null,setAuthMode("login")}function showShareModal(t){shareModal&&shareLinkInput&&(shareLinkInput.value=t,shareModal.classList.add("open"),setTimeout(()=>{shareLinkInput.focus(),shareLinkInput.select()},100))}function closeShareModal(){shareModal&&(shareModal.classList.remove("open"),shareLinkInput.value="")}async function refreshCurrentUser(){try{const t=await fetch("/api/auth/me",{headers:{Accept:"application/json"}});if(!t.ok)throw new Error("Session check failed");const e=await t.json().catch(()=>({})),a=e?.user?.email;currentUser=a?{email:a}:null}catch{currentUser=null}currentUser?(await loadUserPlaylists(),loadPublicPlaylistSummaries().catch(t=>console.warn("Failed to load featured playlists:",t))):clearPlaylists(),updateAuthUI()}async function submitAuthForm(t){if(t.preventDefault(),!authEmail||!authPassword)return;const e=authEmail.value.trim(),a=authPassword.value;if(!e)return setAuthError("Email required"),void authEmail.focus();if(a.length<8)return setAuthError("Password must be at least 8 characters"),void authPassword.focus();clearAuthError(),setAuthBusy(!0);try{const t="register"===authMode?"/api/auth/register":"/api/auth/login",l=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({email:e,password:a})}),r=await l.json().catch(()=>({}));if(!l.ok||!r?.ok){return void setAuthError(r?.error||"Unable to complete request")}currentUser=r?.user?.email?{email:r.user.email}:{email:e},updateAuthUI(),await loadUserPlaylists(),closeAuth()}catch(t){setAuthError(t?.message||"Network error")}finally{setAuthBusy(!1)}}async function performLogout(){setAuthBusy(!0);try{await fetch("/api/auth/logout",{method:"POST",headers:{Accept:"application/json"}})}catch{}currentUser=null,setAuthBusy(!1),updateAuthUI(),clearPlaylists()}let rawItems=[],rawTotalFound=0,rawNextOffset=0,albumGroups=[],albumPage=0,currentMode="landing",currentExploreDecade=null,shouldScrollAlbums=!1,isRestoring=!1,showAlbumsWithoutAudio=!0,currentBtn=null,currentRow=null,currentSrc="";const audioProbeCache=new Map,albumAudioState=new Map,AUDIO_PROBE_TTL=6e5,queueTask="function"==typeof queueMicrotask?queueMicrotask:t=>Promise.resolve().then(t),containerCache=new Map,AUDIO_FIELD_CANDIDATES=["mp3","MP3","Audio File","Audio::mp3"],ARTWORK_FIELD_CANDIDATES=["Artwork::Picture","Artwork Picture","Picture"],TRACK_TITLE_CANDIDATES=["Track Name","Song Name","Title","Track Title","Song Title"],PUBLIC_PLAYLIST_FIELD_CANDIDATES=["PublicPlaylist","Public Playlist","Tape Files::PublicPlaylist","Tape Files::Public Playlist","Public_Playlist","Playlist Name","Playlist::Public"];function pickFieldValue(t,e){if(!t)return{value:"",field:""};const a=Object.entries(t),l=t=>"string"==typeof t?t.replace(/[^a-z0-9]/gi,"").toLowerCase():"";for(const t of e){for(const[e,l]of a){if(e!==t)continue;if(null==l)continue;const a="string"==typeof l?l.trim():String(l).trim();if(a)return{value:a,field:e}}const e=l(t);if(e)for(const[r,n]of a){if(r===t)continue;if(null==n)continue;if(l(r)!==e)continue;const a="string"==typeof n?n.trim():String(n).trim();if(a)return{value:a,field:r}}}return{value:"",field:""}}function fCatalogue(t){return t["Album Catalogue Number"]||t["Album Catalog Number"]||t["Album Catalogue No"]||t.Catalogue||""}function fPicture(t){return pickFieldValue(t,ARTWORK_FIELD_CANDIDATES).value}const F_TRACK="Track Name",F_GENRE="Local Genre",TRACK_SEQUENCE_FIELDS=["Track Number","TrackNumber","Track_Number","Track No","Track No.","Track_No","Track #","Track#","Track Sequence","Track Sequence Number","Track Seq","Track Seq No","Track Order","Track Position","TrackPosition","Sequence","Seq","Sequence Number","Sequence_Number","Song Number","Song No","Song Seq","Song Order","Tape Files::Track Number","Tape Files::Track_No"];function composersFrom(t){return[t.Composer,t["Composer 1"]??t.Composer1,t["Composer 2"]??t.Composer2,t["Composer 3"]??t.Composer3,t["Composer 4"]??t.Composer4].filter(Boolean)}function parseTrackSequence(t={}){for(const e of TRACK_SEQUENCE_FIELDS){if(!Object.prototype.hasOwnProperty.call(t,e))continue;const a=t[e];if(null==a)continue;const l=String(a).trim();if(!l)continue;const r=Number(l);if(Number.isFinite(r))return r;const n=Number(l.replace(/[^0-9.-]/g,""));if(Number.isFinite(n))return n}for(const[e,a]of Object.entries(t)){if(null==a)continue;const t=e.toLowerCase();if(!/(track|song)/.test(t))continue;if(!/(no|num|#|seq|order|pos)/.test(t))continue;const l=String(a).trim();if(!l)continue;const r=Number(l);if(Number.isFinite(r))return r;const n=Number(l.replace(/[^0-9.-]/g,""));if(Number.isFinite(n))return n}return Number.POSITIVE_INFINITY}function fTitle(t){return t["Album Title"]||t["Tape Files::Album_Title"]||t.Album_Title||t.Title||""}function fArtist(t){return t["Album Artist"]||t["Tape Files::Album Artist"]||t["Track Artist"]||t.Artist||""}function fMp3(t){return pickFieldValue(t,AUDIO_FIELD_CANDIDATES).value}function fLang(t){return t.Language||t["Language Code"]||""}function hasValidMp3(t){return canValidateAudioSrc(t)}function fmtTime(t){const e=Number(t);if(!Number.isFinite(e)||e<=0)return"0:00";const a=Math.max(0,e),l=Math.floor(a/60),r=Math.floor(a%60);return`${l}:${String(r).padStart(2,"0")}`}function formatDateForDisplay(t){if("string"!=typeof t||!t.trim())return"";try{const e=new Date(t);return Number.isFinite(e.getTime())?e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"}):""}catch{return""}}const AUDIO_VALIDATE_TIMEOUT=12e3,AUDIO_VALIDATE_MAX_RETRIES=2,MAX_AUDIO_PROBES_PER_ALBUM=2,MAX_ALBUMS_TO_PRIME=16,MAX_CONCURRENT_AUDIO_PROBES=6,AUDIO_PRELOAD_LIMIT=4;let activeAudioProbes=0;const audioProbeWaiters=[],audioPreloadCache=new Map,audioPreloadOrder=[];function delay(t){return new Promise(e=>setTimeout(e,t))}function canValidateAudioSrc(t){if("string"!=typeof t)return!1;const e=t.trim();return!!e&&(!!e.startsWith("/")||(!!/^https?:\/\//i.test(e)||!!/^[^:?#]+\.(mp3|m4a|aac|wav|ogg|flac)$/i.test(e)))}function resolvePlayableSrc(t){const e="string"==typeof t?t.trim():"";return e?e.startsWith("/api/container?")?e:/^https?:\/\//i.test(e)?`/api/container?u=${encodeURIComponent(e)}`:e:""}function isFresh(t){return!(!t||"number"!=typeof t.ts)&&Date.now()-t.ts<6e5}async function acquireProbeSlot(){activeAudioProbes>=6&&await new Promise(t=>audioProbeWaiters.push(t)),activeAudioProbes+=1}function releaseProbeSlot(){activeAudioProbes=Math.max(0,activeAudioProbes-1);const t=audioProbeWaiters.shift();t&&t()}function releasePreloadedSrc(t){if(!t)return;const e=audioPreloadCache.get(t);if(e){try{e.src="",e.load()}catch{}audioPreloadCache.delete(t)}const a=audioPreloadOrder.indexOf(t);-1!==a&&audioPreloadOrder.splice(a,1)}function preloadAudioSrc(t){if(t&&!audioPreloadCache.has(t)){try{const e=new Audio;e.preload="auto",e.src=t;try{e.load()}catch{}audioPreloadCache.set(t,e),audioPreloadOrder.push(t)}catch{}for(;audioPreloadOrder.length>4;){releasePreloadedSrc(audioPreloadOrder.shift())}}}function updatePlaylistTrackEntry(t,e){if(!t||!t.playlistId||!t.playlistTrackId)return;const a=playlists.find(e=>e&&e.id===t.playlistId);if(!a||!Array.isArray(a.tracks))return;const l=a.tracks.find(e=>e&&e.id===t.playlistTrackId);l&&(e.resolvedSrc&&(l.resolvedSrc=e.resolvedSrc),e.rawUrl&&(l.mp3=e.rawUrl),e.audioField&&(l.audioField=e.audioField))}async function refreshTrackContainerSource(t,e={}){const a=t?._meta||{},l=e.recordId||a.trackRecordId||a.recordId||"";if(!l)return null;const r=e.audioField||a.audioField||"",n=`${l}::${r||"default"}`,i=Date.now(),s=!e.forceRefresh?containerCache.get(n):null;if(s&&i-s.ts<18e5)return s.notFound?{notFound:!0}:(t&&(t._src=s.resolvedSrc,t._meta&&(t._meta.src=s.resolvedSrc,s.audioField&&(t._meta.audioField=s.audioField),updatePlaylistTrackEntry(t._meta,{rawUrl:s.rawUrl,resolvedSrc:s.resolvedSrc,audioField:s.audioField})),t._lastContainerRefresh=i),{...s});e.forceRefresh&&containerCache.delete(n);const o=new URLSearchParams;r?o.set("field",r):Array.isArray(e.candidates)&&e.candidates.length&&o.set("candidates",e.candidates.join(","));try{const e=o.toString(),a=e?`/api/track/${encodeURIComponent(l)}/container?${e}`:`/api/track/${encodeURIComponent(l)}/container`,s=await fetch(a,{headers:{Accept:"application/json"}}),c=await s.json().catch(()=>({}));if(!s.ok||!c?.url)return null;const d=c.url,u=c?.field||r||"",y=resolvePlayableSrc(d);return t&&(t._src=y,t._meta&&(t._meta.src=y,u&&(t._meta.audioField=u),updatePlaylistTrackEntry(t._meta,{rawUrl:d,resolvedSrc:y,audioField:u})),t._lastContainerRefresh=i),containerCache.set(n,{rawUrl:d,resolvedSrc:y,audioField:u,ts:i}),{src:y,rawUrl:d,audioField:u}}catch(t){return console.warn("[MASS] Failed to refresh container source",t),null}}function findNextPlayableRow(t){if(!t)return null;let e=t.nextElementSibling;for(;e;){if(e._src)return e;e=e.nextElementSibling}return null}function scheduleNextTrackPreload(t){const e=findNextPlayableRow(t);e&&e._src&&!audioPreloadCache.has(e._src)&&preloadAudioSrc(e._src)}async function probeAudioSource(t,e=0){const a=String(t||"").trim();if(!a){return{ok:!1,reason:"Invalid link",ts:Date.now()}}const l=audioProbeCache.get(a);if(l&&isFresh(l))return l;const r=new AbortController,n=setTimeout(()=>r.abort(),12e3);let i,s,o;await acquireProbeSlot();try{i=await fetch(t,{method:"GET",headers:{Range:"bytes=0-4095"},signal:r.signal,cache:"no-store",credentials:"include"})}catch(l){return s={ok:!1,reason:"AbortError"===l?.name?"Timeout":"Unavailable",ts:Date.now()},"Timeout"===s.reason&&e<2?(await delay(600*(e+1)),releaseProbeSlot(),clearTimeout(n),probeAudioSource(t,e+1)):(audioProbeCache.set(a,s),s)}finally{clearTimeout(n),releaseProbeSlot()}try{if(i&&i.ok){const t=(i.headers.get("content-type")||"").toLowerCase(),e=i.headers.get("content-length");if("0"===e)s={ok:!1,reason:"Empty audio",ts:Date.now()};else if(t&&!/(audio|mpeg|mp3|ogg|wav|flac)/i.test(t))s={ok:!1,reason:"Unexpected content",ts:Date.now()};else if(o=await i.arrayBuffer(),o&&0!==o.byteLength){s=looksLikeAudio(new Uint8Array(o),t)?{ok:!0,ts:Date.now(),type:t,length:e?Number(e):void 0}:{ok:!1,reason:"Unexpected content",ts:Date.now()}}else s={ok:!1,reason:"Empty audio",ts:Date.now()}}else i&&401===i.status&&console.warn("[MASS] Audio probe received 401",t),s={ok:!1,reason:`HTTP ${i?i.status:"error"}`,ts:Date.now()}}catch(t){s={ok:!1,reason:"Unavailable",ts:Date.now()}}finally{if(i&&i.body&&"function"==typeof i.body.cancel)try{i.body.cancel()}catch(t){}}return!s.ok&&"Timeout"===s.reason&&e<2?(await delay(600*(e+1)),probeAudioSource(t,e+1)):(audioProbeCache.set(a,s),s)}function looksLikeAudio(t,e){if(!t||!t.length)return!1;const a=t[0],l=t.length>1?t[1]:0,r=t.length>2?t[2]:0,n=t.length>3?t[3]:0,i=String.fromCharCode(a,l,r,n),s=t.length>=8?String.fromCharCode(t[4],t[5],t[6],t[7]):"",o=t=>i.startsWith(t);return!!o("ID3")||(!!o("OggS")||(!!o("fLaC")||(!!o("RIFF")||(!!o("FORM")||(!(!i.startsWith("ftyp")&&"ftyp"!==s)||(!(255!==a||224&~l)||(173===a&&175===l||60!==a&&123!==a&&91!==a&&(!i.toLowerCase().startsWith("http")&&!(!e||!/(audio|mpeg|mp3|ogg|wav|flac|aac)/i.test(e))))))))))}function updateAlbumCardState(t){if(!t)return;const e=t._card;if(!e||!e.isConnected)return;const a=!!t.hasPlayable,l=!!t._pendingValidation;e.dataset.pendingTracks=l?"1":"0",e.dataset.validTracks=a?"1":"0",e.classList.toggle("pending-audio",l),a?(e.dataset.hasAudioCandidates="true",e.classList.remove("no-audio"),"No playable audio available"===e.title&&e.removeAttribute("title")):l||(e.dataset.hasAudioCandidates="false",e.classList.add("no-audio"),e.title||(e.title="No playable audio available")),syncCardAudioState(e)}function ensureAlbumAudioValidation(t){if(!t)return;const e=t.key||makeAlbumKey(t.catalogue,t.title,t.artist);t.key=e;const a=albumAudioState.get(e);if(a){if("pending"===a.status)return;if(("valid"===a.status||"invalid"===a.status)&&isFresh(a))return}const l=runAlbumAudioValidation(t);t._pendingValidation=!0,albumAudioState.set(e,{status:"pending",promise:l}),l.then(a=>{albumAudioState.set(e,{status:a?"valid":"invalid",ts:Date.now()}),t._pendingValidation=!1,t.hasPlayable=!!a,updateAlbumCardState(t)}).catch(a=>{console.warn("[MASS] Album audio validation failed",a),albumAudioState.set(e,{status:"invalid",ts:Date.now(),error:a}),t._pendingValidation=!1,t.hasPlayable=!1,updateAlbumCardState(t)})}function primeAlbumAudioValidation(t,e=16){if(!Array.isArray(t)||!t.length||e<=0)return;let a=0;for(const l of t){if(!l)continue;const t=l.key||makeAlbumKey(l.catalogue,l.title,l.artist);if(l.key=t,ensureAlbumAudioValidation(l),a+=1,a>=e)break}}async function runAlbumAudioValidation(t){const e=Array.isArray(t.tracks)?t.tracks:[];if(!e.length)return!1;const a=[],l=new Set;for(const t of e){const e=resolvePlayableSrc(t&&t.mp3);if(!canValidateAudioSrc(e))return!1;if(!l.has(e)&&(l.add(e),a.push(e),a.length>=2))break}if(!a.length)return!1;return(await Promise.all(a.map(t=>probeAudioSource(t)))).some(t=>t&&t.ok)}async function validateAudio(t,e,a={}){const l=t&&t._btn,r=t&&t._card;if(!l)return;const n=Symbol("audio-validate");t._validationToken=n;const{optimistic:i=!1}=a,s=e=>t._validationToken===n&&(e(),!0),o=t=>{if(!r)return;let e=Number(r.dataset.pendingTracks||"0");if(e>0&&(e-=1),r.dataset.pendingTracks=String(e),t){const t=Number(r.dataset.validTracks||"0")+1;r.dataset.validTracks=String(t)}syncCardAudioState(r)},c=a=>{s(()=>{i&&currentRow===t&&currentSrc===e&&(player.pause(),updateButtonsForStop()),l.disabled=!0,l.textContent=a||"Unavailable",l.classList.add("btn-error"),l.classList.remove("btn-accent"),l.title=a||"Audio unavailable",t._valid=!1,t._validated=!0,releasePreloadedSrc(e)})&&o(!1)},d=()=>{s(()=>{if(currentRow!==t||player.paused){const t=l.dataset?.playLabel||"▶ Play";l.textContent=t,l.dataset?.playAria&&l.setAttribute("aria-label",l.dataset.playAria)}l.disabled=!1,l.classList.remove("btn-error"),l.removeAttribute("title"),t._valid=!0,t._validated=!0})&&o(!0)};if(!canValidateAudioSrc(e))return r&&(r.dataset.hasAudioCandidates="true"),void c("Invalid link");r&&(r.dataset.hasAudioCandidates="true");const u="string"==typeof e?e.trim():"",y=u?audioProbeCache.get(u):null;if(y&&isFresh(y)&&"Timeout"!==y.reason)return void(y.ok?d():c(y.reason||"Unavailable"));if(!s(()=>{if(i||(l.disabled=!0,l.textContent="Checking…",l.title="Validating audio…"),l.classList.remove("btn-error"),t._validating=!0,r){const t=Number(r.dataset.pendingTracks||"0")+1;r.dataset.pendingTracks=String(t),syncCardAudioState(r)}}))return;let p=u,m=await probeAudioSource(e);if(!m.ok&&/401/.test(String(m.reason||""))&&t){const a=await refreshTrackContainerSource(t,{recordId:t._meta?.trackRecordId||t._meta?.recordId,audioField:t._meta?.audioField||t._audioField||"",candidates:AUDIO_FIELD_CANDIDATES,forceRefresh:!0});if(a?.notFound)return t._src="",c("Unavailable"),void(t._validating=!1);if(a&&a.src){const t=a.src;p=String(t||"").trim(),audioProbeCache.delete(u),u=p,e=t,m=await probeAudioSource(t)}}m.ok?(d(),i&&currentRow===t&&player.paused&&t._src&&queueTask(()=>{t._btn&&handlePlay(t._btn,t,t._src)})):c(m.reason||"Unavailable"),t._validating=!1}function syncCardAudioState(t){if(!t)return;const e="true"===t.dataset.hasAudioCandidates,a=Number(t.dataset.validTracks||"0"),l=Number(t.dataset.pendingTracks||"0");a>0?(t.classList.remove("no-audio"),"No playable audio available"===t.title&&t.removeAttribute("title")):e&&0!==l||(t.classList.add("no-audio"),t.title||(t.title="No playable audio available"))}function abortInFlight(){inFlight&&(inFlight.abort(),inFlight=null)}function snapshotState(t={}){return{groups:albumGroups.slice(),page:albumPage,rawItems:rawItems.slice(),rawTotalFound:rawTotalFound,rawNextOffset:rawNextOffset,lastQ:lastQ,searchValue:searchEl?searchEl.value:"",mode:currentMode,...t}}function applySnapshot(t){t&&(albumGroups=Array.isArray(t.groups)?t.groups.slice():[],rawItems=Array.isArray(t.rawItems)?t.rawItems.slice():[],rawTotalFound="number"==typeof t.rawTotalFound?t.rawTotalFound:rawItems.length,rawNextOffset="number"==typeof t.rawNextOffset?t.rawNextOffset:rawItems.length,albumPage="number"==typeof t.page?t.page:0,lastQ="string"==typeof t.lastQ?t.lastQ:"",currentMode=t.mode||"search",activePublicPlaylist=null,primeAlbumAudioValidation(albumGroups),refreshPublicPlaylists(),searchEl&&"string"==typeof t.searchValue&&(searchEl.value=t.searchValue),hideLanding(),errorEl.hidden=!0)}function restorePreviousSearch(){if(!prevSearch)return;const t=prevSearch;prevSearch=null;const e=t.snapshot||t.paging||t.original;if(e){const a={...e};"search"===t.type&&"string"==typeof t.term&&(a.lastQ=t.term,a.searchValue=t.term),isRestoring=!0,applySnapshot(a),renderAlbumPage();if(albumGroups.length<=1&&("search"===t.type&&"string"==typeof t.term&&t.term.trim()||"explore"===t.type&&t.start)){if("search"===t.type)return searchEl&&(searchEl.value=t.term),void run(t.term);if("explore"===t.type){const e=Number(t.start)||0;if(e)return void runExplore(e)}return void(isRestoring=!1)}return void(isRestoring=!1)}if("explore"===t.type&&t.start){const e=Number(t.start)||0;if(e)return isRestoring=!0,void runExplore(e)}return"search"===t.type&&"string"==typeof t.term&&t.term.trim()?(searchEl&&(searchEl.value=t.term),isRestoring=!0,void run(t.term)):void 0}function showLanding(){try{const t=document.querySelector(".content-column");t&&t.classList.remove("exploring")}catch{}try{playlistColumn&&(playlistColumn.hidden=!Boolean(currentUser))}catch{}sharedPlaylistActive&&clearSharedPlaylistState(),currentMode="landing",currentExploreDecade=null,prevSearch=null,rawItems=[],albumsEl.classList.remove("single-album"),pagerEl.hidden=!0,shuffleBtn&&(shuffleBtn.hidden=!0),countEl.textContent="",errorEl.hidden=!0}async function loadRandomSongs(){console.log("[loadRandomSongs] Starting...");const t=performance.now();loadingIndicator&&(loadingIndicator.hidden=!1),albumsEl&&(albumsEl.style.display="none");try{const e=performance.now();console.log("[loadRandomSongs] Fetching from /api/random-songs?count=12");const a=await fetch("/api/random-songs?count=12"),l=performance.now()-e;if(!a.ok)return;const r=performance.now(),n=await a.json();performance.now();if(!n||!Array.isArray(n.items)||0===n.items.length)return;const i=performance.now()-t;console.log(`[loadRandomSongs] Loaded ${n.items.length} songs in ${i.toFixed(0)}ms (fetch: ${l.toFixed(0)}ms)`),currentMode="songs",activePublicPlaylist=null;try{null}catch{}renderSongsGrid(n.items),updateAuthUI();try{playlistColumn&&(playlistColumn.hidden=!Boolean(currentUser))}catch{}}catch(t){console.warn("[loadRandomSongs]",t)}finally{loadingIndicator&&(loadingIndicator.hidden=!0)}}function renderSongsGrid(t){console.log("[renderSongsGrid] Called with",t.length,"songs"),loadingIndicator&&(loadingIndicator.hidden=!0),albumsEl&&(albumsEl.style.display=""),albumsEl.innerHTML="",countEl.textContent=`${t.length} Random Songs`,pagerEl.hidden=!0,shuffleBtn&&(shuffleBtn.hidden=!1);for(const e of t)try{const t=e.fields||{},a=document.createElement("article");a.className="card";const l=pickFieldValue(t,TRACK_TITLE_CANDIDATES).value||t["Track Name"]||"Unknown Track",r=pickFieldValue(t,["Album Artist","Artist","Tape Files::Album Artist"]).value||"Unknown Artist",n=pickFieldValue(t,ARTWORK_FIELD_CANDIDATES).value,i=pickFieldValue(t,AUDIO_FIELD_CANDIDATES),s=pickFieldValue(t,["Album","Tape Files::Album"]).value||"",o=pickFieldValue(t,["Catalogue #","Catalogue"]).value||"";console.log("[renderSongsGrid] Track:",l,"Artist:",r,"Audio:",!!i.value,"Picture:",!!n);const c=resolvePlayableSrc(i.value);a._src=c,a._meta={trackName:l,trackArtist:r,albumTitle:s,albumArtist:r,playlistId:null,playlistName:"",picture:n||"",source:"random",catalogue:o,audioField:i.field||"",trackRecordId:e.recordId||"",pictureField:pickFieldValue(t,ARTWORK_FIELD_CANDIDATES).field||"",src:c};const d=document.createElement("div");d.className="cover-wrap";const u=document.createElement("img");n?(u.src=`/api/container?u=${encodeURIComponent(n)}`,u.onerror=()=>{u.src="/img/placeholder.png"}):u.src="/img/placeholder.png",u.alt="Cover",u.loading="lazy",d.appendChild(u),a.appendChild(d);const y=document.createElement("div");y.className="heading";const p=document.createElement("h3");p.textContent=l,y.appendChild(p);const m=document.createElement("div");if(m.style.color="var(--muted)",m.style.fontSize="13px",m.style.marginTop="4px",m.textContent=r,y.appendChild(m),a.appendChild(y),i.value&&c){const t=document.createElement("button");t.className="play-button",t.textContent="▶ Play",t.dataset.loadingLabel="Loading…",t.addEventListener("click",()=>{handlePlay(t,a,c)}),a.appendChild(t)}const h=document.createElement("button");h.className="btn secondary small",h.textContent="+ Playlist",h.style.marginTop="8px",h.addEventListener("click",()=>{handleAddToPlaylist({title:pickFieldValue(t,["Album","Tape Files::Album"]).value||"",artist:r,catalogue:pickFieldValue(t,["Catalogue #","Catalogue"]).value||"",picture:n,pictureField:pickFieldValue(t,ARTWORK_FIELD_CANDIDATES).field||""},{recordId:e.recordId||"",name:l,trackArtist:pickFieldValue(t,["Artist","Track Artist"]).value||r,seq:pickFieldValue(t,["Track #","Track Number","Seq"]).value||null,mp3:i.value,mp3Field:i.field||"",audioField:i.field||""},resolvePlayableSrc(i.value))}),a.appendChild(h),albumsEl.appendChild(a),console.log("[renderSongsGrid] Card added for",l)}catch(t){console.error("[renderSongsGrid] Error rendering song:",t)}console.log("[renderSongsGrid] Finished rendering",albumsEl.children.length,"cards")}async function loadRandomAlbums(){const t=performance.now();loadingIndicator&&(loadingIndicator.hidden=!1),albumsEl&&(albumsEl.style.display="none");try{const e=[1950,1960,1970,1980,1990,2e3,2010,2020],a=e[Math.floor(Math.random()*e.length)],l=a+9,r=new URLSearchParams;r.set("start",String(a)),r.set("end",String(l)),r.set("limit","150");const n=performance.now(),i=await fetch(`/api/explore?${r}`),s=performance.now()-n;if(!i.ok)return;const o=performance.now(),c=await i.json();performance.now();if(!c||!Array.isArray(c.items)||0===c.items.length)return;rawItems=c.items||[],rawTotalFound=Number(c.total||rawItems.length);const d=performance.now(),u=groupAlbums(rawItems);performance.now();if(!u.length)return;const y=performance.now();shuffleInPlace(u);performance.now();albumGroups=u,rawItems=albumGroups,rawTotalFound=albumGroups.length,rawNextOffset=albumGroups.length;const p=performance.now()-t;console.log(`[loadRandomAlbums] Loaded ${albumGroups.length} albums from ${c.items.length} tracks in ${p.toFixed(0)}ms (fetch: ${s.toFixed(0)}ms)`),albumPage=0,currentMode="explore",currentExploreDecade=null,activePublicPlaylist=null;try{const t=document.querySelector(".content-column");t&&t.classList.add("exploring")}catch{}refreshPublicPlaylists(),renderAlbumPage(),updateAuthUI();try{playlistColumn&&(playlistColumn.hidden=!Boolean(currentUser))}catch{}}catch(t){console.warn("[loadRandomAlbums]",t)}finally{loadingIndicator&&(loadingIndicator.hidden=!0),albumsEl&&(albumsEl.style.display="")}}function hideLanding(){}function doSearch(t){abortInFlight();const e=new AbortController;inFlight=e;const a=new URLSearchParams;return t&&a.set("q",t),a.set("offset",0),a.set("limit",300),fetch(`/api/search?${a}`,{signal:e.signal}).then(async t=>{if(!t.ok)throw new Error(await t.text().catch(()=>`HTTP ${t.status}`));return t.json()}).finally(()=>{inFlight===e&&(inFlight=null)})}function normTitle(t){return String(t||"").replace(/\s+/g," ").replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"').replace(/^\W+|\W+$/g,"").trim()}function keyTitle(t){return normTitle(t).toLowerCase()}function makeAlbumKey(t,e,a){const l=String(t||"").trim();if(l)return`cat:${l.toLowerCase()}`;return`title:${normTitle(e||"").toLowerCase()}|artist:${normTitle(a||"").toLowerCase()}`}function groupAlbums(t){const e=new Map;for(const a of t){const t=a.fields||{},l=fCatalogue(t)||"__NO_CAT__",r=normTitle(fTitle(t)||"(no album)"),n=normTitle(fArtist(t)||""),i=normTitle(t["Track Artist"]||t["Tape Files::Track Artist"]||""),s=pickFieldValue(t,ARTWORK_FIELD_CANDIDATES),o=String(s.value||"").trim(),c=s.field||"",d=normTitle(t[F_TRACK]||""),u=pickFieldValue(t,AUDIO_FIELD_CANDIDATES),y=u.value||"",p=u.field||"",m=pickFieldValue(t,PUBLIC_PLAYLIST_FIELD_CANDIDATES).value||"",h=m?m.split(/[,;|\n\r]/).map(t=>t.trim()).filter(Boolean):[],g=normTitle(t[F_GENRE]||""),b=composersFrom(t).map(t=>normTitle(t||"")),P=normTitle(t.Producer||""),f=normTitle(fLang(t)||""),w=normTitle(t.Composer||t["Composer 1"]||t.Composer1||""),k=normTitle(t["Composer 2"]||t.Composer2||""),A=normTitle(t["Composer 3"]||t.Composer3||""),E=normTitle(t["Composer 4"]||t.Composer4||""),v=(t.ISRC||"").trim(),T=String(t["songfiles:Audio Test"]||t["Songfiles::Audio Test"]||t["songfiles::Audio Test"]||t["Audio Test"]||"").toLowerCase(),S=!T||!T.includes("invalid");e.has(l)||e.set(l,{catalogue:"__NO_CAT__"===l?"":l,titles:new Map,artist:n,picture:o||"",pictureField:c||"",tracks:[]});const I=e.get(l),C=keyTitle(r),L=I.titles.get(C)||{raw:r,count:0};if(L.count+=1,I.titles.set(C,L),!I.picture&&o&&(I.picture=o,I.pictureField=c),!I.artist&&n&&(I.artist=n),d){const e=I.tracks.length;I.tracks.push({name:d,mp3:y,mp3Field:p,genre:g,composers:b,producer:P,language:f,trackArtist:i,pictureField:c,composer1:w,composer2:k,composer3:A,composer4:E,isrc:v,publicPlaylists:h,seq:parseTrackSequence(t),recordId:a.recordId||"",_order:e,hasValidAudio:S})}}const a=[];for(const t of e.values()){const e=(t.picture||"").trim();if(!t.tracks.length)continue;const l=t.tracks.filter(t=>hasValidMp3(t.mp3)&&t.hasValidAudio),r=l.map(t=>({...t})),n=new Map;for(const e of t.tracks)if(Array.isArray(e.publicPlaylists))for(const t of e.publicPlaylists){const e=String(t||"").trim();if(!e)continue;const a=e.toLowerCase();n.has(a)||n.set(a,e)}const i=Array.from(n.values()),s=new Set(t.tracks.map(t=>keyTitle(t.name))),o=Array.from(t.titles.entries()),c=o.filter(([t])=>!s.has(t)),d=(t=>t.reduce((t,e)=>!t||e[1].count>t[1].count?e:t,null))(c.length?c:o),u=d?d[1].raw:"(no album)";r.sort((t,e)=>{const a=Number(t.seq),l=Number(e.seq),r=Number.isFinite(a),n=Number.isFinite(l);if(r&&n&&a!==l)return a-l;if(r&&!n)return-1;if(!r&&n)return 1;const i=Number.isFinite(t._order)?t._order:Number.POSITIVE_INFINITY,s=Number.isFinite(e._order)?e._order:Number.POSITIVE_INFINITY;return i!==s?i-s:t.name.localeCompare(e.name,void 0,{sensitivity:"base"})});const y=makeAlbumKey(t.catalogue,u,t.artist),p=l.length>0;a.push({catalogue:t.catalogue,title:u,artist:t.artist,picture:e,pictureField:t.pictureField||"",tracks:r,hasPlayable:p,publicPlaylists:i,key:y})}return a.sort((t,e)=>t.title.localeCompare(e.title,void 0,{sensitivity:"base"})||t.artist.localeCompare(e.artist,void 0,{sensitivity:"base"})),a}function computePublicPlaylistsFromAlbums(t){const e=new Map;for(const a of t||[]){if(!a)continue;const t=a.key||"",l=(Array.isArray(a.tracks)?a.tracks:[]).length,r=Array.isArray(a.publicPlaylists)?a.publicPlaylists:[];if(r.length)for(const a of r){const r=String(a||"").trim();if(!r)continue;const n=r.toLowerCase();let i=e.get(n);i||(i={name:r,albumKeys:new Set,albumCount:0,trackCount:0},e.set(n,i)),i.albumKeys.has(t)||(i.albumKeys.add(t),i.albumCount+=1,i.trackCount+=l)}}const a=Array.from(e.values()).map(({name:t,albumCount:e,trackCount:a,image:l})=>({name:t,albumCount:e,trackCount:a,image:l||""}));return a.sort((t,e)=>t.name.localeCompare(e.name,void 0,{sensitivity:"base"})),a}function setActivePublicPlaylist(t,e=""){publicPlaylistsLoaded||publicPlaylistsLoading||loadPublicPlaylistSummaries();const a="string"==typeof t?t.trim():"",l=activePublicPlaylist?activePublicPlaylist.toLowerCase():"",r=a.toLowerCase(),n=publicPlaylistsSummary.find(t=>t&&"string"==typeof t.name&&t.name.toLowerCase()===r)||null,i=n?.image||e||"";if(!a||l&&l===r&&!publicPlaylistTracksLoading)return activePublicPlaylist=null,activePublicPlaylistImage="",activePublicPlaylistTracks=[],publicPlaylistTracksError=null,albumPage=0,currentMode="songs",renderPublicPlaylists(),renderPublicPlaylistView(),void loadRandomSongs();activePublicPlaylist=a,activePublicPlaylistImage=i,currentMode="public-playlist",publicPlaylistTracksError=null,albumPage=0;const s=publicPlaylistTracksCache.get(r);if(s)return activePublicPlaylistTracks=Array.isArray(s.tracks)?s.tracks.slice():[],renderPublicPlaylists(),renderPublicPlaylistView(),void renderAlbumPage();activePublicPlaylistTracks=[],renderPublicPlaylists(),renderPublicPlaylistView(),renderAlbumPage(),loadPublicPlaylistTracks(a)}function refreshPublicPlaylists(t=albumGroups){if(!publicPlaylistsLoaded&&t&&(publicPlaylistsSummary=computePublicPlaylistsFromAlbums(t||[])),activePublicPlaylist){const t=activePublicPlaylist.toLowerCase();publicPlaylistsSummary.some(e=>e.name.toLowerCase()===t)||(activePublicPlaylist=null)}renderPublicPlaylists(),renderPublicPlaylistView(),updateAuthUI()}function renderPublicPlaylists(){if(publicPlaylistsEmpty&&(publicPlaylistsLoading?(publicPlaylistsEmpty.textContent="Loading curated playlists…",publicPlaylistsEmpty.hidden=!1):publicPlaylistsError?(publicPlaylistsEmpty.textContent=publicPlaylistsError,publicPlaylistsEmpty.hidden=!1):(publicPlaylistsEmpty.textContent="No curated playlists yet.",publicPlaylistsEmpty.hidden=publicPlaylistsSummary.length>0)),!publicPlaylistsList)return;publicPlaylistsList.innerHTML="";const t=Array.isArray(publicPlaylistsSummary)?publicPlaylistsSummary:[],e=activePublicPlaylist?activePublicPlaylist.toLowerCase():"";t.length?(t.forEach(t=>{const a=document.createElement("li");a.className="public-playlist-item";const l=document.createElement("button");l.type="button",l.dataset.playlistName=t.name||"",t.image&&(l.dataset.image=t.image);const r=document.createElement("span");r.className="public-playlist-thumb";const n=(t.name||"").trim().charAt(0);r.textContent=n||"♪",l.appendChild(r);const i=document.createElement("span");i.className="public-playlist-label";const s=document.createElement("span");s.className="public-playlist-name",s.textContent=t.name||"Playlist",i.appendChild(s);const o=document.createElement("span");o.className="public-playlist-count";const c=[];c.push(`${t.albumCount} album${1===t.albumCount?"":"s"}`),t.trackCount>0&&c.push(`${t.trackCount} track${1===t.trackCount?"":"s"}`),o.textContent=c.join(" • "),i.appendChild(o),l.appendChild(i),t.name&&t.name.toLowerCase()===e&&l.classList.add("active"),l.addEventListener("click",()=>setActivePublicPlaylist(t.name,t.image||l.dataset.image||"")),applyPlaylistThumbArtwork(r,t.name,t.image||l.dataset.image||""),a.appendChild(l),publicPlaylistsList.appendChild(a)}),syncPublicFeaturedVisibility()):syncPublicFeaturedVisibility()}async function loadPublicPlaylistSummaries(){if(!publicPlaylistsLoaded&&!publicPlaylistsLoading){publicPlaylistsLoading=!0,publicPlaylistsError=null,renderPublicPlaylists(),updateAuthUI();try{const t=await fetch("/api/public-playlists",{headers:{Accept:"application/json"}});if(!t.ok){const e=await t.text().catch(()=>`HTTP ${t.status}`);throw new Error(e||"Unable to load curated playlists")}const e=await t.json().catch(()=>({}));publicPlaylistsSummary=Array.isArray(e?.playlists)?e.playlists:[],publicPlaylistsLoaded=!0}catch(t){publicPlaylistsError=t?.message||"Unable to load curated playlists"}finally{publicPlaylistsLoading=!1,renderPublicPlaylists(),renderPublicPlaylistView(),updateAuthUI()}}}async function loadPublicPlaylistTracks(t){const e=t.toLowerCase();publicPlaylistTracksLoading=!0,publicPlaylistTracksError=null,renderPublicPlaylistView();try{const a=await fetch(`/api/public-playlists?name=${encodeURIComponent(t)}`,{headers:{Accept:"application/json"}});if(!a.ok){const t=await a.text().catch(()=>`HTTP ${a.status}`);throw new Error(t||"Unable to load playlist")}const l=await a.json().catch(()=>({}));Array.isArray(l?.playlists)&&(publicPlaylistsSummary=l.playlists,publicPlaylistsLoaded=!0);const r=(Array.isArray(l?.tracks)?l.tracks:[]).slice().sort((t,e)=>{const a=Number.isFinite(t?.seq)?Number(t.seq):Number.POSITIVE_INFINITY,l=Number.isFinite(e?.seq)?Number(e.seq):Number.POSITIVE_INFINITY;if(a!==l)return a-l;const r=String(t?.name||"").toLowerCase(),n=String(e?.name||"").toLowerCase();return r<n?-1:r>n?1:0});publicPlaylistTracksCache.set(e,{tracks:r.slice()}),activePublicPlaylist&&activePublicPlaylist.toLowerCase()===e&&(activePublicPlaylistTracks=r)}catch(t){publicPlaylistTracksError=t?.message||"Unable to load playlist tracks",activePublicPlaylist&&activePublicPlaylist.toLowerCase()===e&&(activePublicPlaylistTracks=[])}finally{publicPlaylistTracksLoading=!1,renderPublicPlaylists(),renderPublicPlaylistView(),renderAlbumPage()}}function createPublicPlaylistRow(t,e,a,l){const r=document.createElement("li");r.className="track playlist-track public-playlist-track";const n=document.createElement("button");n.type="button",n.className="btn track-play";const i=resolvePlayableSrc(t?.resolvedSrc||t?.mp3||""||""),s=canValidateAudioSrc(i)?i:"",o="string"==typeof t?.audioField?t.audioField.trim():"",c="string"==typeof t?.artworkField?t.artworkField.trim():"",d=activePublicPlaylistImage||"";r._src=s,r._btn=n,r._card=null,r._playlist=a,r._audioField=o,r._valid=null,r._validated=!1,r._validating=!1;const u=t?.trackRecordId||t?.id||"";u&&(r.dataset.trackId=u),n.dataset.playLabel="▶",n.dataset.pauseLabel="⏸";const y=t?.name||"Untitled track",p=(t?.trackArtist||t?.albumArtist||"").trim(),m=p?`${p} — ${y}`:y;n.dataset.playAria=`Play ${m}`,n.dataset.pauseAria=`Pause ${m}`,s?(n.textContent=n.dataset.playLabel,n.disabled=!1,n.classList.remove("btn-error"),n.setAttribute("aria-label",n.dataset.playAria)):(n.textContent="No audio",n.disabled=!0,n.classList.add("btn-error"),n.setAttribute("aria-label",`Audio unavailable for ${m}`)),n.addEventListener("click",()=>{if(r._src){if(!1===r._valid)return n.textContent="Unavailable",n.disabled=!0,n.classList.add("btn-error"),void n.setAttribute("aria-label",`Audio unavailable for ${m}`);handlePlay(n,r,r._src),!0===r._valid||r._validating||(r._validating=!0,validateAudio(r,r._src,{optimistic:!0}).finally(()=>{r._validating=!1}))}else window.alert("This track has no playable audio source.")});const h=document.createElement("span");if(h.className="track-name",p){const t=document.createElement("span");t.className="track-name-artist",t.textContent=p,h.appendChild(t);const e=document.createElement("span");e.className="track-name-title",e.textContent=y,h.appendChild(e)}else{const t=document.createElement("span");t.className="track-name-title",t.textContent=y,h.appendChild(t)}const g=[p,t?.albumTitle,t?.albumArtist].filter(t=>"string"==typeof t&&t.trim());if(g.length){const t=g.join(" • ");h.title=t,r.title=t}r.appendChild(n),r.appendChild(h);const b={trackName:y,trackArtist:t?.trackArtist||t?.albumArtist||"",albumTitle:t?.albumTitle||"",albumArtist:t?.albumArtist||"",catalogue:t?.catalogue||"",playlistId:a,playlistName:l,playlistTrackId:u,trackRecordId:u,trackId:u,audioField:o,pictureField:c||"Artwork::Picture",picture:t?.picture||t?.albumPicture||d||"",albumPicture:t?.albumPicture||t?.picture||d||"",src:s,mp3:t?.mp3||"",producer:t?.producer||"",language:t?.language||"",genre:t?.genre||"",isrc:t?.isrc||"",composer1:t?.composer1||"",composer2:t?.composer2||"",composer3:t?.composer3||"",composer4:t?.composer4||"",composers:Array.isArray(t?.composers)?t.composers:[],albumKey:t?.albumKey||makeAlbumKey(t?.catalogue||"",t?.albumTitle||"",t?.albumArtist||""),source:"public-playlist"};return r._meta=b,{element:r,button:n,playableSrc:s}}function renderPublicPlaylistView(){if(!publicPlaylistView)return;if(!Boolean(activePublicPlaylist))return publicPlaylistView.hidden=!0,publicPlaylistStatus&&(publicPlaylistStatus.hidden=!0,publicPlaylistStatus.textContent=""),resetPlaylistArtwork(publicPlaylistArt,publicPlaylistHero),publicPlaylistTracks&&(publicPlaylistTracks.innerHTML=""),publicPlaylistEmpty&&(publicPlaylistEmpty.hidden=!0),albumsEl&&(albumsEl.style.display=""),void syncPublicFeaturedVisibility();hideLanding(),publicPlaylistView.hidden=!1,hideLanding(),albumsEl&&(albumsEl.style.display="none"),pagerEl&&(pagerEl.hidden=!0),errorEl&&(errorEl.hidden=!0);const t=publicPlaylistsSummary.find(t=>t&&"string"==typeof t.name&&t.name.toLowerCase()===activePublicPlaylist.toLowerCase()),e=activePublicPlaylistImage||t?.image||"";!activePublicPlaylistImage&&e&&(activePublicPlaylistImage=e),loadPlaylistArtwork(publicPlaylistArt,publicPlaylistHero,activePublicPlaylist,{preferredUrls:e?[e]:[],altText:activePublicPlaylist?`${activePublicPlaylist} artwork`:"Playlist artwork"}),publicPlaylistTitle&&(publicPlaylistTitle.textContent=t?.name||activePublicPlaylist||"Featured Playlist");const a=activePublicPlaylistTracks.length;if(publicPlaylistMeta&&(publicPlaylistMeta.textContent="",publicPlaylistMeta.hidden=!0),publicPlaylistStatus&&(publicPlaylistTracksLoading?(publicPlaylistStatus.textContent="Loading tracks…",publicPlaylistStatus.hidden=!1):publicPlaylistTracksError?(publicPlaylistStatus.textContent=publicPlaylistTracksError,publicPlaylistStatus.hidden=!1):(publicPlaylistStatus.textContent="",publicPlaylistStatus.hidden=!0)),publicPlaylistTracks){const t=currentRow&&currentRow._playlist===`public:${activePublicPlaylist.toLowerCase()}`?{playlistId:currentRow._playlist,src:currentRow._src,playing:!player.paused&&currentSrc===currentRow._src}:null;let e=!1;if(publicPlaylistTracks.innerHTML="",!publicPlaylistTracksLoading&&!publicPlaylistTracksError&&a>0){const a=`public:${activePublicPlaylist.toLowerCase()}`;if(activePublicPlaylistTracks.forEach((l,r)=>{const{element:n,button:i,playableSrc:s}=createPublicPlaylistRow(l,r,a,activePublicPlaylist);publicPlaylistTracks.appendChild(n),s&&t&&t.src===s&&t.playlistId===a&&(e=!0,currentRow=n,currentBtn=i,t.playing?(n.classList.add("playing"),i.textContent=i.dataset.pauseLabel||"⏸",i.classList.add("btn-accent"),i.disabled=!1,i.dataset.pauseAria&&i.setAttribute("aria-label",i.dataset.pauseAria)):(i.textContent=i.dataset.playLabel||"▶",i.classList.remove("btn-accent"),i.dataset.playAria&&i.setAttribute("aria-label",i.dataset.playAria)),setNowPlayingFromRow(n,t.playing))}),requestAnimationFrame(()=>{if(!publicPlaylistTracks)return;const t=Array.from(publicPlaylistTracks.children);if(t.length<=5)return void(publicPlaylistTracks.style.maxHeight="");const e=t[0],a=t[4];if(!e||!a)return void(publicPlaylistTracks.style.maxHeight="");const l=e.getBoundingClientRect(),r=a.getBoundingClientRect(),n=Math.max(0,r.bottom-l.top+4);publicPlaylistTracks.style.maxHeight=`${n}px`}),!t&&nowPlayingInfo.meta&&nowPlayingInfo.meta.playlistId===`public:${activePublicPlaylist.toLowerCase()}`){const t=nowPlayingInfo.meta.src||nowPlayingInfo.meta.playlistSrc||"",e=Array.from(publicPlaylistTracks.children).find(e=>e._src&&e._src===t);e&&e._btn&&(currentRow=e,currentBtn=e._btn,e.classList.toggle("playing",nowPlayingInfo.isPlaying))}t&&t.playlistId===`public:${activePublicPlaylist.toLowerCase()}`&&!e&&(t.playing&&!player.paused&&currentSrc===t.src&&player.pause(),currentSrc="",updateButtonsForStop())}}if(publicPlaylistTracks&&(publicPlaylistTracksLoading||publicPlaylistTracksError||a<=5)&&(publicPlaylistTracks.style.maxHeight=a>0?"":"0px"),publicPlaylistEmpty){const t=!publicPlaylistTracksLoading&&!publicPlaylistTracksError&&0===a;publicPlaylistEmpty.hidden=!t}syncPublicFeaturedVisibility()}function collectSharedPlaylistArtwork(t){if(!t||"object"!=typeof t)return[];const e=new Set,a=Array.isArray(t.tracks)?t.tracks:[],l=[];for(const t of a){if(!t||"object"!=typeof t)continue;const a=["string"==typeof t.artwork?t.artwork.trim():"","string"==typeof t.picture?t.picture.trim():"","string"==typeof t.albumPicture?t.albumPicture.trim():""];for(const t of a)t&&!e.has(t)&&(e.add(t),l.push(t))}return l}function getShareIdFromLocation(){try{const t=new URLSearchParams(window.location.search).get("share");return"string"==typeof t?t.trim():""}catch{return""}}function ensureShareQueryParam(t){try{const e=new URL(window.location.href);"string"==typeof t&&t.trim()?e.searchParams.set("share",t.trim()):e.searchParams.delete("share"),e.hash="";const a=e.searchParams.toString(),l=`${e.pathname}${a?`?${a}`:""}`;window.history.replaceState({},"",l)}catch{}}function clearShareQueryParam(){try{const t=new URL(window.location.href);t.searchParams.delete("share"),t.hash="";const e=t.searchParams.toString(),a=`${t.pathname}${e?`?${e}`:""}`;window.history.replaceState({},"",a)}catch{const t=window.location&&window.location.pathname||"/";window.history.replaceState({},"",t)}}function createSharedPlaylistRow(t,e,a={}){const l=a.playlistId||"shared",r=a.playlistName||"Playlist",n=a.playlistArt||"",i=a.shareId||"",s=document.createElement("li");s.className="track playlist-track public-playlist-track";const o=document.createElement("button");o.type="button",o.className="btn track-play";const c=resolvePlayableSrc(t?.resolvedSrc||t?.mp3||""||""),d=canValidateAudioSrc(c)?c:"",u="string"==typeof t?.audioField?t.audioField.trim():"",y="string"==typeof t?.artworkField?t.artworkField.trim():"";s._src=d,s._btn=o,s._card=null,s._playlist=l,s._audioField=u,s._valid=null,s._validated=!1,s._validating=!1;const p=t?.trackRecordId||t?.id||"";p&&(s.dataset.trackId=p),o.dataset.playLabel="▶",o.dataset.pauseLabel="⏸";const m=t?.name||`Track ${e+1}`,h=(t?.trackArtist||t?.albumArtist||"").trim(),g=h?`${h} — ${m}`:m;o.dataset.playAria=`Play ${g}`,o.dataset.pauseAria=`Pause ${g}`,d?(o.textContent=o.dataset.playLabel,o.disabled=!1,o.classList.remove("btn-error"),o.setAttribute("aria-label",o.dataset.playAria)):(o.textContent="No audio",o.disabled=!0,o.classList.add("btn-error"),o.setAttribute("aria-label",`Audio unavailable for ${g}`)),o.addEventListener("click",()=>{if(s._src){if(!1===s._valid)return o.textContent="Unavailable",o.disabled=!0,o.classList.add("btn-error"),void o.setAttribute("aria-label",`Audio unavailable for ${g}`);handlePlay(o,s,s._src),!0===s._valid||s._validating||(s._validating=!0,validateAudio(s,s._src,{optimistic:!0}).finally(()=>{s._validating=!1}))}else window.alert("This track has no playable audio source.")});const b=document.createElement("span");if(b.className="track-name",h){const t=document.createElement("span");t.className="track-name-artist",t.textContent=h,b.appendChild(t);const e=document.createElement("span");e.className="track-name-title",e.textContent=m,b.appendChild(e)}else{const t=document.createElement("span");t.className="track-name-title",t.textContent=m,b.appendChild(t)}const P=[h,t?.albumTitle,t?.albumArtist].filter(t=>"string"==typeof t&&t.trim());if(P.length){const t=P.join(" • ");b.title=t,s.title=t}s.appendChild(o),s.appendChild(b);const f={trackName:m,trackArtist:t?.trackArtist||t?.albumArtist||"",albumTitle:t?.albumTitle||"",albumArtist:t?.albumArtist||"",catalogue:t?.catalogue||"",playlistId:l,playlistName:r,playlistTrackId:p,trackRecordId:p,trackId:p,audioField:u,pictureField:y||"Artwork::Picture",picture:t?.artwork||t?.picture||t?.albumPicture||n||"",albumPicture:t?.albumPicture||t?.artwork||t?.picture||n||"",src:d,mp3:t?.mp3||"",producer:t?.producer||"",language:t?.language||"",genre:t?.genre||"",isrc:t?.isrc||"",composer1:t?.composer1||"",composer2:t?.composer2||"",composer3:t?.composer3||"",composer4:t?.composer4||"",composers:Array.isArray(t?.composers)?t.composers:[],albumKey:t?.albumKey||makeAlbumKey(t?.catalogue||"",t?.albumTitle||"",t?.albumArtist||""),shareId:i,source:"shared-playlist"};return s._meta=f,s}function renderSharedPlaylistView(){if(!sharedPlaylistView)return;if(!sharedPlaylistActive)return sharedPlaylistView.hidden=!0,sharedPlaylistStatus&&(sharedPlaylistStatus.hidden=!0,sharedPlaylistStatus.textContent=""),resetPlaylistArtwork(sharedPlaylistArt,sharedPlaylistHero),sharedPlaylistTracks&&(sharedPlaylistTracks.innerHTML=""),sharedPlaylistEmpty&&(sharedPlaylistEmpty.hidden=!0),sharedPlaylistMeta&&(sharedPlaylistMeta.textContent="",sharedPlaylistMeta.hidden=!0),sharedPlaylistCopyButton&&(sharedPlaylistCopyButton.disabled=!0),albumsEl&&(albumsEl.style.display=""),pagerEl&&(pagerEl.hidden=!1),void syncPublicFeaturedVisibility();hideLanding(),sharedPlaylistView.hidden=!1,albumsEl&&(albumsEl.style.display="none"),pagerEl&&(pagerEl.hidden=!0),errorEl&&(errorEl.hidden=!0),syncPublicFeaturedVisibility();const t=sharedPlaylistData?.name||"Playlist";if(sharedPlaylistTitle&&(sharedPlaylistTitle.textContent=t),sharedPlaylistStatus&&(sharedPlaylistLoading?(sharedPlaylistStatus.hidden=!1,sharedPlaylistStatus.textContent="Loading playlist…"):sharedPlaylistError?(sharedPlaylistStatus.hidden=!1,sharedPlaylistStatus.textContent=sharedPlaylistError):(sharedPlaylistStatus.hidden=!0,sharedPlaylistStatus.textContent="")),sharedPlaylistCopyButton&&(sharedPlaylistCopyButton.disabled=!sharedPlaylistShareUrl),sharedPlaylistLoading||sharedPlaylistError||!sharedPlaylistData)return resetPlaylistArtwork(sharedPlaylistArt,sharedPlaylistHero),sharedPlaylistTracks&&(sharedPlaylistTracks.innerHTML=""),sharedPlaylistEmpty&&(sharedPlaylistEmpty.hidden=!0),void(sharedPlaylistMeta&&(sharedPlaylistMeta.textContent="",sharedPlaylistMeta.hidden=!0));const e=Array.isArray(sharedPlaylistData.tracks)?sharedPlaylistData.tracks:[],a=activeSharedShareId?`shared:${activeSharedShareId}`:"shared:playlist",l=collectSharedPlaylistArtwork(sharedPlaylistData),r=l[0]||"";if(loadPlaylistArtwork(sharedPlaylistArt,sharedPlaylistHero,t,{preferredUrls:l,altText:t?`${t} artwork`:"Playlist artwork"}),sharedPlaylistMeta){const t=[];t.push(`${e.length} track${1===e.length?"":"s"}`);const a=formatDateForDisplay(sharedPlaylistData.sharedAt||sharedPlaylistData.updatedAt||sharedPlaylistData.createdAt);a&&t.push(`Shared ${a}`),sharedPlaylistMeta.textContent=t.join(" • "),sharedPlaylistMeta.hidden=0===t.length}if(sharedPlaylistTracks){const l=currentRow&&currentRow._playlist===a?{playlistId:currentRow._playlist,src:currentRow._src,playing:!player.paused&&currentSrc===currentRow._src}:null;let n=!1;if(sharedPlaylistTracks.innerHTML="",e.forEach((e,i)=>{const s=createSharedPlaylistRow(e,i,{playlistId:a,playlistName:t,playlistArt:r,shareId:activeSharedShareId});sharedPlaylistTracks.appendChild(s),s._src&&l&&l.src===s._src&&l.playlistId===a&&(n=!0,currentRow=s,currentBtn=s._btn||null,l.playing?(s.classList.add("playing"),s._btn&&(s._btn.textContent=s._btn.dataset.pauseLabel||"⏸",s._btn.classList.add("btn-accent"),s._btn.disabled=!1,s._btn.dataset.pauseAria&&s._btn.setAttribute("aria-label",s._btn.dataset.pauseAria))):s._btn&&(s._btn.textContent=s._btn.dataset.playLabel||"▶",s._btn.classList.remove("btn-accent"),s._btn.dataset.playAria&&s._btn.setAttribute("aria-label",s._btn.dataset.playAria)),setNowPlayingFromRow(s,l.playing))}),!l&&nowPlayingInfo.meta&&nowPlayingInfo.meta.playlistId===a){const t=nowPlayingInfo.meta.src||"",e=Array.from(sharedPlaylistTracks.children).find(e=>e._src&&e._src===t);e&&e._btn&&(currentRow=e,currentBtn=e._btn,e.classList.toggle("playing",nowPlayingInfo.isPlaying))}l&&l.playlistId===a&&!n&&(l.playing&&!player.paused&&currentSrc===l.src&&player.pause(),currentSrc="",updateButtonsForStop())}sharedPlaylistEmpty&&(sharedPlaylistEmpty.hidden=e.length>0)}async function activateSharedPlaylist(t,e={}){const a="string"==typeof t?t.trim():"";if(a){activeSharedShareId=a,sharedPlaylistActive=!0,sharedPlaylistLoading=!0,sharedPlaylistError=null,sharedPlaylistData=null,sharedPlaylistShareUrl="",currentMode="shared-playlist",!1!==e.updateUrl&&ensureShareQueryParam(a),renderSharedPlaylistView();try{const t=await fetch(`/api/shared-playlists/${encodeURIComponent(a)}`,{headers:{Accept:"application/json"}}),e=await t.json().catch(()=>({}));if(404===t.status)return void(sharedPlaylistError="This playlist link is no longer available.");if(!t.ok||!e?.ok)throw new Error(e?.error||"Unable to load playlist");sharedPlaylistData=e.playlist||null,sharedPlaylistShareUrl="string"==typeof e.shareUrl&&e.shareUrl.trim()?e.shareUrl.trim():buildShareUrlFallback(a)}catch(t){sharedPlaylistError=t?.message||"Unable to load playlist"}finally{sharedPlaylistLoading=!1,renderSharedPlaylistView()}}}function clearSharedPlaylistState({restoreLanding:t=!1}={}){sharedPlaylistActive=!1,sharedPlaylistLoading=!1,sharedPlaylistError=null,sharedPlaylistData=null,sharedPlaylistShareUrl="",activeSharedShareId="",t&&(currentMode="landing"),renderSharedPlaylistView()}function closeTrackInfoModal(t={}){trackInfoOverlay.classList.contains("open")&&(trackInfoOverlay.classList.remove("open"),trackInfoOverlay.hidden=!0,trackInfoBody.innerHTML="",document.removeEventListener("keydown",handleTrackInfoKeydown,!0),!t.suppressFocus&&trackInfoReturnFocus&&"function"==typeof trackInfoReturnFocus.focus&&trackInfoReturnFocus.focus(),trackInfoReturnFocus=null,trackInfoFocusables=[])}function collectTrackMetadata(t){if(!t)return[];const e=[],a=(t,a)=>{if(null==a)return;const l=String(a).trim();l&&e.push({label:t,value:l})};a("Producer",t.producer),a("Track Artist",t.trackArtist);const l=new Set([t.composer1,t.composer2,t.composer3,t.composer4].filter(Boolean).map(t=>String(t).trim()).filter(Boolean));return!l.size&&Array.isArray(t.composers)&&t.composers.forEach(t=>{const e=String(t||"").trim();e&&l.add(e)}),l.size&&a("Composer",Array.from(l).join(", ")),a("Language",t.language),a("Genre",t.genre),a("ISRC",t.isrc),e}function openTrackInfoModal(t,e){if(!t)return;closeTrackInfoModal({suppressFocus:!0}),trackInfoReturnFocus=e||null;const a=collectTrackMetadata(t);if(a.length){const t=document.createElement("dl");a.forEach(({label:e,value:a})=>{const l=document.createElement("dt");l.textContent=e;const r=document.createElement("dd");r.textContent=a,t.appendChild(l),t.appendChild(r)}),trackInfoBody.innerHTML="",trackInfoBody.appendChild(t)}else trackInfoBody.innerHTML='<p class="info-modal-empty">No additional metadata.</p>';trackInfoOverlay.hidden=!1,trackInfoOverlay.classList.add("open"),trackInfoFocusables=Array.from(trackInfoDialog.querySelectorAll(trackInfoFocusableSelector)),0===trackInfoFocusables.length?(trackInfoDialog.setAttribute("tabindex","-1"),trackInfoFocusables=[trackInfoDialog]):trackInfoDialog.removeAttribute("tabindex");const l=trackInfoFocusables[0]||trackInfoDialog;requestAnimationFrame(()=>l.focus()),document.addEventListener("keydown",handleTrackInfoKeydown,!0)}function handleTrackInfoKeydown(t){if(trackInfoOverlay.classList.contains("open")){if("Escape"===t.key)return t.preventDefault(),void closeTrackInfoModal();if("Tab"===t.key&&trackInfoFocusables.length){const e=trackInfoFocusables[0],a=trackInfoFocusables[trackInfoFocusables.length-1];t.shiftKey&&document.activeElement===e?(t.preventDefault(),a.focus()):t.shiftKey||document.activeElement!==a||(t.preventDefault(),e.focus())}}}function closeTracksModal(){closeTrackInfoModal({suppressFocus:!0}),player.paused||player.pause(),updateButtonsForStop(),currentSrc="",overlay.classList.remove("open"),overlay.setAttribute("aria-hidden","true"),modalContent.innerHTML="",modalCover.innerHTML="",document.body.classList.remove("no-scroll")}async function openTracksModal(t,e=null){closeTracksModal();const a=e||null;a&&(a.dataset.validTracks="0",a.dataset.pendingTracks="0","true"===a.dataset.hasAudioCandidates?(a.classList.remove("no-audio"),"No playable audio available"===a.title&&a.removeAttribute("title")):(a.classList.add("no-audio"),a.title||(a.title="No playable audio available")));let l=t;if(("explore"===currentMode||"landing"===currentMode)&&(t.catalogue||t.title))try{const e=new URLSearchParams;t.catalogue&&e.set("cat",t.catalogue),t.title&&e.set("title",t.title),t.artist&&e.set("artist",t.artist);const a=await fetch(`/api/album?${e}`);if(a.ok){const e=await a.json();e.items&&e.items.length>0&&(l={...t,tracks:e.items},console.log(`[openTracksModal] Fetched ${e.items.length} complete tracks for "${t.title}"`))}}catch(t){console.warn("[openTracksModal] Failed to fetch complete album:",t)}if(modalTitle.textContent=l.title||"(no album)",modalArtist.textContent=l.artist||"",modalCat.textContent=l.catalogue||"",l.catalogue?modalCat.style.display="inline-block":modalCat.style.display="none",l.picture){const t=document.createElement("div");t.className="cover-wrap";const e=document.createElement("img");e.src=`/api/container?u=${encodeURIComponent(l.picture)}`,e.alt="Cover",e.loading="lazy",e.onerror=()=>{modalCover.innerHTML=""},t.appendChild(e),modalCover.innerHTML="",modalCover.appendChild(t),modalCover.style.display="block"}else modalCover.innerHTML="",modalCover.style.display="none";const r=document.createElement("ul");r.className="tracks";if((l.tracks||[]).filter(t=>!1!==t.hasValidAudio).forEach((e,n)=>{const i=document.createElement("li");i.className="track";const s=document.createElement("div");s.className="track-top";const o=document.createElement("div");o.className="track-title";const c=document.createElement("div");if(c.className="name",c.textContent=e.name||"Untitled track",o.appendChild(c),e.trackArtist){const t=document.createElement("div");t.className="artist",t.textContent=e.trackArtist,o.appendChild(t)}s.appendChild(o);const d=document.createElement("div");d.className="controls";const u=document.createElement("button");u.className="btn small";const y=resolvePlayableSrc(e.mp3),p=canValidateAudioSrc(y),m=p?y:"";i._src=m,i._btn=u,i._card=a,i._playlist=null,i._audioField=e.mp3Field||"";const h={...e};h.trackName=e.name||"Untitled track",h.trackArtist=e.trackArtist||l.artist||"",h.albumTitle=l.title||"",h.albumArtist=l.artist||"",h.playlistId=null,h.playlistName="",h.picture=l.picture||"",h.source="album",h.catalogue=l.catalogue||"",h.audioField=e.mp3Field||"",h.trackRecordId=e.recordId||"",h.pictureField=l.pictureField||e.pictureField||"",h.src=m,i._meta=h,i._validated=!1,i._valid=null,i._validating=!1,p?(u.textContent="▶ Play",u.disabled=!1,u.classList.remove("btn-error"),u.removeAttribute("title")):e.mp3?(u.textContent="Invalid audio",u.disabled=!0,u.classList.add("btn-error"),u.title="Invalid audio link"):(u.textContent="No audio",u.disabled=!0,u.classList.add("btn-error"),u.title="Audio missing"),u.addEventListener("click",async()=>{if(i._src){if(!1===i._valid)return u.textContent="Unavailable",u.disabled=!0,void u.classList.add("btn-error");handlePlay(u,i,i._src),!0===i._valid||i._validating||(i._validating=!0,validateAudio(i,i._src,{optimistic:!0}).finally(()=>{i._validating=!1}))}}),d.appendChild(u);const g=document.createElement("button");g.type="button",g.className="btn small",g.textContent="Add to playlist",g.addEventListener("click",()=>handleAddToPlaylist(t,e,m)),d.appendChild(g);if(Boolean(e.producer||e.trackArtist||e.composer1||e.composer2||e.composer3||e.composer4||Array.isArray(e.composers)&&e.composers.some(t=>String(t||"").trim())||e.language||e.genre||e.isrc)){const t=document.createElement("button");t.type="button",t.className="btn small info-more",t.setAttribute("aria-label","More info"),t.innerHTML='<span aria-hidden="true">⋮</span>',t.addEventListener("click",()=>openTrackInfoModal(e,t)),d.appendChild(t)}s.appendChild(d),i.appendChild(s);const b=document.createElement("div");b.className="progress";const P=document.createElement("input");P.type="range",P.className="seek",P.min=0,P.max=100,P.value=0;const f=document.createElement("div");f.className="time",f.textContent="0:00 / 0:00",b.appendChild(P),b.appendChild(f),i.appendChild(b),i._seek=P,i._time=f,i._seeking=!1,P.addEventListener("input",()=>{if(currentRow===i&&player.duration&&isFinite(player.duration)){const t=Number(P.value)/100;player.currentTime=t*player.duration}}),P.addEventListener("change",()=>{if(currentRow===i&&player.duration&&isFinite(player.duration)){const t=Number(P.value)/100;player.currentTime=t*player.duration}i._seeking=!1}),P.addEventListener("pointerdown",()=>{currentRow===i&&(i._seeking=!0)}),P.addEventListener("pointerup",()=>{currentRow===i&&(i._seeking=!1)}),r.appendChild(i)}),modalContent.innerHTML="",Array.isArray(l?.tracks)&&l.tracks.length){const t=document.createElement("div");t.className="album-actions";const e=document.createElement("button");e.type="button",e.className="btn small btn-accent",e.textContent=`Add album to playlist (${l.tracks.length} tracks)`,e.addEventListener("click",async()=>{const t=e.textContent;e.disabled=!0,e.textContent="Adding…";try{await handleAddAlbumToPlaylist(l)}finally{e.disabled=!1,e.textContent=t}}),t.appendChild(e),modalContent.appendChild(t)}modalContent.appendChild(r),overlay.classList.add("open"),overlay.setAttribute("aria-hidden","false"),document.body.classList.add("no-scroll")}function renderAlbumPage(){loadingIndicator&&(loadingIndicator.hidden=!0),albumsEl&&(albumsEl.style.display=""),albumsEl.innerHTML="";const t=[],e=[],a=[];let l=0;for(const r of albumGroups){if(!r)continue;const n=r.key||makeAlbumKey(r.catalogue,r.title,r.artist);r.key=n;const i=albumAudioState.get(n);i?"pending"!==i.status?"valid"!==i.status?"invalid"===i.status&&(isFresh(i)?(r._noAudio=!0,a.push(r)):(albumAudioState.delete(n),ensureAlbumAudioValidation(r),l+=1,e.push(r))):isFresh(i)?(r._pendingValidation=!1,t.push(r)):(albumAudioState.delete(n),ensureAlbumAudioValidation(r),l+=1,e.push(r)):(r._pendingValidation=!0,l+=1,e.push(r)):(ensureAlbumAudioValidation(r),l+=1,e.push(r))}l=e.length;let r=t.concat(e);if(showAlbumsWithoutAudio&&(r=r.concat(a)),activePublicPlaylist){const t=activePublicPlaylist.toLowerCase(),a=e=>Array.isArray(e?.publicPlaylists)&&e.publicPlaylists.some(e=>String(e||"").toLowerCase()===t);r=r.filter(a),l=e.filter(a).length}const n=r.length,i=activePublicPlaylist?n:albumGroups.length||n;i>0||activePublicPlaylist?errorEl.hidden=!0:0===l&&albumGroups.length>0?!showAlbumsWithoutAudio&&a.length>0?(errorEl.hidden=!1,errorEl.textContent=`Found ${a.length} album${1!==a.length?"s":""} but audio is unavailable. Enable "Show all" to view.`):(errorEl.hidden=!1,errorEl.textContent="No albums with complete audio and artwork are available right now."):l>0&&(errorEl.hidden=!0),0===n&&albumsEl.classList.remove("single-album"),countEl.textContent=0===n&&l>0?"Validating audio…":activePublicPlaylist?"":i?`Albums: ${i}`:lastQ?"No albums":"";const s=Math.max(i,r.length),o=Math.max(1,Math.ceil(Math.max(s,1)/8));albumPage=Math.min(albumPage,o-1);const c="explore"===currentMode||"landing"===currentMode;if(console.log(`[renderAlbumPage] mode=${currentMode}, isExploreMode=${c}, shuffleBtn=${!!shuffleBtn}`),c?(pagerEl.hidden=!0,shuffleBtn&&(shuffleBtn.hidden=!1)):(pagerEl.hidden=s<=8,shuffleBtn&&(shuffleBtn.hidden=!0),pageInfo.textContent=`Page ${albumPage+1} / ${o}`,prevEl.disabled=albumPage<=0,nextEl.disabled=albumPage>=o-1&&rawItems.length>=rawTotalFound),s>8&&!c&&console.log(`[PAGINATION] Showing pager: ${s} albums (${o} pages)`),0===n&&l>0){const t=document.createElement("div");return t.className="muted",t.textContent="Validating audio availability…",void albumsEl.appendChild(t)}if(0===n)return;const d=8*albumPage,u=Math.min(d+8,n);let y=r.slice(d,u);if(y.length<8&&(y=y.concat(Array(8-y.length).fill(null))),"search"!==currentMode&&1===y.filter(t=>t).length?albumsEl.classList.add("single-album"):albumsEl.classList.remove("single-album"),y.forEach(t=>{const e=document.createElement("div");if(!t)return e.className="card",e.style.visibility="hidden",void albumsEl.appendChild(e);const a=t.key||makeAlbumKey(t.catalogue,t.title,t.artist);t.key=a,e.className="card",e.dataset.albumKey=a,t._card=e;const l=Array.isArray(t.tracks)?t.tracks.filter(t=>hasValidMp3(t.mp3)&&t.hasValidAudio):[],r=t&&t.hasPlayable,i=void 0!==r?r:l.length>0;if(e.dataset.hasAudioCandidates=i?"true":"false",e.dataset.validTracks=r?"1":"0",e.dataset.pendingTracks=t._pendingValidation?"1":"0",i?(e.classList.remove("no-audio"),e.removeAttribute("title")):(e.classList.add("no-audio"),e.title="No playable audio available"),t._pendingValidation&&(e.classList.add("pending-audio"),e.title||(e.title="Validating audio availability…")),1===n&&prevSearch){const t=document.createElement("div");t.className="back-row";const a=document.createElement("button");a.type="button",a.className="btn small",a.textContent="explore"===prevSearch.type?"Back to explore results":"Back to search results",a.addEventListener("click",()=>restorePreviousSearch()),t.appendChild(a),e.appendChild(t)}if(t.picture){const a=`/api/container?u=${encodeURIComponent(t.picture)}`,l=document.createElement("div");l.className="cover-wrap";const r=document.createElement("img");r.src=a,r.alt="Cover",r.loading="lazy",r.onerror=()=>{l.remove()},l.appendChild(r),l.tabIndex=0,l.setAttribute("role","button");try{l.setAttribute("aria-label",`Open tracks for ${t.title}`)}catch{}const i=()=>{if(n>1){const e=t.title||"";searchEl&&(searchEl.value=e),run(e)}else openTracksModal(t,e)};l.addEventListener("click",i),l.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),i())}),e.appendChild(l)}const s=document.createElement("div");s.className="heading";const o=document.createElement("h3");if(o.textContent=t.title,s.appendChild(o),t.catalogue){const e=document.createElement("span");e.className="badge",e.textContent=t.catalogue,s.appendChild(e)}if(t._noAudio){const t=document.createElement("span");t.className="badge badge-warning",t.textContent="No Audio",t.title="This album does not have playable audio files",s.appendChild(t)}e.appendChild(s);const c=document.createElement("div");c.className="muted",c.textContent=t.artist,e.appendChild(c);const d=document.createElement("button");d.className="btn small",d.textContent=`Show Tracks (${t.tracks.length})`,d.addEventListener("click",()=>openTracksModal(t,e)),e.appendChild(d),albumsEl.appendChild(e),updateAlbumCardState(t)}),shouldScrollAlbums&&"search"===currentMode)if(albumsEl){const t=albumsEl.firstElementChild||albumsEl;if(t&&"function"==typeof t.scrollIntoView){shouldScrollAlbums=!1;try{t.scrollIntoView({block:"start",behavior:"smooth"})}catch{t.scrollIntoView()}}else if("undefined"!=typeof window){shouldScrollAlbums=!1;try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}}else shouldScrollAlbums=!1}function updateProgressUI(){if(!currentRow)return;const t=currentRow._seek,e=currentRow._time;if(!t||!e)return;const a=player.duration,l=player.currentTime,r=a&&isFinite(a)?Math.min(100,Math.max(0,l/a*100)):0;currentRow&&currentRow._seeking||(t.value=String(r),t.style.setProperty("--fill",r+"%")),nowPlayingProgressFill&&(nowPlayingProgressFill.style.width=r+"%"),e.textContent=fmtTime(l)+" / "+fmtTime(a)}function handlePlay(t,e,a){if(!a)return;if(currentSrc===a&&!player.paused)return void player.pause();const l=currentSrc===a&&player.paused;currentSrc!==a&&(player.src=a),currentSrc=a,l||updateButtonsForStop(),setNowPlayingFromRow(e,!1),currentBtn=t,currentRow=e,currentRow&&(currentRow.classList.remove("playing"),currentRow.classList.add("loading")),t.disabled=!0,t.textContent=t.dataset.loadingLabel||"Loading…",t.dataset.playAria&&t.setAttribute("aria-label","Loading track…"),t.classList.add("btn-accent"),t.classList.remove("btn-error"),player.play().then(()=>{l||updateButtonsForStop(),currentBtn=t,currentRow=e,currentRow&&(currentRow.classList.remove("loading"),currentRow.classList.add("playing")),t.disabled=!1,t.textContent=t.dataset.pauseLabel||"⏸ Pause",t.dataset.pauseAria&&t.setAttribute("aria-label",t.dataset.pauseAria),t.classList.add("btn-accent"),updateProgressUI(),scheduleNextTrackPreload(currentRow),setNowPlayingFromRow(e,!0)}).catch(t=>{console.warn("Playback error:",t);try{player.removeAttribute("src"),player.load()}catch{}currentSrc="",updateButtonsForStop(),markNowPlayingInactive()})}function updateButtonsForStop(){if(currentRow&&(currentRow.classList.remove("playing"),currentRow.classList.remove("loading")),currentBtn){currentBtn.disabled=!1;const t=currentBtn.dataset?.playLabel||"▶ Play";currentBtn.textContent=t,currentBtn.dataset?.playAria&&currentBtn.setAttribute("aria-label",currentBtn.dataset.playAria),currentBtn.classList.remove("btn-accent")}currentBtn=null,currentRow=null,markNowPlayingInactive(),nowPlayingProgressFill&&(nowPlayingProgressFill.style.width="0%")}function playNextTrackFromPlaylistMeta(t){if(!t||!t.playlistId)return!1;const e=playlists.find(e=>e&&e.id===t.playlistId);if(!e)return!1;const a=Array.isArray(e.tracks)?e.tracks:[];if(!a.length)return!1;let l=null;for(let e=a.findIndex(e=>!!e&&(!(!t.playlistTrackId||e.id!==t.playlistTrackId)||!(!t.trackRecordId||e.trackRecordId!==t.trackRecordId)))+1;e<a.length;e++){const t=a[e];if(!t)continue;if(canValidateAudioSrc(resolvePlayableSrc(t.resolvedSrc||t.mp3||""))){l=t;break}}if(!l)return!1;if(activePlaylistId!==e.id?(activePlaylistId=e.id,renderPlaylistsPanel()):playlistTracksList&&playlistTracksList.children.length||renderPlaylistTracks(),!playlistTracksList)return!1;const r=[];l.id&&r.push('[data-track-id="'+l.id+'"]'),l.trackRecordId&&r.push('[data-track-id="'+l.trackRecordId+'"]');let n=null;for(const t of r)if(n=playlistTracksList.querySelector(t),n)break;if(!n)for(n=playlistTracksList.querySelector(".playlist-track");n&&!n._src;)n=findNextPlayableRow(n);return!!(n&&n._btn&&n._src)&&(handlePlay(n._btn,n,n._src),!0)}function playNextPlayableFrom(t){if(!t)return!1;let e=findNextPlayableRow(t);for(;e&&!e._src;)e=findNextPlayableRow(e);return!!(e&&e._btn&&e._src)&&(handlePlay(e._btn,e,e._src),!0)}async function loadMore(t){showBusy("Loading more…");try{if(rawItems.length>=rawTotalFound)return!1;const e=new URLSearchParams;t&&e.set("q",t),e.set("offset",rawNextOffset),e.set("limit",300);const a=await fetch(`/api/search?${e}`);if(!a.ok)throw new Error(await a.text().catch(()=>`HTTP ${a.status}`));const l=await a.json(),r=l.items||[];rawItems=rawItems.concat(r),rawTotalFound=Number(l.total||rawTotalFound);const n=Number(l.offset||0);return rawNextOffset=n+r.length,albumGroups=groupAlbums(rawItems),refreshPublicPlaylists(),r.length>0}finally{hideBusy()}}function shuffleInPlace(t){for(let e=t.length-1;e>0;e--){const a=Math.random()*(e+1)|0;[t[e],t[a]]=[t[a],t[e]]}}function closeExplorePanel(){explorePanel&&explorePanel.setAttribute("hidden",""),exploreEl&&exploreEl.setAttribute("aria-expanded","false")}function handleExploreSearch(t){if("string"!=typeof t||!t.trim())return;const e=t.trim();searchEl&&(searchEl.value=e),closeExplorePanel(),run(e)}function syncPublicFeaturedVisibility(){}async function runExplore(t){try{const t=document.querySelector(".content-column");t&&t.classList.add("exploring")}catch{}try{playlistColumn&&(playlistColumn.hidden=!Boolean(currentUser))}catch{}const e=isRestoring;if(!isRestoring)if(albumGroups.length||rawItems.length){const e=snapshotState();prevSearch={type:e.mode||currentMode,start:t,snapshot:e}}else prevSearch=null;showBusy(`Loading ${t}s…`),hideLanding(),closeExplorePanel();const a=Number(t)||0;if(!a)return void(e&&(isRestoring=!1));const l=a+9,r=new URLSearchParams;r.set("start",String(a)),r.set("end",String(l)),r.set("limit","150");try{const t=await fetch(`/api/explore?${r}`);if(!t.ok)return errorEl.hidden=!1,void(errorEl.textContent="Explore error: "+await t.text());const e=await t.json();if(!e||!Array.isArray(e.items)||0===e.items.length)return errorEl.hidden=!1,errorEl.textContent=`No albums found for the ${a}s.`,rawItems=[],rawTotalFound=0,rawNextOffset=0,albumGroups=[],albumPage=0,activePublicPlaylist=null,refreshPublicPlaylists(),void renderAlbumPage();rawItems=e.items||[],rawTotalFound=Number(e.total||rawItems.length),rawNextOffset=0,activePublicPlaylist=null;const l=groupAlbums(rawItems);if(albumGroups=l,console.log(`[runExplore] Loaded ${albumGroups.length} unique albums from ${rawItems.length} tracks for ${a}s`),currentMode="explore",currentExploreDecade=a,!albumGroups.length)return errorEl.hidden=!1,errorEl.textContent=`No albums with complete audio and artwork found for the ${a}s.`,rawItems=[],rawTotalFound=0,refreshPublicPlaylists([]),void renderAlbumPage();shuffleInPlace(albumGroups),rawItems=albumGroups,rawTotalFound=albumGroups.length,albumPage=0,refreshPublicPlaylists(l),renderAlbumPage()}finally{hideBusy(),e&&(isRestoring=!1)}}if(modalClose.addEventListener("click",closeTracksModal),overlay.addEventListener("click",t=>{t.target===overlay&&closeTracksModal()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&(overlay.classList.contains("open")?closeTracksModal():authOverlay&&!authOverlay.hidden&&closeAuth())}),trackInfoOverlay.addEventListener("click",t=>{t.target===trackInfoOverlay&&closeTrackInfoModal()}),trackInfoClose.addEventListener("click",()=>closeTrackInfoModal()),authOverlay&&authOverlay.addEventListener("click",t=>{t.target===authOverlay&&closeAuth()}),authClose&&authClose.addEventListener("click",()=>closeAuth()),shareModalClose&&shareModalClose.addEventListener("click",()=>closeShareModal()),shareModal&&shareModal.addEventListener("click",t=>{t.target===shareModal&&closeShareModal()}),authForm&&authForm.addEventListener("submit",submitAuthForm),authSwitch&&authSwitch.addEventListener("click",()=>{setAuthMode("login"===authMode?"register":"login"),queueTask(()=>authEmail?.focus())}),loginTrigger&&loginTrigger.addEventListener("click",()=>openAuth("login",loginTrigger)),signupTrigger&&signupTrigger.addEventListener("click",()=>openAuth("register",signupTrigger)),logoutButton&&logoutButton.addEventListener("click",performLogout),playlistCreateForm&&playlistCreateForm.addEventListener("submit",async t=>{if(t.preventDefault(),!currentUser)return void openAuth("login",playlistCreateForm.querySelector("button"));const e=(playlistNameInput?.value||"").trim();if(e)try{const t=await createPlaylistOnServer(e);playlistNameInput&&(playlistNameInput.value=""),t?.id&&setActivePlaylist(t.id)}catch(t){window.alert(t?.message||"Unable to create playlist")}}),deletePlaylistButton&&deletePlaylistButton.addEventListener("click",()=>{deletePlaylistButton.disabled||deleteActivePlaylist()}),sharePlaylistButton&&sharePlaylistButton.addEventListener("click",()=>{sharePlaylistButton.disabled||copyActivePlaylistShareLink()}),shareLinkOutput&&shareLinkOutput.addEventListener("click",async()=>{const t=(shareLinkOutput.dataset.url||"").trim();if(!t)return;await copyTextToClipboard(t)?window.alert("Share link copied to your clipboard."):window.alert(`Share link:\n${t}`)}),sharedPlaylistBackButton&&sharedPlaylistBackButton.addEventListener("click",()=>{clearShareQueryParam(),clearSharedPlaylistState({restoreLanding:!0}),showLanding()}),sharedPlaylistCopyButton&&sharedPlaylistCopyButton.addEventListener("click",()=>{if(sharedPlaylistCopyButton.disabled)return;const t=sharedPlaylistShareUrl||buildShareUrlFallback(activeSharedShareId);t?showShareModal(t):window.alert("No share link available")}),togglePlaylistTracksButton&&togglePlaylistTracksButton.addEventListener("click",()=>{playlistTracksCollapsed=!playlistTracksCollapsed,playlistTracksCollapsed&&playlistTracksSection&&playlistTracksSection.classList.remove("only-current"),renderPlaylistTracks()}),nowPlayingCollapseButton&&nowPlayingCollapseButton.addEventListener("click",()=>{nowPlayingCollapsed=!nowPlayingCollapsed,updateNowPlayingUI()}),nowPlayingToggleButton&&nowPlayingToggleButton.addEventListener("click",()=>{if(!nowPlayingInfo.meta)return;const t=nowPlayingInfo.meta;if(player.paused){if(!currentRow&&t.playlistId&&t.playlistTrackId&&playlistTracksList){const e=playlistTracksList.querySelector(`[data-track-id="${t.playlistTrackId}"]`);e&&(currentRow=e,currentBtn=e._btn||null)}t.src&&player.src!==t.src&&(player.src=t.src,currentSrc=t.src),player.play().then(()=>{if(currentRow){if(setNowPlayingFromRow(currentRow,!0),currentRow._btn){currentBtn=currentRow._btn,currentBtn.disabled=!1;const t=currentBtn.dataset?.pauseLabel||"⏸ Pause";currentBtn.textContent=t,currentBtn.dataset?.pauseAria&&currentBtn.setAttribute("aria-label",currentBtn.dataset.pauseAria),currentBtn.classList.add("btn-accent")}currentRow.classList.remove("loading"),currentRow.classList.add("playing"),updateProgressUI()}else setNowPlayingFromRow({_meta:t,_src:t.src},!0)}).catch(t=>{console.warn("Resume playback failed:",t),window.alert("Unable to resume playback.")})}else player.pause()}),setAuthMode("login"),updateAuthUI(),refreshCurrentUser(),loadPublicPlaylistSummaries(),player.addEventListener("seeking",()=>{seekStartPosition=Number.isFinite(player.currentTime)?player.currentTime:seekStartPosition}),player.addEventListener("seeked",()=>{const t=Number.isFinite(player.currentTime)?player.currentTime:0,e=Math.abs(t-seekStartPosition);sendStreamEvent("SEEK",getCurrentTrackMeta(),t,player.duration,e)}),player.addEventListener("ended",()=>{const t=getCurrentTrackMeta(),e=Number.isFinite(player.duration)?player.duration:0,a=Number.isFinite(player.currentTime)?player.currentTime:e,l=e||a;sendStreamEvent("END",t,l,e||l,Math.abs((l||0)-lastStreamReportPos));const r=currentRow?findNextPlayableRow(currentRow):null;if(r&&r._btn&&r._src)handlePlay(r._btn,r,r._src);else{if(!r&&nowPlayingInfo.meta?.playlistId&&playlistTracksList){const t=nowPlayingInfo.meta.playlistTrackId?`[data-track-id="${nowPlayingInfo.meta.playlistTrackId}"]`:null;let e=t?playlistTracksList.querySelector(t):null;if(!e&&currentRow&&currentRow._playlist===nowPlayingInfo.meta.playlistId&&(e=currentRow),!e){e=playlistTracksList.querySelector(".playlist-track")||null}if(e){let t=findNextPlayableRow(e);for(;t&&!t._src;)t=findNextPlayableRow(t);if(t&&t._btn&&t._src)return void handlePlay(t._btn,t,t._src)}}playNextTrackFromPlaylistMeta(nowPlayingInfo.meta)||(updateButtonsForStop(),currentSrc="",updateProgressUI(),markNowPlayingInactive(),nowPlayingProgressFill&&(nowPlayingProgressFill.style.width="0%"))}}),player.addEventListener("timeupdate",()=>{updateProgressUI();const t=Date.now();(!lastProgressAttemptTs||t-lastProgressAttemptTs>=3e4)&&(lastProgressAttemptTs=t,sendStreamEvent("PROGRESS",getCurrentTrackMeta()))}),player.addEventListener("loadedmetadata",()=>{updateProgressUI()}),player.addEventListener("pause",()=>{if(player.ended||sendStreamEvent("PAUSE",getCurrentTrackMeta(),player.currentTime,player.duration),currentBtn&&currentSrc===player.src){const t=currentBtn.dataset?.playLabel||"▶ Play";currentBtn.textContent=t,currentBtn.dataset?.playAria&&currentBtn.setAttribute("aria-label",currentBtn.dataset.playAria),currentBtn.classList.remove("btn-accent"),currentRow&&currentRow.classList.remove("playing")}currentRow?setNowPlayingFromRow(currentRow,!1):markNowPlayingInactive()}),player.addEventListener("play",()=>{if(sendStreamEvent("PLAY",getCurrentTrackMeta(),player.currentTime,player.duration),currentBtn&&currentSrc===player.src){const t=currentBtn.dataset?.pauseLabel||"⏸ Pause";currentBtn.textContent=t,currentBtn.dataset?.pauseAria&&currentBtn.setAttribute("aria-label",currentBtn.dataset.pauseAria),currentBtn.classList.add("btn-accent"),currentRow&&currentRow.classList.add("playing")}currentRow&&setNowPlayingFromRow(currentRow,!0)}),player.addEventListener("error",()=>{sendStreamEvent("ERROR",getCurrentTrackMeta(),player.currentTime,player.duration);const t=player.error;t?console.warn("[MASS] Audio element error",{code:t.code,message:t.message}):console.warn("[MASS] Audio element encountered an unknown error")}),exploreDecadesEl){const t=[1950,1960,1970,1980,1990,2e3,2010,2020];exploreDecadesEl.innerHTML="";for(const e of t){const t=document.createElement("button");t.textContent=e+"s",t.addEventListener("click",()=>runExplore(e)),exploreDecadesEl.appendChild(t)}}if(exploreGenresEl){const t=["Marabi","Maskandi","Kwela","Mbaqanga","Country","Pop","Rock","Afro Rock","Afro Pop"];exploreGenresEl.innerHTML="";for(const e of t){const t=document.createElement("button");t.textContent=e,t.addEventListener("click",()=>handleExploreSearch(e)),exploreGenresEl.appendChild(t)}}if(exploreMoodsEl){const t=["Happy","Romantic","RoadTrip","Sunset"];exploreMoodsEl.innerHTML="";for(const e of t){const t=document.createElement("button");t.textContent=e,t.addEventListener("click",()=>handleExploreSearch(e)),exploreMoodsEl.appendChild(t)}}function run(t){try{const t=document.querySelector(".content-column");t&&t.classList.remove("exploring")}catch{}try{playlistColumn&&playlistColumn.setAttribute("hidden","")}catch{}if(!t)return showLanding(),void(isRestoring&&(isRestoring=!1));sharedPlaylistActive&&clearSharedPlaylistState();const e=isRestoring;if(!isRestoring){if(albumGroups.length||rawItems.length){const t=lastQ,e=snapshotState({lastQ:t,searchValue:t});prevSearch={type:e.mode||currentMode,term:t,snapshot:e}}else prevSearch=null}lastQ=t,albumsEl.classList.remove("single-album"),hideLanding(),shouldScrollAlbums=!0,showBusy("Searching…"),doSearch(t).then(e=>{rawItems=e?.items||[],rawTotalFound=Number(e?.total||rawItems.length),rawNextOffset=Number(e?.offset||0)+rawItems.length,activePublicPlaylist=null,currentMode="search",currentExploreDecade=null,albumGroups=groupAlbums(rawItems),console.log(`[search] Found ${albumGroups.length} unique albums from ${rawItems.length} tracks (query: "${t}")`),refreshPublicPlaylists(),albumPage=0,renderAlbumPage()}).catch(t=>{"AbortError"!==t.name&&(errorEl.hidden=!1,errorEl.textContent=`Search error: ${t.message||t}`)}).finally(()=>{hideBusy(),e&&(isRestoring=!1)})}exploreEl&&explorePanel&&(exploreEl.setAttribute("aria-expanded",explorePanel.hasAttribute("hidden")?"false":"true"),exploreEl.addEventListener("click",()=>{explorePanel.hasAttribute("hidden")?(explorePanel.removeAttribute("hidden"),exploreEl.setAttribute("aria-expanded","true")):closeExplorePanel()})),goEl.addEventListener("click",()=>{run(searchEl.value.trim())}),searchEl&&searchEl.addEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),goEl.click())}),clearEl.addEventListener("click",()=>{searchEl.value="",loadRandomSongs()}),shuffleBtn&&shuffleBtn.addEventListener("click",()=>{null!==currentExploreDecade?runExplore(currentExploreDecade):"songs"===currentMode?loadRandomSongs():loadRandomAlbums()}),prevEl.addEventListener("click",()=>{albumPage>0&&(albumPage--,shouldScrollAlbums=!0,renderAlbumPage())}),nextEl.addEventListener("click",async()=>{const t=Math.max(1,Math.ceil((albumGroups.length||0)/8));if(albumPage>=t-1&&rawItems.length<rawTotalFound){nextEl.disabled=!0;try{await loadMore(lastQ)}finally{nextEl.disabled=!1}}const e=Math.max(1,Math.ceil((albumGroups.length||0)/8));albumPage<e-1&&albumPage++,shouldScrollAlbums=!0,renderAlbumPage()}),window.addEventListener("popstate",()=>{const t=getShareIdFromLocation();t?activateSharedPlaylist(t,{updateUrl:!1}):sharedPlaylistActive&&(clearSharedPlaylistState({restoreLanding:!0}),loadRandomAlbums())}),requestAnimationFrame(()=>{const t=getShareIdFromLocation();t?activateSharedPlaylist(t,{updateUrl:!1}):loadRandomSongs()});