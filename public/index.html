<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Resource hints for better performance -->
  <link rel="dns-prefetch" href="/">
  <link rel="preload" href="/app.min.js?v=84&t=1733401000" as="script">
  <title>MAD JUKEBOX - Bakelite Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ðŸŽµ RETRO JUKEBOX THEME - 1950s Bakelite Style ðŸŽµ */
    :root {
      /* Bakelite Jukebox Color Palette */
      --bg: #f5f1e8;
      --bg-solid: #f5f1e8;
      --bakelite-cream: #f5f1e8;
      --bakelite-aged: #e8e0d0;
      --bakelite-shadow: #d4c8b0;
      --fg: #2a1810;
      --muted: #6b5d4f;
      --card: linear-gradient(135deg, #faf7f0 0%, #f0ebe0 100%);
      --card-solid: #faf7f0;
      --accent: #ff3366;
      --accent-glow: #ffcc00;
      --chrome: linear-gradient(180deg, #e8e8e8 0%, #b8b8b8 45%, #9a9a9a 50%, #c8c8c8 55%, #f0f0f0 100%);
      --border: #c8b89a;
      --neon-red: #ff0844;
      --neon-yellow: #ffea00;
      --neon-blue: #00d4ff;
      --neon-green: #39ff14;
      --overlay: rgba(245, 241, 232, 0.95);
      --cover-size: 180px;
      --btn-gradient-start: #ff3366;
      --btn-gradient-end: #ffcc00;
      --btn-text: #1a0507;
      --btn-shadow: rgba(255, 51, 102, 0.6);
      --btn-shadow-hover: rgba(255, 51, 102, 0.9);
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bakelite-cream);
      background-image:
        /* Subtle grain texture */
        repeating-linear-gradient(90deg, transparent 0px, rgba(0,0,0,0.02) 1px, transparent 2px),
        repeating-linear-gradient(0deg, transparent 0px, rgba(0,0,0,0.02) 1px, transparent 2px),
        /* Aged yellowing gradient */
        radial-gradient(ellipse at top left, rgba(255, 248, 220, 0.3), transparent 60%),
        radial-gradient(ellipse at bottom right, rgba(240, 230, 200, 0.4), transparent 60%),
        var(--bakelite-cream);
      background-attachment: fixed;
      color: var(--fg);
      font-family: 'Trebuchet MS', 'Arial Rounded MT Bold', Impact, system-ui, sans-serif;
      position: relative;
    }

    /* Bakelite texture overlay with scratches and wear */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        /* Random scratches - diagonal */
        linear-gradient(125deg, transparent 0%, transparent 48%, rgba(0,0,0,0.03) 49%, transparent 50%),
        linear-gradient(135deg, transparent 0%, transparent 68%, rgba(0,0,0,0.02) 69%, transparent 70%),
        linear-gradient(155deg, transparent 0%, transparent 28%, rgba(0,0,0,0.025) 29%, transparent 30%),
        /* Worn spots */
        radial-gradient(circle at 15% 25%, rgba(210, 200, 180, 0.2), transparent 15%),
        radial-gradient(circle at 85% 70%, rgba(220, 210, 190, 0.15), transparent 12%),
        radial-gradient(circle at 45% 85%, rgba(215, 205, 185, 0.18), transparent 10%),
        /* Subtle discoloration */
        radial-gradient(ellipse at 70% 30%, rgba(240, 235, 210, 0.3), transparent 40%),
        radial-gradient(ellipse at 30% 80%, rgba(235, 228, 200, 0.25), transparent 35%),
        /* Fine texture */
        repeating-radial-gradient(circle at 50% 50%, transparent 0px, rgba(0,0,0,0.01) 1px, transparent 2px);
      pointer-events: none;
      z-index: 0;
      opacity: 0.8;
    }


    /* Subtle aging animation */
    @keyframes bakeliteAging {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 0.85; }
    }

    body::before {
      animation: bakeliteAging 15s ease-in-out infinite;
    }
    header {
      padding: 16px 20px;
      border-bottom: 4px solid;
      border-image: var(--chrome) 1;
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, rgba(250, 247, 240, 0.98) 0%, rgba(240, 235, 224, 0.95) 100%);
      z-index: 10;
      box-shadow:
        0 4px 20px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.6),
        inset 0 -1px 0 rgba(200, 184, 154, 0.4);
    }

    @media (min-width: 768px) {
      header {
        backdrop-filter: saturate(180%) blur(12px);
      }
    }
    .header-main{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;justify-content:space-between;flex-wrap:wrap;}
    .header-logo{flex-shrink:0;max-height:60px;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.25));}
    .searchbar{flex:1 1 600px;display:flex;gap:8px;align-items:center;min-width:300px;flex-wrap:wrap;}
    .search-fields{display:flex;gap:8px;flex:1 1 auto;min-width:300px;}
    .search-fields[hidden]{display:none !important;}
    .search-fields input{flex:1 1 120px;min-width:120px;}
    .searchbar input {
      background: var(--card-solid);
      background-image: var(--card);
      color: var(--fg);
      border: 3px solid var(--border);
      border-radius: 20px;
      padding: 12px 18px;
      font-size: 16px;
      font-weight: 600;
      outline: none;
      transition: all 0.3s ease;
      box-shadow:
        inset 0 2px 8px rgba(0, 0, 0, 0.6),
        0 0 10px rgba(255, 51, 102, 0.2);
    }

    .searchbar input:focus {
      border-color: var(--neon-yellow);
      box-shadow:
        0 0 20px var(--neon-yellow),
        0 0 40px rgba(255, 234, 0, 0.3),
        inset 0 2px 8px rgba(0, 0, 0, 0.6);
      color: var(--neon-yellow);
    }
    .searchbar button{border-radius:8px;padding:8px 14px;font-weight:600;cursor:pointer;font-size:13px;white-space:nowrap;flex-shrink:0;}
    .searchbar{position:relative;}
    .header-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;flex-shrink:0;}
    .ai-search-panel{position:relative;flex:0 0 auto;margin-top:0;}
    .ai-search-toggle{display:flex;align-items:center;gap:6px;padding:7px 12px;border:1px solid rgba(255,255,255,0.2);border-radius:999px;background:transparent;color:var(--fg);font-size:12px;font-weight:600;cursor:pointer;transition:border-color 0.2s ease,color 0.2s ease;}
    .ai-search-toggle:hover{border-color:var(--accent);color:var(--accent);}
    .ai-search-toggle strong{display:inline;font-size:12px;font-weight:600;}
    .ai-search-toggle span{display:none;}
    .ai-search-chevron{font-size:12px;color:var(--muted);transition:transform 0.2s ease;}
    .ai-search-panel[data-collapsed="true"] .ai-search-body{display:none;}
    .ai-search-panel[data-collapsed="false"] .ai-search-chevron{transform:rotate(90deg);}
    .ai-search-panel[data-collapsed="false"] .ai-search-toggle span{display:inline;color:var(--muted);font-size:11px;}
    .ai-search-body{position:absolute;top:calc(100% + 8px);right:0;z-index:15;width:min(420px,calc(100vw - 48px));background:rgba(10,14,20,0.95);border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px;box-shadow:0 10px 30px rgba(0,0,0,0.4);}
    .ai-search-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .ai-search-row input{flex:1;min-width:200px;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:999px;padding:10px 16px;font-size:15px;}
    .ai-search-row input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(98,245,169,0.15);}
    .ai-search-row button{height:40px;padding:0 18px;border-radius:999px;}
    .ai-search-status{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);}
    .ai-search-status[hidden]{display:none;}
    .ai-search-status .pulse{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 0 rgba(98,245,169,.6);animation:pulse 1.6s infinite;}
    .ai-search-interpretation{font-size:12px;color:var(--fg);background:rgba(98,245,169,0.05);border:1px solid rgba(98,245,169,0.2);padding:8px 12px;border-radius:10px;}
    .ai-search-interpretation[hidden]{display:none;}

    main{max-width:1100px;margin:20px auto;padding:0 16px 40px;position:relative;z-index:1;}
    .layout-grid{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;}
    .playlist-column{flex:0 0 260px;max-width:260px;width:100%;display:flex;flex-direction:column;gap:14px;position:relative;order:2;}
    .playlist-column[hidden]{display:none !important;}
    .content-column{flex:1 1 560px;min-width:260px;display:flex;flex-direction:column;gap:16px;width:100%;order:1;}

    /* Explore layout: place Featured Playlists below the albums grid */
    .content-column.exploring{
      display:flex;
      flex-direction:column;
    }
    .content-column.exploring #albums{ order: 10; }
    .content-column.exploring #publicFeaturedRow{ order: 20; }


    .public-playlists{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:12px;}
    .public-playlists .playlists-header{display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .public-playlists-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px;}
    .public-playlist-item button{width:100%;text-align:left;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;color:var(--fg);font-size:16px;display:flex;align-items:flex-start;gap:12px;cursor:pointer;transition:background .15s ease,border-color .15s ease;}
    .public-playlist-item button:hover{background:var(--border);}
    .public-playlist-item button.active{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent);background:rgba(98,245,169,0.15);}
    .public-playlist-count{color:var(--muted);font-size:14px;font-weight:500;line-height:1.4;}
    .public-featured-row{display:flex;align-items:flex-start;gap:18px;width:100%;margin-bottom:16px;}
    .public-featured-row > .public-playlists{flex:0 0 220px;max-width:240px;}
    .public-playlist-view{display:flex;flex-direction:column;gap:12px;border:1px solid var(--border);border-radius:14px;background:var(--card);padding:12px;flex:1;min-width:0;}
    .public-playlist-view[hidden]{display:none !important;}
    .public-playlist-header{display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .public-playlist-title{margin:0;font-size:18px;}
    .public-playlist-status{color:var(--muted);font-size:13px;}
    .public-playlist-tracks{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px;overflow-y:auto;max-height:none;}
    .public-playlist-tracks::-webkit-scrollbar{width:8px;}
    .public-playlist-tracks::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:999px;}
    .public-playlist-track .track-name-title{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .public-playlist-track .track-name-artist{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .public-playlist-thumb{width:70px;height:70px;border-radius:12px;background:#101215 center/cover no-repeat;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:28px;overflow:hidden;transition:background .2s ease, color .2s ease;}
    .public-playlist-thumb.has-art{color:transparent;}
    .public-playlist-label{display:flex;flex-direction:column;align-items:flex-start;gap:4px;flex:1;min-width:0;}
    .public-playlist-name{font-weight:600;font-size:16px;line-height:1.35;word-break:break-word;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
    .public-playlist-count{color:var(--muted);font-size:14px;font-weight:500;line-height:1.4;white-space:normal;}
    .public-playlist-hero{border-radius:16px;overflow:hidden;background:#11141a;display:flex;align-items:center;justify-content:center;padding:12px;}
    .public-playlist-hero[hidden]{display:none;}
    .public-playlist-hero img{display:block;width:60%;height:auto;max-height:240px;object-fit:contain;}
    .public-playlist-main{flex:1;display:flex;flex-direction:column;gap:12px;}
    .playlist-actions{display:flex;align-items:center;gap:6px;}
    .playlist-footer-actions{margin-top:12px;display:flex;justify-content:flex-end;gap:8px;}
    .playlist-footer-actions .btn{min-width:70px;}
    .shared-playlist-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;flex-wrap:wrap;}
    .shared-playlist-actions .btn{min-width:140px;}
    .share-link-display{display:none !important;}
    @media (max-width:900px){
      .layout-grid{flex-direction:column;}
      .playlist-column{max-width:100%;order:initial;}
      .content-column{order:initial;}
      .public-playlist-view{width:100%;max-width:none;}
      .public-featured-row{flex-direction:column;}
      .public-featured-row > .public-playlists{width:100%;max-width:none;}
      .header-main{flex-direction:column;align-items:stretch;gap:12px;}
      .searchbar{min-width:100%;flex-wrap:wrap;gap:6px;}
      .search-fields{flex-direction:column;gap:6px;width:100%;min-width:100%;}
      .search-fields input{min-width:100%;}
      .searchbar button{flex:1 1 auto;min-width:100px;}
      .header-actions{width:100%;justify-content:space-between;}
      .ai-search-body{width:100%;right:auto;left:0;padding:12px;}
      .ai-search-row{flex-direction:column;align-items:stretch;}
      .ai-search-row button{width:100%;}
      .view-buttons{bottom:100px;right:10px;gap:8px;}
      .view-buttons a{padding:6px 12px;font-size:12px;}
    }
    .albums{display:grid;grid-template-columns:repeat(4,196px);grid-template-rows:repeat(auto-fit,196px);gap:16px;scroll-margin-top:128px;justify-content:start;width:fit-content;}
    /* Featured albums mode: 3-column grid */
    .albums[data-mode="featured"]{grid-template-columns:repeat(3,224px);grid-template-rows:repeat(auto-fit,224px);gap:20px;}
    .albums.single-album{display:flex;flex-direction:column;align-items:flex-start;gap:6px;max-width:190px;}
    .card {
      background: var(--card-solid);
      background-image:
        /* Subtle bakelite grain */
        repeating-linear-gradient(90deg, transparent 0px, rgba(0,0,0,0.01) 1px, transparent 2px),
        /* Age spots */
        radial-gradient(circle at 20% 30%, rgba(235, 228, 210, 0.3), transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(240, 235, 220, 0.2), transparent 30%),
        var(--card);
      border: 5px solid;
      border-image: var(--chrome) 1;
      border-radius: 8px;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0;
      overflow: hidden;
      scroll-margin-top: 128px;
      width: 196px;
      height: 196px;
      box-shadow:
        0 8px 24px rgba(0, 0, 0, 0.15),
        0 4px 12px rgba(0, 0, 0, 0.1),
        inset 0 2px 4px rgba(255, 255, 255, 0.4),
        inset 0 -2px 4px rgba(200, 184, 154, 0.3);
      position: relative;
      transition: all 0.3s ease;
    }

    .card::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, var(--neon-red), var(--neon-yellow), var(--neon-blue), var(--neon-red));
      border-radius: 24px;
      z-index: -1;
      opacity: 0;
      animation: neonRotate 3s linear infinite;
      transition: opacity 0.3s ease;
    }

    .card:hover::before {
      opacity: 0.6;
    }

    .card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow:
        0 0 50px rgba(255, 51, 102, 0.7),
        0 0 80px rgba(255, 204, 0, 0.4),
        inset 0 2px 4px rgba(255, 204, 0, 0.3),
        inset 0 -2px 4px rgba(255, 51, 102, 0.3);
    }

    @keyframes neonRotate {
      0% { filter: hue-rotate(0deg); }
      100% { filter: hue-rotate(360deg); }
    }
    .card-buttons{
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      flex-direction: row;
      gap: 0;
      z-index: 2;
    }
    .card-buttons .btn {
      flex: 1;
      border-radius: 0;
      padding: 8px;
      font-size: 9px;
      border: none;
      border-top: 2px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
    }
    .card-buttons .btn:hover {
      background: rgba(255, 51, 102, 0.3);
      border-top-color: var(--neon-red);
    }
    .card .play-button {
      border-radius: 50px;
      padding: 14px 20px;
      cursor: pointer;
      font-weight: 900;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 2px;
      background: linear-gradient(135deg, var(--neon-red) 0%, var(--neon-yellow) 100%);
      border: 3px solid var(--neon-yellow);
      color: #1a0507;
      width: 100%;
      box-shadow:
        0 0 20px var(--neon-red),
        0 0 40px var(--neon-yellow),
        inset 0 2px 4px rgba(255, 255, 255, 0.5);
      text-shadow:
        0 1px 2px rgba(0, 0, 0, 0.5),
        0 0 10px rgba(255, 255, 255, 0.8);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card .play-button::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transform: rotate(45deg);
      animation: buttonShine 3s linear infinite;
    }

    @keyframes buttonShine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .card .play-button:hover {
      transform: scale(1.05);
      box-shadow:
        0 0 30px var(--neon-red),
        0 0 60px var(--neon-yellow),
        0 0 90px var(--neon-red),
        inset 0 2px 4px rgba(255, 255, 255, 0.7);
      border-color: var(--neon-red);
    }

    .card .play-button:active {
      transform: scale(0.98);
    }
    .card .btn.secondary.small{font-size:12px;padding:6px 10px;}
    .card.pending-audio{opacity:0.8;}
    .card.no-audio{display:none !important;}

    /* Subscription Toast Notification */
    .subscription-toast{position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg, #62f5a9 0%, #4ecf94 100%);color:#000;padding:20px 24px;border-radius:12px;box-shadow:0 8px 24px rgba(98,245,169,0.4);z-index:10000;font-weight:600;font-size:15px;opacity:0;transform:translateX(400px);transition:all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);max-width:320px;}
    .subscription-toast.show{opacity:1;transform:translateX(0);}
    .subscription-toast-close{position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.1);border:none;color:#000;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:16px;line-height:1;display:flex;align-items:center;justify-content:center;}
    .subscription-toast-close:hover{background:rgba(0,0,0,0.2);}

    /* Missing Audio Mode - Secret feature for operators */
    body.missing-audio-mode .missing-mode-banner{display:block !important;}
    .missing-mode-banner{display:none;position:fixed;top:0;left:0;right:0;background:#ff4444;color:#fff;text-align:center;padding:12px;font-weight:700;z-index:9999;box-shadow:0 2px 8px rgba(255,68,68,0.5);}

    /* Cover: Square Vinyl Album Style */
    .cover-wrap {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .cover-wrap:hover {
      filter: brightness(1.1);
    }

    /* Now Playing - video fills entire card when playing */
    .now-playing {
      position: relative;
      overflow: hidden;
      margin-left: -15%;
    }

    .now-playing-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.5s ease;
      z-index: 0;
      border-radius: 20px;
    }

    .now-playing.playing .now-playing-video {
      opacity: 0.6;
    }

    .now-playing-header,
    .now-playing-body,
    .now-playing-controls,
    .now-playing-progress {
      position: relative;
      z-index: 1;
    }

    /* White text with black shadow for readability over video */
    .now-playing.playing,
    .now-playing.playing * {
      color: white !important;
      text-shadow:
        0 1px 2px rgba(0, 0, 0, 0.8),
        0 2px 4px rgba(0, 0, 0, 0.6),
        0 0 8px rgba(0, 0, 0, 0.4);
    }

    .now-playing-thumb-content img {
      border-radius: 50%;
    }


    .cover-wrap img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      z-index: 0;
      image-rendering: high-quality;
      image-rendering: -webkit-optimize-contrast;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      transform: translateZ(0);
      filter: none;
    }

    .heading {
      position: absolute;
      bottom: 27px;
      left: 0;
      right: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 8px;
      background: none;
      text-align: center;
      z-index: 2;
    }

    .card h3 {
      margin: 0;
      font-size: 10px;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--neon-yellow);
      text-shadow:
        -1px -1px 0 #000,
        1px -1px 0 #000,
        -1px 1px 0 #000,
        1px 1px 0 #000,
        0 0 10px rgba(255, 234, 0, 0.8),
        0 0 20px rgba(255, 234, 0, 0.5);
      font-family: Impact, 'Arial Black', sans-serif;
    }

    .card-artist {
      color: var(--neon-red);
      font-size: 13px;
      margin-top: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      font-weight: 900;
      letter-spacing: 1px;
      text-transform: uppercase;
      text-shadow:
        -2px -2px 0 #000,
        2px -2px 0 #000,
        -2px 2px 0 #000,
        2px 2px 0 #000,
        0 0 15px rgba(255, 51, 102, 1),
        0 0 20px rgba(255, 51, 102, 0.8),
        0 0 25px rgba(255, 51, 102, 0.6);
      font-family: Impact, 'Arial Black', sans-serif;
    }

    .albums.single-album .card {
      width: 98px;
      height: 98px;
      border: 3px solid;
      border-radius: 4px;
    }
    .albums.single-album .card h3 {
      font-size: 6px;
      letter-spacing: 0.2px;
    }
    .albums.single-album .card-artist {
      font-size: 5px;
      letter-spacing: 0.1px;
    }
    .albums.single-album .heading {
      bottom: 17px;
      padding: 4px;
      gap: 1px;
    }
    .albums.single-album .card-buttons .btn {
      padding: 4px;
      font-size: 5px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .card-expand-btn {
      position: absolute;
      bottom: 3px;
      right: 3px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid var(--neon-yellow);
      color: var(--neon-yellow);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3;
      padding: 0;
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
      box-shadow: 0 0 10px rgba(255, 234, 0, 0.5);
    }
    .card-expand-btn:hover {
      background: rgba(255, 51, 102, 0.9);
      border-color: var(--neon-red);
      color: #fff;
      transform: scale(1.15);
      box-shadow: 0 0 15px rgba(255, 51, 102, 0.8);
    }
    .muted{color:var(--muted);font-size:11px;text-align:center;line-height:1.2;}
    .albums.single-album .muted{font-size:13px;}
    .badge{border:1px solid var(--border);border-radius:999px;padding:2px 6px;font-size:9px;color:var(--muted);}
    .badge-warning{background:rgba(255,193,7,0.15);border-color:rgba(255,193,7,0.4);color:#ffc107;}

    .btn{border-radius:10px;padding:8px 10px;cursor:pointer;font-weight:600;}
    .btn.small{padding:3px 4px;font-size:10px;}
    .btn.icon{width:34px;display:inline-flex;align-items:center;justify-content:center;}
    .btn-accent{filter:brightness(1.08);}
    .btn-error{background:#b9383a;border:none;color:#fff;box-shadow:0 6px 16px rgba(185,56,58,0.35);}
    .btn-error:hover{transform:none !important;box-shadow:0 6px 12px rgba(185,56,58,0.4) !important;}
    .btn-error:disabled{opacity:0.9;box-shadow:none;}
    .btn.info-more{font-size:18px;line-height:1;padding:4px 8px;display:flex;align-items:center;justify-content:center;}


    .back-row{display:flex;justify-content:center;margin-bottom:12px;}
.toolbar{display:none;}
    .pager{display:flex;align-items:center;justify-content:center;gap:12px;margin:20px 0;padding:12px;}
    .pager[hidden]{display:none !important;}
    .pager button{border-radius:10px;padding:10px 16px;cursor:pointer;font-weight:600;}
    .pager button:disabled{opacity:0.5;cursor:not-allowed;}
    .count{display:none;}
    .error{background:#2b1517;border:1px solid #5a2327;color:#ffb1b8;padding:10px 12px;border-radius:10px;}

    .explore-wrap{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;min-width:200px;}
    .explore-panel{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start;justify-content:flex-end;max-width:520px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;}
    .explore-panel[hidden]{display:none;}
    .explore-section{display:flex;flex-direction:column;gap:8px;min-width:160px;}
    .explore-section h3{margin:0;font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);}
    .explore-buttons{display:flex;flex-wrap:wrap;gap:8px;}
    .explore-buttons button{border-radius:999px;padding:5px 9px;cursor:pointer;font-size:12px;}
    #explore{padding:7px 12px;border-radius:8px;font-weight:600;font-size:12px;white-space:nowrap;}

    .auth-controls{display:flex;align-items:center;gap:6px;flex-wrap:wrap;justify-content:flex-end;}
    .auth-controls .badge{font-size:11px;padding:5px 9px;}
    .auth-controls .btn{padding:7px 12px;border-radius:8px;font-weight:600;font-size:12px;}
    .auth-controls [hidden]{display:none !important;}
    .auth-form{display:flex;flex-direction:column;gap:12px;margin-top:12px;}
    .auth-form label{display:flex;flex-direction:column;gap:6px;font-size:14px;}
    .auth-form input{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--fg);}
    .auth-switch{display:flex;align-items:center;gap:6px;margin-top:12px;font-size:13px;color:var(--muted);}
    .auth-switch button{background:none;border:none;color:var(--accent);cursor:pointer;font-weight:600;padding:0;}
    .auth-switch button:disabled{opacity:.6;cursor:not-allowed;}
    #authError{margin-top:12px;}

    .view-buttons{position:fixed;bottom:120px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:100;}
    .view-buttons a{border-radius:8px;padding:8px 14px;font-weight:600;cursor:pointer;font-size:13px;white-space:nowrap;text-decoration:none;background:transparent;border:1px solid var(--border);color:var(--fg);transition:all 0.2s ease;display:inline-block;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.3);backdrop-filter:blur(8px);}
    .view-buttons a:hover{border-color:var(--accent);color:var(--accent);transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,0.4);}
    .view-buttons .genre-note{font-size:11px;line-height:1.5;color:var(--muted);max-width:220px;background:rgba(0,0,0,0.35);padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(6px);}

    .playlists-panel {
      padding: 16px;
      border: 4px solid;
      border-image: var(--chrome) 1;
      border-radius: 20px;
      background: var(--card-solid);
      background-image: var(--card);
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow:
        0 0 20px rgba(255, 51, 102, 0.3),
        inset 0 2px 4px rgba(255, 204, 0, 0.1);
    }
    .playlists-panel[hidden]{display:none;}
    .playlists-header{display:flex;align-items:center;gap:12px;justify-content:space-between;cursor:pointer;user-select:none;}
    .playlists-header:hover h2{color:var(--accent);}
    .playlists-header h2{margin:0;font-size:14px;letter-spacing:.02em;text-transform:uppercase;color:var(--muted);transition:color 0.2s ease;}
    .playlists-panel .playlists-header h2,
    .public-playlists .playlists-header h2{position:relative;padding-left:20px;}
    .playlists-panel .playlists-header h2::before,
    .public-playlists .playlists-header h2::before{content:'â–¼';position:absolute;left:0;font-size:12px;color:var(--muted);transition:transform 0.2s ease;}
    .playlists-panel.collapsed .playlists-header h2::before,
    .public-playlists.collapsed .playlists-header h2::before{transform:rotate(-90deg);}
    .playlists-panel.collapsed .playlists-content,
    .public-playlists.collapsed .public-playlists-content{display:none;}
    .playlists-content{display:flex;flex-direction:column;gap:10px;}
    .public-playlists-content{display:flex;flex-direction:column;gap:10px;}
    .playlists-list{display:flex;flex-direction:column;gap:8px;}
    .playlist-pill{display:flex;flex-direction:column;align-items:flex-start;gap:2px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#1b1c20;color:#f5f5f5;cursor:pointer;min-width:0;transition:transform .15s ease,box-shadow .15s ease;font-size:12px;}
    .playlist-pill:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(0,0,0,.25);}
    .playlist-pill.active{border-color:var(--accent);box-shadow:0 0 0 1px rgba(98,245,169,.4);}
    .playlist-pill .name{font-weight:600;font-size:13px;}
    .playlist-pill .meta{color:var(--muted);font-size:11px;}
    .playlist-empty{color:var(--muted);font-size:12px;}
    .playlist-create{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
    .playlist-create input{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px 10px;color:var(--fg);flex:1;min-width:160px;font-size:13px;}
    .playlist-create button{padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;}

    .playlist-tracks{padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--card);display:flex;flex-direction:column;gap:6px;}
    .playlist-tracks[hidden]{display:none;}
    .playlist-tracks .playlists-header{margin-bottom:0;cursor:pointer;user-select:none;}
    .playlist-tracks .playlists-header:hover h2{color:var(--accent);}
    .playlist-tracks .playlists-header h2{font-size:18px;transition:color 0.2s ease;position:relative;padding-left:20px;}
    .playlist-tracks .playlists-header h2::before{content:'â–¼';position:absolute;left:0;font-size:12px;color:var(--muted);transition:transform 0.2s ease;}
    .playlist-tracks.collapsed .playlists-header h2::before{transform:rotate(-90deg);}
    .playlist-tracks.collapsed .playlist-tracks-content{display:none;}
    .playlist-tracks .muted{font-size:13px;}
    .playlist-tracks .tracks{display:flex;flex-direction:column;gap:6px;margin:0;padding:0;list-style:none;max-height:360px;overflow-y:auto;}
    .playlist-track{display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:6px;background:transparent;border:1px solid transparent;min-height:36px;}
    .playlist-track:hover{background:#1c1d21;border-color:rgba(255,255,255,0.07);}
    .playlist-track.playing{background:#202427;border-color:var(--accent);}
    .playlist-track .track-name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:14px;font-weight:600;line-height:1.4;margin:0;}
    .playlist-track .track-play{width:26px;height:26px;border-radius:4px;padding:0;font-size:12px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;line-height:1;}
    .playlist-tracks.collapsed .tracks{display:none;}
    .playlist-tracks.collapsed .playlist-empty{display:none;}
    .playlist-tracks.only-current .tracks{display:none;}
    .playlist-tracks.only-current .playlist-empty{display:none;}
    .playlist-tracks.only-current .now-playing-placeholder{display:none;}

    .now-playing {
      align-self: flex-start;
      width: 100%;
      min-width: 300px;
      padding: 18px 20px;
      border: 5px solid;
      border-image: var(--chrome) 1;
      border-radius: 20px;
      background: var(--card-solid);
      background-image: var(--card);
      display: flex;
      flex-direction: column;
      gap: 14px;
      box-shadow:
        0 0 30px rgba(255, 51, 102, 0.5),
        0 0 60px rgba(255, 204, 0, 0.2),
        inset 0 2px 4px rgba(255, 204, 0, 0.2);
    }
    .now-playing[hidden]{display:none !important;}
    .now-playing-header{display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .now-playing-header .label{font-size:12px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);}
    .now-playing-body{display:flex;align-items:center;gap:12px;}
    .now-playing-thumb{width:96px;height:96px;border-radius:8px;overflow:hidden;flex-shrink:0;background:#0e1014;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted);}
    .now-playing-thumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .now-playing-meta{display:flex;flex-direction:column;gap:3px;min-width:0;}
    .now-playing-title{font-size:16px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .now-playing-sub{font-size:14px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .now-playing-source{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .now-playing-controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .now-playing-meta-buttons{display:flex;flex-wrap:wrap;gap:6px;}
    .now-playing-meta-buttons .btn.small{padding:6px 10px;font-size:12px;}
    .now-playing-meta-list{font-size:11px;line-height:1.6;color:var(--muted);padding:8px 12px;background:rgba(0,0,0,0.2);border-radius:6px;border:1px solid rgba(255,255,255,0.05);}
    .now-playing-meta-list div{margin:4px 0;}
    .now-playing-meta-list strong{color:var(--fg);font-weight:600;}
    .now-playing-status{font-size:13px;color:var(--muted);}
    .now-playing-progress{width:100%;height:4px;background:#262830;border-radius:2px;overflow:hidden;position:relative;margin-top:6px;}
    .now-playing-progress .fill{position:absolute;inset:0;background:linear-gradient(90deg,var(--accent),#6bd3ff);width:0%;border-radius:2px;transition:width .1s linear;}
    .now-playing-controls .btn.small{padding:6px 12px;font-size:13px;}
    .now-playing.collapsed .now-playing-body,
    .now-playing.collapsed .now-playing-controls{display:none;}

    /* Landing placeholder */
    .loading-indicator{display:flex;flex-direction:column;align-items:center;justify-content:center;position:fixed;inset:0;z-index:50;background:var(--bg);}
    .loading-indicator[hidden]{display:none;}
    .loading-background{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0.85;filter:brightness(1.1) contrast(1.15);}
    .loading-spinner{width:80px;height:80px;border:6px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;position:relative;z-index:2;box-shadow:0 8px 24px rgba(98,245,169,0.3);}
    @keyframes spin{to{transform:rotate(360deg);}}
    .loading-text{color:var(--fg);font-size:18px;font-weight:700;margin-top:24px;position:relative;z-index:2;text-shadow:0 2px 8px rgba(0,0,0,0.5);letter-spacing:0.5px;}

    /* Placeholder images - bold and dominant style */
    img.placeholder-image, img[src*="placeholder.png"]{opacity:0.85 !important;filter:brightness(1.1) contrast(1.15) !important;}

    /* ======= Image Lightbox ======= */
    .image-lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.92);z-index:200;cursor:zoom-out;padding:20px;}
    .image-lightbox.open{display:flex;}
    .image-lightbox img{max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;box-shadow:0 20px 60px rgba(0,0,0,0.6);}
    .image-lightbox-close{position:absolute;top:20px;right:20px;background:rgba(0,0,0,0.7);border:none;color:#fff;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:24px;line-height:1;display:flex;align-items:center;justify-content:center;transition:background 0.2s ease;}
    .image-lightbox-close:hover{background:rgba(0,0,0,0.9);}

    /* ======= Modal (centered track window) ======= */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:transparent;z-index:100;gap:40px;}
    .overlay.open{display:flex;padding-right:30%;justify-content:space-evenly;}
    body.no-scroll .albums{display:none !important;}
    .modal-album-sleeve{
      width:280px;
      height:280px;
      background:var(--card);
      border:5px solid;
      border-image:var(--chrome) 1;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 8px 32px rgba(0,0,0,0.4);
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      flex-shrink:0;
    }
    .modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0,0,0,.35);
      width: min(300px, 94vw);
      max-height: 70vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      margin-top: 15%;
    }

    @media (max-width: 900px) {
      .modal-album-sleeve {
        display: none;
      }
    }
    @media (max-width: 700px) {
      .modal {
        width: 94vw;
      }
    }
    .modal header{display:flex;align-items:center;gap:8px;padding:8px 10px;border-bottom:1px solid var(--border);background:#14161a;position:sticky;top:0;z-index:1;}
    .modal .cover-wrap{display:none;}
    .modal .meta{display:flex;flex-direction:column;gap:1px;min-width:0;}
    .modal h2{margin:0;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .modal .sub{color:var(--muted);font-size:9px;display:flex;gap:4px;align-items:center;flex-wrap:wrap;}
    .modal .spacer{flex:1;}
    .modal .close{border-radius:5px;padding:5px 7px;cursor:pointer;font-size:9px;}
    .modal .content{padding:8px;overflow-y:auto;overflow-x:hidden;}
    .album-actions{display:flex;justify-content:flex-end;gap:6px;margin:0 0 8px;}
    .album-actions .btn{white-space:nowrap;font-size:9px;padding:5px 7px;}
    .tracks{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:6px;}
    .track{background:#1f1f23;padding:6px 8px;border-radius:6px;display:flex;flex-direction:column;gap:4px;color:#f8f4eb;}
    .track.loading{opacity:0.75;}
    .track.loading .btn.small{pointer-events:none;}
    .track-top{display:flex;align-items:center;justify-content:space-between;gap:6px;}
    .track-title{display:flex;flex-direction:column;flex:1;min-width:0;}
    .track .name{white-space:normal;word-break:break-word;overflow:visible;text-overflow:unset;line-height:1.35;color:#fef9ef;font-size:10px;}
    .track .artist{color:rgba(255,255,255,0.7);font-size:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .controls{display:flex;align-items:center;gap:4px;}
    .controls .btn{font-size:8px;padding:4px 6px;}
    .playing{outline:1px solid var(--accent); background:#202427;}
    .progress{display:flex;align-items:center;gap:6px;margin-top:4px;}
    .seek{appearance:none;width:160px;height:5px;background:linear-gradient(var(--accent),var(--accent)) 0/var(--fill,0%) 100% no-repeat,#1b2a21;border-radius:999px;outline:none;border:1px solid var(--accent);}
    .seek::-webkit-slider-thumb{appearance:none;width:8px;height:8px;border-radius:50%;background:var(--accent);}
    .time{font-size:8px;color:var(--muted);min-width:65px;text-align:right;}
    .no-scroll{overflow:hidden;}

    .info-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:150;}
    .info-modal-overlay.open{display:flex;}
    .info-modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px 20px;width:min(480px,92vw);max-height:80vh;overflow:auto;box-shadow:0 18px 48px rgba(0,0,0,.4);}
    .info-modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:12px;}
    .info-modal h3{margin:0;font-size:18px;}
    .info-modal .info-close{border-radius:8px;padding:6px 10px;cursor:pointer;}

    .share-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:150;}
    .share-modal-overlay.open{display:flex;}
    .share-modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;width:min(520px,92vw);box-shadow:0 18px 48px rgba(0,0,0,.4);}
    .share-modal h3{margin:0 0 8px;font-size:18px;}
    .share-modal p{margin:0 0 16px;color:var(--muted);font-size:14px;}
    .share-modal input{width:100%;background:var(--bg);color:var(--fg);border:1px solid var(--border);border-radius:8px;padding:12px;font-size:14px;font-family:monospace;margin-bottom:16px;}
    .share-modal input:focus{outline:2px solid var(--accent);outline-offset:2px;}
    .share-modal .actions{display:flex;gap:10px;justify-content:flex-end;}
    .share-modal .btn{min-width:100px;}
    .info-modal dl{margin:0;display:grid;grid-template-columns:minmax(120px,auto) 1fr;gap:10px 14px;font-size:14px;}
    .info-modal dt{font-weight:600;color:var(--muted);}
    .info-modal dd{margin:0;}
    .info-modal-empty{color:var(--muted);font-style:italic;text-align:center;margin:12px 0;}

    /* Busy / searching status indicator */
    .status{display:inline-flex;align-items:center;gap:8px;margin-left:8px;color:var(--muted);font-size:13px;}
    .status[hidden]{display:none;}
    .status .pulse{width:8px;height:8px;border-radius:50%;background:var(--accent);
      box-shadow:0 0 0 0 rgba(98,245,169,.7);animation:pulse 1.3s infinite;}
    body.alt-theme{
      --bg:#f2f0ec;
      --fg:#1f1c17;
      --muted:#6b6258;
      --card:#ffffff;
      --accent:#ff6a3d;
      --border:#d6cfc5;
      --overlay:rgba(255,255,255,0.7);
      --btn-gradient-start:#fdd68a;
      --btn-gradient-end:#ff6a3d;
      --btn-text:#351c12;
    }
    body.alt-theme header{background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(255,255,255,0.85));border-bottom:1px solid rgba(0,0,0,0.05);}
    body.alt-theme .card{border:1px solid #f0d6c4;box-shadow:0 8px 24px rgba(53,28,18,0.08);}
    body.alt-theme .searchbar input{background:#fff;border-color:#e3d7cd;color:#1f1c17;}
    body.alt-theme .searchbar button{background:#fff;color:#1f1c17;border:1px solid rgba(0,0,0,0.08);}
    body.alt-theme .playlist-column,
    body.alt-theme .public-playlists,
    body.alt-theme .public-playlist-view,
    body.alt-theme .playlist-tracks,
    body.alt-theme .ai-search-body{background:#fff;border-color:#e5dcd3;}
    body.alt-theme .btn{color:#351c12;}
    @keyframes pulse{
      0%{transform:scale(.9);box-shadow:0 0 0 0 rgba(98,245,169,.7);}
      70%{transform:scale(1);box-shadow:0 0 0 10px rgba(98,245,169,0);}
      100%{transform:scale(.9);box-shadow:0 0 0 0 rgba(98,245,169,0);}
        }
    .btn,
    .searchbar button,
    .pager button,
    .explore-buttons button,
    .modal .close,
    .info-modal .info-close,
    #explore {
      background: linear-gradient(135deg, var(--neon-blue) 0%, var(--neon-green) 100%);
      color: #0a0204;
      border: 3px solid var(--neon-green);
      border-radius: 30px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow:
        0 0 15px var(--neon-blue),
        0 0 30px var(--neon-green),
        inset 0 2px 4px rgba(255, 255, 255, 0.4);
      transition: all 0.2s ease;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5), 0 0 5px rgba(255, 255, 255, 0.5);
    }

    .btn:hover,
    .searchbar button:hover,
    .pager button:hover,
    .explore-buttons button:hover,
    .modal .close:hover,
    .info-modal .info-close:hover,
    #explore:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow:
        0 0 25px var(--neon-blue),
        0 0 50px var(--neon-green),
        0 0 75px var(--neon-blue),
        inset 0 2px 4px rgba(255, 255, 255, 0.6);
      border-color: var(--neon-blue);
    }

    .btn:active,
    .searchbar button:active,
    .pager button:active,
    .explore-buttons button:active,
    .modal .close:active,
    .info-modal .info-close:active,
    #explore:active {
      transform: translateY(0) scale(0.98);
      box-shadow:
        0 0 10px var(--neon-blue),
        0 0 20px var(--neon-green),
        inset 0 2px 4px rgba(255, 255, 255, 0.3);
    }

    button:disabled{opacity:.6;cursor:not-allowed;transform:none !important;box-shadow:none !important;}

    /* Fix playlist row layout: keep items in a row next to the play button */
    .track.playlist-track {
      flex-direction: row;       /* override .track { flex-direction: column } */
      align-items: center;
      gap: 0.5rem;               /* keep a little space between button and text */
    }

    /* Ensure the text can shrink and ellipsis correctly in a flex row */
    .playlist-track .track-name {
      flex: 1;
      min-width: 0;              /* required so text-overflow works inside flex */
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .playlist-track .track-name-artist {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .playlist-track .track-name-title {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Access Token Entry Screen */
    .access-token-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 24px;
    }
    .access-token-overlay.hidden {
      display: none;
    }
    .access-token-box {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      max-width: 480px;
      width: 90%;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    .access-token-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--accent);
    }
    .access-token-subtitle {
      font-size: 16px;
      color: var(--muted);
      margin-bottom: 24px;
      line-height: 1.5;
    }
    .access-token-input {
      width: 100%;
      padding: 14px 18px;
      font-size: 16px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 10px;
      color: var(--fg);
      text-align: center;
      font-family: monospace;
      text-transform: uppercase;
      margin-bottom: 16px;
      transition: border-color 0.2s ease;
    }
    .access-token-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(98,245,169,0.15);
    }
    .access-token-submit {
      width: 100%;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      background: var(--accent);
      color: var(--btn-text);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: filter 0.2s ease;
    }
    .access-token-submit:hover {
      filter: brightness(1.1);
    }
    .access-token-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .access-token-error {
      color: #ff4444;
      font-size: 14px;
      margin-top: 12px;
      display: none;
    }
    .access-token-error.show {
      display: block;
    }
    .access-token-info {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 13px;
      color: var(--muted);
      z-index: 100;
      max-width: 280px;
    }
    .access-token-info.hidden {
      display: none;
    }
    .access-token-info strong {
      color: var(--fg);
      display: block;
      margin-bottom: 4px;
    }

    /* Cookie Notice Banner */
    .cookie-notice {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(23, 24, 28, 0.98);
      border-top: 1px solid var(--border);
      padding: 16px 20px;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      backdrop-filter: blur(10px);
      animation: slideUp 0.3s ease-out;
    }
    .cookie-notice.hidden {
      display: none;
    }
    .cookie-notice-content {
      display: flex;
      align-items: center;
      gap: 20px;
      max-width: 1100px;
      width: 100%;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .cookie-notice-text {
      font-size: 14px;
      color: #f5f1e8;
      line-height: 1.5;
      flex: 1;
      min-width: 280px;
    }
    .cookie-notice-text a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }
    .cookie-notice-text a:hover {
      text-decoration: underline;
    }
    .cookie-notice-btn {
      background: var(--accent);
      color: var(--btn-text);
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    .cookie-notice-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(98, 245, 169, 0.3);
    }
    .cookie-notice-btn:active {
      transform: translateY(0);
    }
    @keyframes slideUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    @media (max-width: 600px) {
      .cookie-notice-content {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      .cookie-notice-btn {
        width: 100%;
      }
    }

  </style>
</head>
<body>

  <!-- Access Token Entry Overlay -->
  <div class="access-token-overlay hidden" id="accessTokenOverlay">
    <div class="access-token-box">
      <div class="access-token-title">Welcome to MASS</div>
      <div class="access-token-subtitle">
        Please enter your access token to continue
      </div>
      <form id="accessTokenForm" onsubmit="return false;">
        <input
          type="text"
          id="accessTokenInput"
          class="access-token-input"
          placeholder="MASS-XXXX-XXXXXX"
          autocomplete="off"
          spellcheck="false"
        />
        <button type="submit" class="access-token-submit" id="accessTokenSubmit">
          Activate Access
        </button>
        <div class="access-token-error" id="accessTokenError"></div>
      </form>
    </div>
  </div>

  <!-- Access Token Info Display (shown when logged in) -->
  <div class="access-token-info hidden" id="accessTokenInfo">
    <strong>Access Token</strong>
    <div id="accessTokenStatus"></div>
    <button id="resetAppBtn" style="margin-top:8px;font-size:11px;padding:4px 8px;background:var(--border);border:1px solid var(--muted);border-radius:6px;color:var(--muted);cursor:pointer;">Reset App</button>
  </div>

  <!-- Cookie Notice Banner -->
  <div class="cookie-notice hidden" id="cookieNotice">
    <div class="cookie-notice-content">
      <div class="cookie-notice-text">
        This site uses cookies for authentication and session management. By continuing to use this service, you accept our use of cookies.
      </div>
      <button class="cookie-notice-btn" id="cookieNoticeBtn">Got it!</button>
    </div>
  </div>

  <header>
    <div class="header-main">
      <img src="/img/MAD_Logo.png" alt="MAD Logo" class="header-logo" loading="lazy" decoding="async">
      <h1 style="
        font-size: 36px;
        font-weight: 900;
        font-family: Impact, 'Arial Black', sans-serif;
        color: var(--neon-yellow);
        margin: 0 16px;
        text-transform: uppercase;
        letter-spacing: 3px;
        text-shadow:
          0 0 10px var(--neon-yellow),
          0 0 20px var(--neon-yellow),
          0 0 30px var(--neon-red),
          0 0 40px var(--neon-red),
          0 2px 4px rgba(0, 0, 0, 0.8);
        filter: drop-shadow(0 0 15px rgba(255, 234, 0, 0.8));
      ">MAD JUKEBOX</h1>
      <style>
      </style>
      <div class="searchbar">
        <div class="search-fields" id="searchFields">
          <input id="searchArtist" type="search" placeholder="Artist" autocomplete="off" />
          <input id="searchAlbum" type="search" placeholder="Album" autocomplete="off" />
          <input id="searchTrack" type="search" placeholder="Track" autocomplete="off" />
        </div>
        <input id="search" type="search" placeholder="Search albums, artists, tracks, year, genreâ€¦" autocomplete="off" hidden />
        <button id="go">Search</button>
        <button id="clear">Clear</button>
        <span id="status" class="status" hidden aria-live="polite" role="status"><span class="pulse"></span><span id="statusText">Searchingâ€¦</span></span>
      </div>
      <div class="header-actions">
        <div class="ai-search-panel" id="aiSearchPanel" data-collapsed="true">
          <button id="aiSearchToggle" type="button" class="ai-search-toggle" aria-expanded="false" aria-controls="aiSearchPanelBody" aria-label="Toggle AI natural language search panel">
            <strong>AI Search</strong>
            <span>Powered by FileMaker script "AI_NaturalLanguageSearch"</span>
            <span class="ai-search-chevron">â–¸</span>
          </button>
          <div class="ai-search-body" id="aiSearchPanelBody">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="font-size:13px;font-weight:600;color:var(--fg);">AI Natural Language Search</span>
              <button id="aiSearchClose" type="button" style="background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:4px;" aria-label="Close AI search">&times;</button>
            </div>
            <div class="ai-search-row">
              <input id="aiSearchInput" type="search" placeholder="Describe the vibe, genre, instruments, year, or metadataâ€¦" autocomplete="off" />
              <button id="aiSearchButton" type="button" class="btn">Ask AI</button>
            </div>
            <div id="aiSearchStatus" class="ai-search-status" hidden aria-live="polite" role="status">
              <span class="pulse"></span>
              <span id="aiSearchStatusText">Asking FileMaker for matchesâ€¦</span>
            </div>
            <div id="aiSearchInterpretation" class="ai-search-interpretation" hidden></div>
          </div>
        </div>
      </div>
      <div class="explore-wrap" style="display:none !important;">
        <button id="explore" type="button" aria-expanded="false" style="display:none !important;">Explore</button>
        <div id="explorePanel" class="explore-panel" hidden>
          <section class="explore-section">
            <h3>Decades</h3>
            <div id="exploreDecades" class="explore-buttons"></div>
          </section>
          <section class="explore-section">
            <h3>Genres</h3>
            <div id="exploreGenres" class="explore-buttons"></div>
          </section>
          <section class="explore-section">
            <h3>Moods</h3>
            <div id="exploreMoods" class="explore-buttons"></div>
          </section>
        </div>
      </div>
      <div id="authControls" class="auth-controls">
        <span id="userBadge" class="badge" hidden></span>
        <button id="loginTrigger" type="button" class="btn">Log in</button>
        <button id="signupTrigger" type="button" class="btn">Subscribe</button>
        <button id="logoutButton" type="button" class="btn" hidden>Log out</button>
      </div>
    </div>
  </header>

  <div class="missing-mode-banner">ðŸ” MISSING AUDIO MODE - Showing albums with no valid audio (Press Ctrl+Shift+M to refresh â€¢ Escape to exit)</div>

  <main>
    <div class="layout-grid">
      <aside id="playlistColumn" class="playlist-column">
        <section id="nowPlayingCard" class="now-playing" hidden>
          <video id="nowPlayingVideo" class="now-playing-video" loop muted>
            <source src="/Video/JB.mp4" type="video/mp4">
          </video>
          <div class="now-playing-header">
            <span class="label">Now Playing</span>
            <div style="display: flex; gap: 6px;">
              <button id="nowPlayingCollapse" type="button" class="btn small">Hide</button>
            </div>
          </div>
          <div class="now-playing-body">
            <div id="nowPlayingThumb" class="now-playing-thumb">
              <div class="now-playing-thumb-content">--</div>
            </div>
            <div class="now-playing-meta">
              <div id="nowPlayingTitle" class="now-playing-title">Track</div>
              <div id="nowPlayingSubtitle" class="now-playing-sub">Artist</div>
              <div id="nowPlayingSource" class="now-playing-source"></div>
            </div>
          </div>
          <div class="now-playing-controls">
            <span id="nowPlayingStatus" class="now-playing-status">Paused</span>
            <div id="nowPlayingMetaButtons" class="now-playing-meta-buttons"></div>
            <button id="nowPlayingAdd" type="button" class="btn small" hidden>+ Playlist</button>
            <button id="nowPlayingToggle" type="button" class="btn small">Play</button>
          </div>
          <div class="now-playing-progress">
            <div id="nowPlayingProgressFill" class="fill"></div>
          </div>
        </section>
        <section id="playlistsPanel" class="playlists-panel" hidden>
          <div class="playlists-header">
            <h2>My Playlists</h2>
            <span id="playlistsStatus" class="muted"></span>
          </div>
          <div class="playlists-content">
            <div id="playlistsList" class="playlists-list"></div>
            <form id="playlistCreateForm" class="playlist-create" autocomplete="off">
              <input id="playlistNameInput" type="text" placeholder="Create new playlist" maxlength="80" />
              <button type="submit" class="btn small">Create</button>
            </form>
            <button id="importPlaylistButton" type="button" class="btn small" style="width:100%;margin-top:8px;">Import Playlist</button>
            <div id="playlistsEmpty" class="playlist-empty" hidden>No playlists yet. Create one to start saving tracks.</div>
          </div>
        </section>
        <section id="publicPlaylistsPanel" class="public-playlists">
          <div class="playlists-header">
            <h2>Featured Playlists</h2>
          </div>
          <div class="public-playlists-content">
            <ul id="publicPlaylistsList" class="public-playlists-list"></ul>
            <div id="publicPlaylistsEmpty" class="playlist-empty" hidden>No curated playlists yet.</div>
          </div>
        </section>
        <section id="playlistTracksSection" class="playlist-tracks" hidden>
          <div class="playlists-header">
            <h2 id="playlistTracksTitle">Playlist</h2>
            <div class="playlist-actions">
              <button id="deletePlaylistButton" type="button" class="btn small btn-error">Delete playlist</button>
            </div>
          </div>
          <div class="playlist-tracks-content">
            <div id="playlistTracksMeta" class="muted"></div>
            <ul id="playlistTracksList" class="tracks"></ul>
            <div id="playlistTracksEmpty" class="playlist-empty" hidden>No tracks in this playlist yet.</div>
            <div class="playlist-footer-actions">
              <button id="sharePlaylistButton" type="button" class="btn small">Share</button>
              <button id="exportPlaylistButton" type="button" class="btn small">Save</button>
            </div>
          </div>
        </section>
      </aside>
      <section class="content-column">
        <div class="toolbar">
          <div id="count" class="count"></div>
        </div>
        <section id="publicPlaylistView" class="public-playlist-view" hidden>
          <div class="public-playlist-header">
            <div style="display:flex;flex-direction:column;gap:4px;flex:1;min-width:0;">
              <h2 id="publicPlaylistTitle" class="public-playlist-title">Featured Playlist</h2>
              <span id="publicPlaylistMeta" class="public-playlist-status"></span>
            </div>
            <button id="closePublicPlaylistBtn" class="btn small" type="button" aria-label="Close playlist">&times;</button>
          </div>
          <div id="publicPlaylistStatus" class="public-playlist-status" hidden></div>
          <div id="publicPlaylistHero" class="public-playlist-hero" hidden>
            <img id="publicPlaylistArt" alt="Playlist artwork" loading="lazy" decoding="async" />
          </div>
          <ul id="publicPlaylistTracks" class="tracks public-playlist-tracks"></ul>
          <div id="publicPlaylistEmpty" class="playlist-empty" hidden>No tracks in this playlist.</div>
        </section>
        <section id="sharedPlaylistView" class="public-playlist-view" hidden>
          <div class="public-playlist-header">
            <h2 id="sharedPlaylistTitle" class="public-playlist-title">Playlist</h2>
            <span id="sharedPlaylistMeta" class="public-playlist-status"></span>
          </div>
          <div id="sharedPlaylistStatus" class="public-playlist-status" hidden></div>
          <div id="sharedPlaylistHero" class="public-playlist-hero" hidden>
            <img id="sharedPlaylistArt" alt="Playlist artwork" loading="lazy" decoding="async" />
          </div>
          <ul id="sharedPlaylistTracks" class="tracks public-playlist-tracks"></ul>
          <div id="sharedPlaylistEmpty" class="playlist-empty" hidden>No tracks are available in this shared playlist.</div>
          <div class="shared-playlist-actions">
            <button id="sharedPlaylistBack" type="button" class="btn small">Close</button>
            <button id="sharedPlaylistCopy" type="button" class="btn small">Copy share link</button>
          </div>
        </section>
        <div id="loadingIndicator" class="loading-indicator">
          <img src="/img/placeholder.png" alt="" class="loading-background" loading="lazy" decoding="async" />
          <div class="loading-spinner"></div>
          <div class="loading-text">Loading albums...</div>
        </div>
        <div id="albums" class="albums"></div>
        <div id="pager" class="pager" hidden>
          <button id="prev">â—€ Prev</button>
          <span id="pageInfo" class="badge">Page 1</span>
          <button id="next">Next â–¶</button>
        </div>
        <div id="error" class="error" hidden></div>
      </section>
    </div>
  </main>

  <!-- Single centered modal (reused for all albums) -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div id="modalAlbumSleeve" class="modal-album-sleeve"></div>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <div id="modalCover" class="cover-wrap" aria-hidden="true"></div>
        <div class="meta">
          <h2 id="modalTitle">Album</h2>
          <div class="sub">
            <span id="modalArtist"></span>
            <span id="modalCat" class="badge"></span>
          </div>
        </div>
        <div class="spacer"></div>
        <button id="modalClose" class="close" aria-label="Close">âœ•</button>
          </header>
      <div id="modalContent" class="content"></div>
    </div>
  </div>

  <div id="trackInfoOverlay" class="info-modal-overlay" hidden>
    <div id="trackInfoDialog" class="info-modal" role="dialog" aria-modal="true" aria-labelledby="trackInfoTitle">
      <header>
        <h3 id="trackInfoTitle">More info</h3>
        <button type="button" id="trackInfoClose" class="info-close">Close</button>
      </header>
      <div id="trackInfoBody"></div>
    </div>
  </div>

  <div id="authOverlay" class="info-modal-overlay" hidden>
    <div id="authDialog" class="info-modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <header>
        <h3 id="authTitle">Log in</h3>
        <button type="button" id="authClose" class="info-close">Close</button>
      </header>
      <form id="authForm" class="auth-form">
        <label for="authEmail">
          <span>Email</span>
          <input id="authEmail" type="email" name="email" autocomplete="email" required />
        </label>
        <label for="authPassword">
          <span>Password</span>
          <input id="authPassword" type="password" name="password" autocomplete="current-password" minlength="8" required />
        </label>
        <button type="submit" id="authSubmit" class="btn btn-accent">Log in</button>
      </form>
      <div class="auth-switch">
        <span id="authToggleText">Need an account?</span>
        <button type="button" id="authSwitchMode">Subscribe</button>
      </div>
      <div id="authError" class="error" hidden></div>
    </div>
  </div>

  <div id="shareModal" class="share-modal-overlay">
    <div class="share-modal" role="dialog" aria-modal="true" aria-labelledby="shareModalTitle">
      <h3 id="shareModalTitle">Share Playlist</h3>
      <p>Copy this link to share your playlist:</p>
      <input id="shareLinkInput" type="text" readonly />
      <div class="actions">
        <button type="button" id="shareModalClose" class="btn small">Close</button>
      </div>
    </div>
  </div>

  <div id="exportModal" class="share-modal-overlay">
    <div class="share-modal" role="dialog" aria-modal="true" aria-labelledby="exportModalTitle">
      <h3 id="exportModalTitle">Export Playlist</h3>
      <p>Copy the compact code or download as JSON file:</p>
      <input id="exportCodeInput" type="text" readonly />
      <div class="actions">
        <button type="button" id="exportDownloadBtn" class="btn small">Download JSON</button>
        <button type="button" id="exportCopyBtn" class="btn small">Copy Code</button>
        <button type="button" id="exportModalClose" class="btn small">Close</button>
      </div>
    </div>
  </div>

  <div id="importModal" class="share-modal-overlay">
    <div class="share-modal" role="dialog" aria-modal="true" aria-labelledby="importModalTitle">
      <h3 id="importModalTitle">Import Playlist</h3>
      <p>Paste a compact code (MASS:...) or upload a JSON file:</p>
      <textarea id="importCodeInput" placeholder="Paste MASS:... code here" rows="4" style="width:100%;background:var(--bg);color:var(--fg);border:1px solid var(--border);border-radius:8px;padding:12px;font-size:14px;font-family:monospace;margin-bottom:12px;resize:vertical;"></textarea>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
        <span style="color:var(--muted);font-size:14px;">or</span>
        <input type="file" id="importFileInput" accept=".json" style="flex:1;font-size:14px;" />
      </div>
      <div id="importStatus" style="color:var(--muted);font-size:13px;margin-bottom:12px;min-height:20px;"></div>
      <div class="actions">
        <button type="button" id="importSubmitBtn" class="btn small">Import</button>
        <button type="button" id="importModalClose" class="btn small">Close</button>
      </div>
    </div>
  </div>

  <audio id="player" preload="none"></audio>

  <!-- Image Lightbox for enlarged album artwork -->
  <div id="imageLightbox" class="image-lightbox" aria-hidden="true">
    <button id="imageLightboxClose" class="image-lightbox-close" aria-label="Close">&times;</button>
    <img id="imageLightboxImg" alt="Album artwork" loading="lazy" decoding="async" />
  </div>


  <script>
    // Close featured playlist button handler
    document.addEventListener('DOMContentLoaded', () => {
      const closeBtn = document.getElementById('closePublicPlaylistBtn');
      const clearBtn = document.getElementById('clear');
      const publicPlaylistView = document.getElementById('publicPlaylistView');
      const searchEl = document.getElementById('search');
      const searchArtistEl = document.getElementById('searchArtist');
      const searchAlbumEl = document.getElementById('searchAlbum');
      const searchTrackEl = document.getElementById('searchTrack');
      const searchFieldsEl = document.getElementById('searchFields');
      let goBtn = document.getElementById('go');

      // Show search fields when Search button is clicked
      if (goBtn && searchFieldsEl) {
        console.log('[MASS] Attaching search button handler to:', goBtn);

        // CRITICAL: Remove all existing handlers from the button first
        // Clone the button to remove all listeners, then replace it
        const newGoBtn = goBtn.cloneNode(true);
        goBtn.parentNode.replaceChild(newGoBtn, goBtn);
        goBtn = newGoBtn; // Update reference for Enter key handler below

        // Now attach our handler to the fresh button
        goBtn.addEventListener('click', (e) => {
          console.log('[MASS] Search button clicked, searchFieldsEl.hidden:', searchFieldsEl.hidden);

          if (searchFieldsEl.hidden) {
            console.log('[MASS] Showing search fields and stopping propagation');
            searchFieldsEl.hidden = false;
            // Focus on first field
            if (searchArtistEl) searchArtistEl.focus();
            // Stop the event from reaching any other handlers
            e.stopImmediatePropagation();
            e.preventDefault();
            return; // Don't search yet, just show fields
          } else {
            console.log('[MASS] Search fields already visible, allowing search to proceed');
          }
        }, true); // Use capture phase to run before other handlers
      }

      if (closeBtn && clearBtn && publicPlaylistView) {
        closeBtn.addEventListener('click', () => {
          // Hide the featured playlist view immediately
          publicPlaylistView.hidden = true;
          // Clear search fields and trigger clear button to reload featured albums
          if (searchEl) searchEl.value = '';
          if (searchArtistEl) searchArtistEl.value = '';
          if (searchAlbumEl) searchAlbumEl.value = '';
          if (searchTrackEl) searchTrackEl.value = '';
          clearBtn.click();
        });
      }

      // Debounce utility for search
      function debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      // Allow Enter key to trigger search from any search field
      const searchFields = [searchArtistEl, searchAlbumEl, searchTrackEl].filter(Boolean);

      // Debounced search on input (400ms delay to reduce API calls)
      const debouncedSearch = debounce(() => {
        if (!searchFieldsEl.hidden && goBtn) {
          goBtn.click();
        }
      }, 400);

      searchFields.forEach(field => {
        // Immediate search on Enter key
        field.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            goBtn.click();
          }
        });

        // Debounced search as user types
        field.addEventListener('input', debouncedSearch);
      });

      // Accordion functionality for My Playlists
      const playlistsPanel = document.getElementById('playlistsPanel');
      if (playlistsPanel) {
        const header = playlistsPanel.querySelector('.playlists-header');
        if (header) {
          header.addEventListener('click', (e) => {
            // Don't toggle if clicking on the status span
            if (e.target.id === 'playlistsStatus') return;
            playlistsPanel.classList.toggle('collapsed');
            localStorage.setItem('myPlaylistsCollapsed', playlistsPanel.classList.contains('collapsed'));
          });
        }
        if (localStorage.getItem('myPlaylistsCollapsed') === 'true') {
          playlistsPanel.classList.add('collapsed');
        }
      }

      // Accordion functionality for Featured Playlists
      const publicPlaylistsPanel = document.getElementById('publicPlaylistsPanel');
      if (publicPlaylistsPanel) {
        const header = publicPlaylistsPanel.querySelector('.playlists-header');
        if (header) {
          header.addEventListener('click', () => {
            publicPlaylistsPanel.classList.toggle('collapsed');
            localStorage.setItem('featuredPlaylistsCollapsed', publicPlaylistsPanel.classList.contains('collapsed'));
          });
        }
        if (localStorage.getItem('featuredPlaylistsCollapsed') === 'true') {
          publicPlaylistsPanel.classList.add('collapsed');
        }
      }

      // Accordion functionality for playlist tracks section
      const playlistTracksSection = document.getElementById('playlistTracksSection');
      if (playlistTracksSection) {
        const header = playlistTracksSection.querySelector('.playlists-header');
        if (header) {
          header.addEventListener('click', (e) => {
            // Don't toggle if clicking on a button
            if (e.target.tagName === 'BUTTON' || e.target.closest('.playlist-actions')) return;
            playlistTracksSection.classList.toggle('collapsed');
            localStorage.setItem('playlistTracksCollapsed', playlistTracksSection.classList.contains('collapsed'));
          });
        }
        if (localStorage.getItem('playlistTracksCollapsed') === 'true') {
          playlistTracksSection.classList.add('collapsed');
        }
      }

      // Keep old search field handler for compatibility
      if (searchEl && goBtn) {
        searchEl.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            goBtn.click();
          }
        });
      }

      // AI Search close button
      const aiSearchClose = document.getElementById('aiSearchClose');
      const aiSearchPanel = document.getElementById('aiSearchPanel');
      const aiSearchToggle = document.getElementById('aiSearchToggle');
      if (aiSearchClose && aiSearchPanel && aiSearchToggle) {
        aiSearchClose.addEventListener('click', () => {
          aiSearchPanel.setAttribute('data-collapsed', 'true');
          aiSearchToggle.setAttribute('aria-expanded', 'false');
        });
      }

      // Image lightbox for album artwork (only in modal track view)
      const imageLightbox = document.getElementById('imageLightbox');
      const imageLightboxImg = document.getElementById('imageLightboxImg');
      const imageLightboxClose = document.getElementById('imageLightboxClose');
      const modalOverlay = document.getElementById('overlay');

      if (imageLightbox && imageLightboxImg && imageLightboxClose) {
        // Handle clicks on album artwork
        document.addEventListener('click', (e) => {
          const coverWrap = e.target.closest('.cover-wrap');
          if (coverWrap) {
            const img = coverWrap.querySelector('img');
            if (img && img.src) {
              e.preventDefault();
              e.stopPropagation();

              // Check if cover is in the modal (track view)
              const isInModal = modalOverlay && modalOverlay.classList.contains('open') &&
                                coverWrap.closest('.modal');

              if (isInModal) {
                // In modal: enlarge the image
                imageLightboxImg.src = img.src;
                imageLightbox.classList.add('open');
                imageLightbox.setAttribute('aria-hidden', 'false');
              } else {
                // In grid/random view: search for albums by this artist
                const card = coverWrap.closest('.card');
                if (card) {
                  const artistEl = card.querySelector('.card-artist');
                  if (artistEl) {
                    const artistName = artistEl.textContent.trim();
                    if (artistName) {
                      // Set artist in search field and trigger search
                      const searchArtistEl = document.getElementById('searchArtist');
                      const searchAlbumEl = document.getElementById('searchAlbum');
                      const searchTrackEl = document.getElementById('searchTrack');
                      const searchFieldsEl = document.getElementById('searchFields');
                      const goBtn = document.getElementById('go');

                      if (searchArtistEl && searchFieldsEl && goBtn) {
                        // Clear other fields and set artist
                        searchArtistEl.value = artistName;
                        if (searchAlbumEl) searchAlbumEl.value = '';
                        if (searchTrackEl) searchTrackEl.value = '';

                        // Show fields and trigger search
                        searchFieldsEl.hidden = false;
                        goBtn.click();
                      }
                    }
                  }
                }
              }
            }
          }
        });

        // Close lightbox on click
        const closeLightbox = () => {
          imageLightbox.classList.remove('open');
          imageLightbox.setAttribute('aria-hidden', 'true');
          imageLightboxImg.src = '';
        };

        imageLightboxClose.addEventListener('click', closeLightbox);
        imageLightbox.addEventListener('click', (e) => {
          if (e.target === imageLightbox) closeLightbox();
        });

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && imageLightbox.classList.contains('open')) {
            closeLightbox();
          }
        });
      }

      // Wake up the FileMaker connection to prevent idle timeout issues
      // This ensures the token is fresh and connection is warm before user tries to play audio
      function wakeUpConnection() {
        fetch('/api/wake', {
          headers: { 'Accept': 'application/json' },
          cache: 'no-cache',
          keepalive: true // Prevent connection from being terminated
        })
        .then(res => res.json())
        .then(data => {
          console.log('[MASS] Connection warmed up:', data.status);
        })
        .catch(err => {
          console.warn('[MASS] Wake call failed:', err);
        });
      }

      // Call on page load
      wakeUpConnection();

      // Also call when page becomes visible again (user returns to tab after being away)
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          console.log('[MASS] Page became visible, warming up connection...');
          wakeUpConnection();
        }
      });

      // Periodically wake the connection to prevent token expiration
      // FileMaker tokens expire after ~11.5 minutes, so wake every 8 minutes (safer than 5 with less overhead)
      setInterval(() => {
        if (!document.hidden) {
          console.log('[MASS] Periodic wake (keeping connection alive)...');
          wakeUpConnection();
        }
      }, 8 * 60 * 1000); // 8 minutes (changed from 5 for better balance)

      // Preload featured playlists in the background - but only after access token is ready
      window.addEventListener('mass:access-ready', function() {
        // Hide loading indicator once access is ready
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
          loadingIndicator.setAttribute('hidden', '');
        }

        setTimeout(() => {
          console.log('[Preload] Starting featured playlists preload');
          fetch('/api/public-playlists', { headers: { 'Accept': 'application/json' } })
            .then(res => res.json())
            .then(data => {
              if (Array.isArray(data?.playlists)) {
                // Preload each featured playlist's tracks in the background
                data.playlists.forEach((playlist, index) => {
                  if (playlist?.name) {
                    // Stagger the requests to avoid overwhelming the server
                    setTimeout(() => {
                      fetch(`/api/public-playlists?name=${encodeURIComponent(playlist.name)}`, {
                        headers: { 'Accept': 'application/json' }
                      }).catch(err => console.log('Preload failed for', playlist.name));
                    }, index * 500); // 500ms between each preload
                  }
                });
              }
            })
            .catch(err => console.log('Failed to preload featured playlists'));
        }, 2000); // Wait 2 seconds after access ready before preloading
      });
    });
  </script>

  <script>
  // ========= COOKIE NOTICE =========
  (function() {
    const COOKIE_CONSENT_KEY = 'mass_cookie_consent';
    const cookieNotice = document.getElementById('cookieNotice');
    const cookieNoticeBtn = document.getElementById('cookieNoticeBtn');

    // Check if user has already accepted cookies
    const hasAccepted = localStorage.getItem(COOKIE_CONSENT_KEY);

    if (!hasAccepted) {
      // Show cookie notice after a short delay for better UX
      setTimeout(() => {
        cookieNotice.classList.remove('hidden');
      }, 1000);
    }

    // Handle "Got it!" button click
    cookieNoticeBtn.addEventListener('click', () => {
      localStorage.setItem(COOKIE_CONSENT_KEY, 'true');
      cookieNotice.classList.add('hidden');
    });
  })();
  </script>

  <script>
  // ========= ACCESS TOKEN MANAGEMENT =========
  // IMPORTANT: This must run BEFORE app.min.js to intercept fetch calls
  (function() {
    const STORAGE_KEY = 'mass_access_token';
    const STORAGE_INFO_KEY = 'mass_access_token_info';

    // Load token from localStorage IMMEDIATELY before anything else
    let currentAccessToken = localStorage.getItem(STORAGE_KEY);
    let tokenInfo = null;
    try {
      const infoStr = localStorage.getItem(STORAGE_INFO_KEY);
      if (infoStr) {
        tokenInfo = JSON.parse(infoStr);
      }
    } catch (e) {
      console.warn('[Access Token] Failed to parse token info:', e);
    }

    console.log('[Access Token] Pre-loaded token:', currentAccessToken ? 'YES' : 'NO');

    const overlay = document.getElementById('accessTokenOverlay');
    const form = document.getElementById('accessTokenForm');
    const input = document.getElementById('accessTokenInput');
    const submitBtn = document.getElementById('accessTokenSubmit');
    const errorDiv = document.getElementById('accessTokenError');
    const infoDiv = document.getElementById('accessTokenInfo');
    const statusDiv = document.getElementById('accessTokenStatus');

    // Intercept all fetch requests to add access token header
    const originalFetch = window.fetch;
    window.fetch = function(url, options = {}) {
      const isApiCall = url.includes('/api/') || url.startsWith('/api/');
      const isAccessValidateCall = url.includes('/api/access/validate');

      // Block API calls without token (except the validate endpoint itself)
      if (isApiCall && !currentAccessToken && !isAccessValidateCall) {
        console.warn('[Access Token] Blocking API call without token:', url);
        return Promise.reject(new Error('API call attempted before access token was ready'));
      }

      // Add access token header if we have one and it's an API request
      if (currentAccessToken && isApiCall) {
        console.log('[Access Token] Adding token to request:', url);

        // Initialize headers if not present
        if (!options.headers) {
          options.headers = {};
        }

        // Handle both Headers objects and plain objects
        if (options.headers instanceof Headers) {
          options.headers.set('X-Access-Token', currentAccessToken);
        } else if (typeof options.headers === 'object') {
          options.headers['X-Access-Token'] = currentAccessToken;
        }
      }

      // Call original fetch and handle 403 errors
      return originalFetch(url, options).then(response => {
        // If we get 403 and it requires access token, show the overlay
        if (response.status === 403 && url.includes('/api/')) {
          response.clone().json().then(data => {
            if (data.requiresAccessToken) {
              console.log('[Access Token] 403 error - token required or invalid');
              clearAccessToken();
              showTokenOverlay();
            }
          }).catch(() => {});
        }
        return response;
      });
    };

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.classList.add('show');
      setTimeout(() => {
        errorDiv.classList.remove('show');
      }, 5000);
    }

    function showTokenOverlay() {
      overlay.classList.remove('hidden');
      input.value = '';
      input.focus();
    }

    function hideTokenOverlay() {
      overlay.classList.add('hidden');
    }

    function updateTokenInfo() {
      if (!tokenInfo) {
        infoDiv.classList.add('hidden');
        return;
      }

      let statusText = '';
      if (tokenInfo.type === 'unlimited') {
        statusText = 'Unlimited Access';
      } else if (tokenInfo.expirationDate && tokenInfo.expirationDate.trim() !== '') {
        const expDate = new Date(tokenInfo.expirationDate);
        const now = new Date();

        // Check if date is valid
        if (isNaN(expDate.getTime())) {
          statusText = 'Active';
        } else {
          const hoursLeft = (expDate - now) / (1000 * 60 * 60);
          const daysLeft = Math.ceil(hoursLeft / 24);

          if (hoursLeft < 1) {
            statusText = 'Expired';
          } else if (hoursLeft < 24) {
            statusText = `Expires in ${Math.floor(hoursLeft)} hour${Math.floor(hoursLeft) !== 1 ? 's' : ''}`;
          } else if (daysLeft === 1) {
            statusText = `Expires in 1 day`;
          } else {
            statusText = `Expires in ${daysLeft} days`;
          }
        }
      } else {
        statusText = 'Active (no expiration)';
      }

      statusDiv.textContent = statusText;
      infoDiv.classList.remove('hidden');
    }

    function saveAccessToken(token, info) {
      currentAccessToken = token;
      tokenInfo = info;
      localStorage.setItem(STORAGE_KEY, token);
      localStorage.setItem(STORAGE_INFO_KEY, JSON.stringify(info));
      updateTokenInfo();
    }

    function loadAccessToken() {
      // Token already loaded at script start, just update UI and return it
      if (currentAccessToken) {
        updateTokenInfo();
      }
      return currentAccessToken;
    }

    function clearAccessToken() {
      currentAccessToken = null;
      tokenInfo = null;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(STORAGE_INFO_KEY);
      infoDiv.classList.add('hidden');
      window.massAccessReady = false;
      window.massAccessToken = null;
    }

    async function validateToken(token) {
      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Validating...';
        errorDiv.classList.remove('show');

        const response = await originalFetch('/api/access/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: token.trim().toUpperCase() })
        });

        const data = await response.json();

        if (response.ok && data.valid) {
          const normalized = token.trim().toUpperCase();
          saveAccessToken(normalized, {
            type: data.type,
            expirationDate: data.expirationDate
          });
          hideTokenOverlay();
          console.log('[Access Token] Token validated successfully');

          // Notify app that access is ready so it can do its initial load
          window.massAccessReady = true;
          window.massAccessToken = normalized;
          window.dispatchEvent(new CustomEvent('mass:access-ready', {
            detail: { token: normalized }
          }));

          return true;
        } else {
          showError(data.reason || data.error || 'Invalid token');
          return false;
        }
      } catch (err) {
        console.error('[Access Token] Validation error:', err);
        showError('Failed to validate token. Please try again.');
        return false;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Activate Access';
      }
    }

    // Form submission handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const token = input.value.trim();

      if (!token) {
        showError('Please enter an access token');
        return;
      }

      await validateToken(token);
    });

    // Check for existing token on page load
    const existingToken = loadAccessToken();
    if (existingToken) {
      console.log('[Access Token] Found existing token, validating...');
      // Validate the existing token (validateToken will dispatch 'mass:access-ready' if valid)
      validateToken(existingToken).then(valid => {
        if (!valid) {
          console.log('[Access Token] Existing token invalid, showing overlay');
          showTokenOverlay();
        } else {
          console.log('[Access Token] Existing token valid (event already dispatched)');
          // Note: hideTokenOverlay and event dispatch already handled in validateToken
        }
      });
    } else {
      console.log('[Access Token] No existing token, showing overlay');
      showTokenOverlay();
    }

    // Allow clearing token with Ctrl+Shift+T (for testing)
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'T') {
        console.log('[Access Token] Clearing token (Ctrl+Shift+T)');
        clearAccessToken();
        showTokenOverlay();
      }
    });

    // Reset App button handler
    const resetAppBtn = document.getElementById('resetAppBtn');
    if (resetAppBtn) {
      resetAppBtn.addEventListener('click', () => {
        if (confirm('Reset app? This will clear all stored data (access token, cookies, settings) and reload the page.')) {
          console.log('[Access Token] Resetting app - clearing all localStorage');
          localStorage.clear();
          sessionStorage.clear();
          // Also clear cookies
          document.cookie.split(";").forEach((c) => {
            document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
          });
          location.reload(true); // Force reload from server, not cache
        }
      });
    }

    console.log('[Access Token] Token management initialized');
  })();
  </script>

  <script>
  // Check for URL parameters IMMEDIATELY to prevent featured albums from loading
  (function() {
    const urlParams = new URLSearchParams(window.location.search);
    const albumParam = urlParams.get('album');
    const artistParam = urlParams.get('artist');

    if (albumParam || artistParam) {
      // Set flag to prevent app.min.js from loading featured albums
      window.__skipFeaturedLoad = true;
      console.log('[MASS] URL parameters detected early, skipping featured album load');
    }
  })();
  </script>
  <script defer src="/app.min.js?v=84&t=1733401000"></script>
  <script>
  // Override search to use separate fields
  window.addEventListener('DOMContentLoaded', () => {
    const searchArtistEl = document.getElementById('searchArtist');
    const searchAlbumEl = document.getElementById('searchAlbum');
    const searchTrackEl = document.getElementById('searchTrack');
    const searchFieldsEl = document.getElementById('searchFields');
    const goEl = document.getElementById('go');
    const clearEl = document.getElementById('clear');

    // Check if we need to trigger immediate search from URL params
    const hasUrlParams = window.__skipFeaturedLoad === true;

    function setupSearchOverride() {
      const originalDoSearch = typeof window.doSearch === 'function' ? window.doSearch : null;
      if (!originalDoSearch) {
        console.warn('[Separate Search] Unable to override doSearch (missing original implementation)');
        return;
      }

      window.doSearch = function(q, options = {}) {
        const artist = searchArtistEl?.value?.trim() || '';
        const album = searchAlbumEl?.value?.trim() || '';
        const track = searchTrackEl?.value?.trim() || '';
        const genreValue = typeof options.genre === 'string' ? options.genre.trim() : '';
        const useAdvanced = Boolean(artist || album || track);

        if (!useAdvanced) {
          return originalDoSearch.call(this, q, options);
        }

        const params = new URLSearchParams();
        if (artist) params.set('artist', artist);
        if (album) params.set('album', album);
        if (track) params.set('track', track);
        if (genreValue) params.set('genre', genreValue);
        const searchLimit = (artist && !album && !track) ? 500 : 200;
        params.set('limit', searchLimit);
        const requestedOffset = Number.isFinite(options.offset) ? Math.max(0, Number(options.offset)) : 0;
        params.set('offset', requestedOffset);


        console.log('[Separate Search] Advanced search params:', {
          artist,
          album,
          track,
          genre: genreValue,
          offset: requestedOffset,
          limit: searchLimit
        });

        if (window.inFlight) {
          try { window.inFlight.abort(); } catch {}
        }
        const ctrl = new AbortController();
        window.inFlight = ctrl;

        return fetch(`/api/search?${params}`, { signal: ctrl.signal })
          .then(async (r) => {
            if (!r.ok) throw new Error(await r.text().catch(() => `HTTP ${r.status}`));
            return r.json();
          })
          .finally(() => {
            if (window.inFlight === ctrl) window.inFlight = null;
          });
      };

      // Override go button handler
      if (goEl && searchFieldsEl) {
        const oldHandler = goEl.onclick;
        goEl.onclick = null;
        goEl.removeEventListener('click', oldHandler);

        goEl.addEventListener('click', () => {
          // If fields are hidden, don't search (the capture phase handler will show them)
          if (searchFieldsEl.hidden) {
            return;
          }

          const artist = searchArtistEl?.value?.trim() || '';
          const album = searchAlbumEl?.value?.trim() || '';
          const track = searchTrackEl?.value?.trim() || '';

          // Need at least one field to search
          if (!artist && !album && !track) {
            return;
          }

          // Call run function with a dummy query to trigger the search flow
          // The actual parameters will be read from the input fields by doSearch
          if (typeof window.run === 'function') {
            window.run(' ');
          }
        });
      }

      // Update clear button to clear all fields and hide them
      if (clearEl && searchFieldsEl) {
        const originalClearHandler = clearEl.onclick;
        clearEl.addEventListener('click', () => {
          if (searchArtistEl) searchArtistEl.value = '';
          if (searchAlbumEl) searchAlbumEl.value = '';
          if (searchTrackEl) searchTrackEl.value = '';
          searchFieldsEl.hidden = true;
          if (typeof originalClearHandler === 'function') {
            try {
              originalClearHandler.call(clearEl);
            } catch (err) {
              console.warn('[Separate Search] Original clear handler threw', err);
            }
          }
        });
      }

      // Handle URL parameters for album/artist filtering from Modern View
      if (hasUrlParams) {
        const urlParams = new URLSearchParams(window.location.search);
        const albumParam = urlParams.get('album');
        const artistParam = urlParams.get('artist');

        if ((albumParam || artistParam) && searchFieldsEl) {
          console.log('[MASS] URL parameters detected, pre-filling search:', { album: albumParam, artist: artistParam });

          // Show search fields
          searchFieldsEl.hidden = false;

          // Pre-fill the search fields
          if (artistParam && searchArtistEl) {
            searchArtistEl.value = artistParam;
          }
          if (albumParam && searchAlbumEl) {
            searchAlbumEl.value = albumParam;
          }

          // Trigger search immediately
          console.log('[MASS] Triggering immediate search from URL parameters');
          if (typeof window.run === 'function') {
            window.run(' ');
          }
        }
      }
    }

    // If window.run is already available (deferred script loaded), setup immediately
    // Otherwise poll for it (should be very quick with defer)
    if (typeof window.run === 'function') {
      setupSearchOverride();
    } else {
      const checkInterval = setInterval(() => {
        if (typeof window.run === 'function') {
          clearInterval(checkInterval);
          setupSearchOverride();
        }
      }, 10);
      // Fallback timeout
      setTimeout(() => clearInterval(checkInterval), 1000);
    }
  });
  </script>

  <script>
  // Secret keystroke: Ctrl+Shift+M to toggle/refresh Missing Audio Mode, Escape to exit
  document.addEventListener('keydown', async (e) => {
    const albumsEl = document.getElementById('albums');
    if (!albumsEl) return;

    const isActive = document.body.classList.contains('missing-audio-mode');

    // Escape key exits missing audio mode
    if (e.key === 'Escape' && isActive) {
      e.preventDefault();
      window.location.reload();
      return;
    }

    // Ctrl+Shift+M toggles on or refreshes
    if (e.ctrlKey && e.shiftKey && e.key === 'M') {
      e.preventDefault();

      if (isActive) {
        console.log('ðŸ”„ Refreshing missing audio songs...');
      } else {
        document.body.classList.add('missing-audio-mode');
        console.log('ðŸ” Missing Audio Mode ACTIVATED');
      }

      // Load songs WITHOUT valid audio
      try {
        const res = await fetch('/api/missing-audio-songs?count=12&_t=' + Date.now());
        const data = await res.json();
        const songs = data.items || [];
        console.log(`ðŸ” Loaded ${songs.length} songs with missing audio`);

        albumsEl.innerHTML = '';

        if (songs.length === 0) {
          albumsEl.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">No songs with missing audio found in database</div>';
        } else {
          // Render missing audio cards
          for (const item of songs) {
            const fields = item.fields || {};
            const card = document.createElement('div');
            card.className = 'card';
            card.style.border = '2px solid #ff4444';

            const title = fields['Track Name'] || fields['Song Name'] || fields['Title'] || 'Unknown Track';
            const artist = fields['Album Artist'] || fields['Artist'] || 'Unknown Artist';
            const album = fields['Album Title'] || fields['Album'] || 'Unknown Album';
            const catalogue = fields['Album Catalogue Number'] || fields['Catalogue'] || '';

            card.innerHTML = `
              <div class="heading">
                <h3 style="color:#ff4444;">${title}</h3>
                <div class="card-artist">${artist}</div>
                <div class="muted">${album}${catalogue ? ' â€¢ ' + catalogue : ''}</div>
                <div class="muted" style="color:#ff4444;margin-top:8px;font-weight:600;">âš ï¸ MISSING AUDIO</div>
              </div>
            `;
            albumsEl.appendChild(card);
          }
        }
      } catch (err) {
        console.error('âŒ Failed to load missing audio songs:', err);
        albumsEl.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#ff4444;">Error loading missing audio songs</div>';
      }
    }
  });
  </script>

  <script>
  // Show subscription prompt after 5 minutes for non-authenticated users
  (function() {
    const PROMPT_DELAY_MS = 5 * 60 * 1000; // 5 minutes
    let promptShown = false;

    function isUserLoggedIn() {
      const userBadge = document.getElementById('userBadge');
      const isLoggedIn = userBadge && !userBadge.hidden;
      return isLoggedIn;
    }

    function showSubscriptionPrompt() {
      if (promptShown) return;
      if (isUserLoggedIn()) return;

      promptShown = true;

      // Create persistent toast notification
      const toast = document.createElement('div');
      toast.className = 'subscription-toast';
      toast.innerHTML = `
        <button class="subscription-toast-close" aria-label="Close">âœ•</button>
        <div style="padding-right:20px;cursor:pointer;" class="subscription-toast-body">
          ðŸŽµ Enjoying the music?<br/>
          <span style="font-weight:400;font-size:13px;opacity:0.9;">Subscribe to unlock playlists and more features!</span>
        </div>
      `;
      document.body.appendChild(toast);

      // Show toast with animation
      setTimeout(() => toast.classList.add('show'), 100);

      // Close button handler - only dismiss
      const closeBtn = toast.querySelector('.subscription-toast-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 400);
        });
      }

      // Click toast body to open subscribe modal
      const toastBody = toast.querySelector('.subscription-toast-body');
      if (toastBody) {
        toastBody.addEventListener('click', () => {
          const signupTrigger = document.getElementById('signupTrigger');
          if (signupTrigger) {
            signupTrigger.click();
          }
        });
      }

      console.log('ðŸ“¢ Subscription prompt displayed (persistent until dismissed)');
    }

    // Set timer
    console.log(`â±ï¸ Subscription prompt timer started (${Math.floor(PROMPT_DELAY_MS / 1000)} seconds)`);

    setTimeout(() => {
      showSubscriptionPrompt();
    }, PROMPT_DELAY_MS);
  })();
  </script>

  <script>
  // Lazy loading for images - improves performance
  (function() {
    // Add lazy loading and async decoding to all existing images
    document.querySelectorAll('img').forEach(img => {
      if (!img.loading) img.loading = 'lazy';
      if (!img.decoding) img.decoding = 'async';
    });

    // Observe new images being added to the DOM
    const imageObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.tagName === 'IMG') {
            if (!node.loading) node.loading = 'lazy';
            if (!node.decoding) node.decoding = 'async';
          } else if (node.querySelectorAll) {
            node.querySelectorAll('img').forEach(img => {
              if (!img.loading) img.loading = 'lazy';
              if (!img.decoding) img.decoding = 'async';
            });
          }
        });
      });
    });

    imageObserver.observe(document.body, {
      childList: true,
      subtree: true
    });

    console.log('ðŸ–¼ï¸ Image lazy loading initialized');
  })();
  </script>

  <!-- View Switcher Buttons (Fixed Bottom Right) -->
  <div class="view-buttons">
    <a href="/">âœ¨ MADMusic</a>
  </div>

  <script>
  // ðŸŽµ Animated Record Player - Tonearm and spinning vinyl (Now Playing only)
  (function() {
    let currentAudio = null;

    // Listen for audio playback events
    document.addEventListener('DOMContentLoaded', () => {
      const nowPlayingThumb = document.querySelector('.now-playing-thumb');

      if (!nowPlayingThumb) {
        console.warn('âš ï¸ Now playing thumb not found');
        return;
      }

      // Monitor all audio elements
      const checkAudioPlayback = () => {
        const allAudio = document.querySelectorAll('audio');

        allAudio.forEach(audio => {
          if (!audio.dataset.recordPlayerListenerAdded) {
            audio.dataset.recordPlayerListenerAdded = 'true';

            const toggleJukeboxGlow = (isPlaying) => {
              }
            };

            // When audio starts playing
            audio.addEventListener('play', () => {
              currentAudio = audio;
              const thumb = document.querySelector('.now-playing-thumb');
              const video = document.getElementById('nowPlayingVideo');

              console.log('[VIDEO] Audio playing, thumb:', thumb, 'video:', video);

              if (thumb) {
                thumb.classList.add('playing');
                console.log('[VIDEO] Added playing class to thumb');
              }
              if (video) {
                console.log('[VIDEO] Starting video playback');
                video.play().catch(err => console.log('[VIDEO] Video autoplay prevented:', err));
              } else {
                console.warn('[VIDEO] Video element not found!');
              }
              toggleJukeboxGlow(true);
            });

            // Track playback progress
            audio.addEventListener('timeupdate', () => {
              const progressFill = document.getElementById('nowPlayingProgressFill');

              if (audio.duration && !audio.paused) {
                const progress = audio.currentTime / audio.duration;

                // Update progress bar
                if (progressFill) {
                  progressFill.style.width = `${progress * 100}%`;
                }
              }
            });

            // When audio pauses
            audio.addEventListener('pause', () => {
              const thumb = document.querySelector('.now-playing-thumb');
              const video = document.getElementById('nowPlayingVideo');

              if (thumb) {
                thumb.classList.remove('playing');
              }
              if (video) {
                video.pause();
              }
              toggleJukeboxGlow(false);
            });

            // When audio ends
            audio.addEventListener('ended', () => {
              const thumb = document.querySelector('.now-playing-thumb');
              const video = document.getElementById('nowPlayingVideo');
              const progressFill = document.getElementById('nowPlayingProgressFill');

              if (thumb) {
                thumb.classList.remove('playing');
              }
              if (video) {
                video.pause();
                video.currentTime = 0;
              }

              // Reset progress bar
              if (progressFill) {
                progressFill.style.width = '0%';
              }

              toggleJukeboxGlow(false);
            });
          }
        });
      };

      // Initial check
      checkAudioPlayback();

      // Monitor for new audio elements being added
      const audioObserver = new MutationObserver(() => {
        checkAudioPlayback();
      });

      audioObserver.observe(document.body, {
        childList: true,
        subtree: true
      });

      console.log('ðŸŽµ Record player animations initialized (Now Playing only)');
    });
  })();
  </script>

</body>
</html>
